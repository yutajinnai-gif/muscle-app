<!DOCTYPE html>


<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>筋トレメモ | BUILD_TAG=FULL-20250928</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <meta name="color-scheme" content="light">
  <style>
    input, select, textarea, button { font-size: 16px; }
    main { padding-bottom: 160px; }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }
    .modal-card { max-width: 560px; }
    .accent { color: #0f172a; }
  </style>
</head>
<body class="bg-white text-black">
  <div id="errbar" class="hidden fixed top-0 left-0 right-0 z-50 bg-red-600 text-white text-sm px-4 py-2"></div>


  <header class="sticky top-0 z-40 bg-white/85 backdrop-blur border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold accent">筋トレメモ</h1>
      <span id="build" class="text-xs text-slate-500">FULL</span>
    </div>
  </header>


  <main class="max-w-3xl mx-auto px-4 py-4" id="view"></main>


  <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white/90 backdrop-blur border-t border-slate-200">
    <div class="max-w-3xl mx-auto grid grid-cols-3">
      <button data-tab="home" class="tab px-4 py-3 text-sm font-medium">ホーム</button>
      <button data-tab="history" class="tab px-4 py-3 text-sm font-medium">履歴</button>
      <button data-tab="settings" class="tab px-4 py-3 text-sm font-medium">設定</button>
    </div>
  </nav>


  <div id="actionbar" class="fixed left-0 right-0 bottom-16 z-50">
    <div class="max-w-3xl mx-auto px-4">
      <div class="flex gap-3">
        <button id="fab-add" class="w-full py-4 rounded-xl bg-blue-600 text-white text-lg font-semibold shadow-lg">追加</button>
        <button id="fab-dup" class="py-4 px-5 rounded-xl bg-emerald-600 text-white text-lg font-semibold shadow-lg">＋1</button>
      </div>
    </div>
  </div>


  <div id="modal" class="hidden"></div>


  <script>
  // ====== 定数/ユーティリティ ======
  const NS = "muscle-app";
  const KEYS = {
    LOGS: `${NS}:workout-logs`,
    SETTINGS: `${NS}:settings`,
    SCHEMA: `${NS}:schema-version`,
    RECENTS: `${NS}:recent-exercises`,
    LAST_BY_EX: `${NS}:last-by-exercise`,
  };
  const SCHEMA_VERSION = 2;

  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function showError(msg){ const bar=$("#errbar"); bar.textContent=msg; bar.classList.remove("hidden"); }
  function hideError(){ $("#errbar").classList.add("hidden"); }

  window.onerror = (message)=>{ showError(String(message||"不明なエラー")); return false; };
  window.onunhandledrejection = (e)=>{ showError(String(e.reason||e)); };

  const toHalf = s => String(s ?? "").replace(/[！-～]/g, c => String.fromCharCode(c.charCodeAt(0)-0xFEE0));
  const safeParse = (j, fb)=>{ try { return JSON.parse(j); } catch { return fb; } };
  const load = (k, fb)=>{ const r=localStorage.getItem(k); return r==null?fb:safeParse(r,fb); };
  const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
  const uid = () => (typeof crypto !== "undefined" && crypto.randomUUID)
    ? crypto.randomUUID()
    : ("id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8));

  const PARTS_DEFAULT = {
    "胸":   ["ベンチプレス","インクラインベンチプレス","ダンベルプレス","ダンベルフライ","ケーブルクロス"],
    "背中": ["ラットプルダウン","シーテッドロウ","デッドリフト","ルーマニアンデッドリフト","ワンハンドロウ"],
    "脚":   ["スクワット","フロントスクワット","レッグプレス","レッグエクステンション","レッグカール"],
    "肩":   ["ショルダープレス","サイドレイズ","リアレイズ","フロントレイズ","アップライトロウ"],
    "腕":   ["アームカール","プリーチャーカール","プレスダウン","フレンチプレス","ハンマーカール"]
  };
  const DEFAULT_INSTRUMENTS = ["バーベル","ダンベル","マシン","ケーブル","自重"];
  const DEFAULT_ATTACHMENTS = ["マグ（ワイド）","マグ（ナロー）","マグ（ミドル）","ロープ","ストレートバー","Dハンドル"];
  const DEFAULT_ANGLES = ["フラット","インクライン","デクライン","ニュートラル"];
  const INCREMENTS = { kg: 2.5, lb: 5, reps: 1 };

  (function bootstrap(){
    const v = load(KEYS.SCHEMA, null);
    if (v !== SCHEMA_VERSION) {
      const prevSettings = load(KEYS.SETTINGS, null);
      let logs = load(KEYS.LOGS, []);
      logs = logs.map(x=>({
        id: x.id || uid(),
        date: x.date || new Date().toISOString().slice(0,10),
        part: x.part || guessPart(x.exercise),
        exercise: x.exercise || "",
        instrument: x.instrument || "",
        attachment: x.attachment || "",
        angle: x.angle || "",
        weight: Number(x.weight ?? 0),
        unit: x.unit || (prevSettings?.unit || "kg"),
        repsSelf: Number(x.repsSelf ?? x.reps ?? 0),
        repsAssist: Number(x.repsAssist ?? 0),
        note: x.note || ""
      }));
      save(KEYS.LOGS, logs);
      const initSettings = {
        unit: prevSettings?.unit || "kg",
        theme: "light",
        parts: prevSettings?.parts || PARTS_DEFAULT,
        instruments: prevSettings?.instruments || DEFAULT_INSTRUMENTS,
        attachments: prevSettings?.attachments || DEFAULT_ATTACHMENTS,
        angles: prevSettings?.angles || DEFAULT_ANGLES,
        defaultPart: prevSettings?.defaultPart || Object.keys(PARTS_DEFAULT)[0],
        defaultDateMode: prevSettings?.defaultDateMode || "today",
        autofillEnabled: prevSettings?.autofillEnabled ?? true,
      };
      save(KEYS.SETTINGS, initSettings);
      save(KEYS.SCHEMA, SCHEMA_VERSION);
    } else {
      const s = getSettings();
      if (s.parts == null) s.parts = PARTS_DEFAULT;
      if (s.instruments == null) s.instruments = DEFAULT_INSTRUMENTS;
      if (s.attachments == null) s.attachments = DEFAULT_ATTACHMENTS;
      if (s.angles == null) s.angles = DEFAULT_ANGLES;
      if (s.defaultPart == null) s.defaultPart = Object.keys(s.parts)[0];
      if (s.defaultDateMode == null) s.defaultDateMode = "today";
      if (s.autofillEnabled === undefined) s.autofillEnabled = true;
      save(KEYS.SETTINGS, s);
    }
  })();

  function getSettings(){
    return load(KEYS.SETTINGS, {
      unit: "kg", theme:"light",
      parts: PARTS_DEFAULT,
      instruments: DEFAULT_INSTRUMENTS,
      attachments: DEFAULT_ATTACHMENTS,
      angles: DEFAULT_ANGLES,
      defaultPart: Object.keys(PARTS_DEFAULT)[0],
      defaultDateMode: "today",
      autofillEnabled: true
    });
  }
  function setSettings(s){ save(KEYS.SETTINGS, s); }

  function getRecents(){ return load(KEYS.RECENTS, []); }
  function pushRecent(name){ const n=(name||"").trim(); if(!n) return; let r=getRecents().filter(x=>x!==n); r.unshift(n); if(r.length>10) r=r.slice(0,10); save(KEYS.RECENTS,r); }
  function getLastByEx(){ return load(KEYS.LAST_BY_EX, {}); }
  function rememberLast(ex, p){ const m=getLastByEx(); m[ex]={...m[ex],...p}; save(KEYS.LAST_BY_EX, m); }

  function getLogs(){ return load(KEYS.LOGS, []); }
  function setLogs(a){ save(KEYS.LOGS, a); }
  function addLog(entry){ const arr=getLogs(); arr.unshift({id:uid(), ...entry}); setLogs(arr); }
  function updateLog(id, patch){ setLogs(getLogs().map(x=>x.id===id?{...x,...patch}:x)); }
  function removeLog(id){ setLogs(getLogs().filter(x=>x.id!==id)); }

  const routes = ["home","history","settings"];
  function currentRoute(){ const h=location.hash.replace(/^#\/?/,""); return routes.includes(h)?h:"home"; }
  function navigate(to){ if(!routes.includes(to)) to="home"; if(currentRoute()!==to) location.hash=`#/${to}`; render(); }
  window.addEventListener("hashchange", ()=>{ render(); highlightTab(); });

  function getParts(){ return getSettings().parts; }
  function partOrder(){ return Object.keys(getParts()); }
  function exercisesOf(part){ return getParts()[part] || []; }
  function guessPart(ex){ const p=getParts(); for(const k of Object.keys(p)){ if(p[k].includes(ex)) return k; } return partOrder()[0]||"胸"; }

  // ====== Home ======
  function viewHome(){
    const s = getSettings();
    const today = new Date().toISOString().slice(0,10);
    const initialDate = s.defaultDateMode==="last" && getLogs()[0]?.date ? getLogs()[0].date : today;
    const selectedPart = s.defaultPart || partOrder()[0];
    const exList = exercisesOf(selectedPart);

    const partOptions = partOrder().map(p=>`<option value="${p}" ${p===selectedPart?'selected':''}>${p}</option>`).join("");
    const exOptions = ['<option value="" disabled selected>選択してください</option>', ...exList.map(n=>`<option value="${n}">${n}</option>`)].join("");
    const instOptions = s.instruments.map(n => `<option value="${n}">${n}</option>`).join("");
    const attOptions  = s.attachments.map(n => `<option value="${n}">${n}</option>`).join("");
    const angOptions  = s.angles.map(n => `<option value="${n}">${n}</option>`).join("");

    return `
      <section class="space-y-4">
        <h2 class="text-base font-semibold accent">記録を追加</h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="text-sm">
            <span class="block mb-1 text-slate-600">部位</span>
            <select id="f-part" class="w-full border rounded-lg px-3 py-2">${partOptions}</select>
          </label>
          <label class="text-sm">
            <span class="block mb-1 text-slate-600">日付</span>
            <input id="f-date" type="date" value="${initialDate}" class="w-full border rounded-lg px-3 py-2">
          </label>

          <label class="col-span-2 text-sm">
            <span class="block mb-1 text-slate-600">種目</span>
            <select id="f-ex" class="w-full border rounded-lg px-3 py-2">${exOptions}</select>
          </label>

          <label class="text-sm">
            <span class="block mb-1 text-slate-600">器具</span>
            <select id="f-inst" class="w-full border rounded-lg px-3 py-2">
              <option value="">指定なし</option>${instOptions}
            </select>
          </label>
          <label class="text-sm">
            <span class="block mb-1 text-slate-600">アタッチメント</span>
            <select id="f-att" class="w-full border rounded-lg px-3 py-2">
              <option value="">指定なし</option>${attOptions}
            </select>
          </label>

          <label class="text-sm">
            <span class="block mb-1 text-slate-600">角度</span>
            <select id="f-ang" class="w-full border rounded-lg px-3 py-2">
              <option value="">指定なし</option>${angOptions}
            </select>
          </label>
          <label class="text-sm">
            <span class="block mb-1 text-slate-600">セット数</span>
            <input id="f-sets" type="number" inputmode="numeric" step="1" min="1" placeholder="1" class="w-full border rounded-lg px-3 py-2">
          </label>

          <label class="text-sm">
            <span class="block mb-1 text-slate-600">重量 (${s.unit})</span>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 border rounded" data-dec="weight">−</button>
              <input id="f-weight" type="number" inputmode="decimal" step="any" placeholder="${s.unit}" class="w-full border rounded-lg px-3 py-2">
              <button type="button" class="px-2 py-1 border rounded" data-inc="weight">＋</button>
            </div>
          </label>

          <label class="text-sm">
            <span class="block mb-1 text-slate-600">レップ（自力）</span>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 border rounded" data-dec="repsSelf">−</button>
              <input id="f-reps-self" type="number" inputmode="numeric" step="1" placeholder="10" class="w-full border rounded-lg px-3 py-2">
              <button type="button" class="px-2 py-1 border rounded" data-inc="repsSelf">＋</button>
            </div>
          </label>

          <label class="text-sm">
            <span class="block mb-1 text-slate-600">レップ（補助）</span>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 border rounded" data-dec="repsAssist">−</button>
              <input id="f-reps-assist" type="number" inputmode="numeric" step="1" placeholder="0" class="w-full border rounded-lg px-3 py-2">
              <button type="button" class="px-2 py-1 border rounded" data-inc="repsAssist">＋</button>
            </div>
          </label>

          <label class="col-span-2 text-sm">
            <span class="block mb-1 text-slate-600">メモ（任意）</span>
            <input id="f-note" type="text" placeholder="フォーム/感覚など" class="w-full border rounded-lg px-3 py-2">
          </label>
        </div>

        <hr class="my-4">
        <h3 class="text-sm font-semibold text-slate-700">直近の記録</h3>
        <div id="recent" class="divide-y"></div>
      </section>
    `;
  }

  function renderRecent(){
    const wrap=$("#recent"); if(!wrap) return;
    const rows = getLogs().slice(0,5).map(rowToItem).join("") || `<p class="text-sm text-slate-500 py-3">まだ記録がありません。</p>`;
    wrap.innerHTML = rows; bindItemButtons(wrap);
  }

  function rowToItem(x){
    const sub = [x.instrument, x.attachment, x.angle].filter(Boolean).join(" / ");
    const subTxt = sub ? ` — <span class="text-slate-500">${sub}</span>` : "";
    return `
      <div class="py-3 grid grid-cols-[1fr_auto] gap-3 items-start" data-row="${x.id}">
        <div class="min-w-0">
          <div class="font-medium">${escapeHtml(x.part)}・${escapeHtml(x.exercise)}${subTxt}</div>
          <div class="text-xs text-slate-500">${x.date}</div>
          <div class="text-sm"><span class="font-semibold">${x.weight}${x.unit}</span> / 自力${x.repsSelf}・補助${x.repsAssist}</div>
          ${x.note ? `<div class="text-sm break-words">${escapeHtml(x.note)}</div>` : ""}
        </div>
        <div class="shrink-0 flex gap-2">
          <button data-edit="${x.id}" class="text-xs text-blue-600 hover:underline">編集</button>
          <button data-del="${x.id}" class="text-xs text-red-600 hover:underline">削除</button>
        </div>
      </div>
    `;
  }

  // ====== History ======
  function viewHistory(){
    const today = new Date().toISOString().slice(0,10);
    const date30 = new Date(Date.now()-29*864e5).toISOString().slice(0,10);

    const partOpts = ['<option value="">全て</option>', ...partOrder().map(p=>`<option value="${p}">${p}</option>`)].join("");
    const exAll = Array.from(new Set(getLogs().map(l=>l.exercise).filter(Boolean)));
    const exOpts = ['<option value="">全て</option>', ...exAll.map(e=>`<option value="${e}">${e}</option>`)].join("");

    return `
      <section class="space-y-4">
        <h2 class="text-base font-semibold accent">履歴</h2>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 items-end">
          <label class="text-sm">
            <span class="block mb-1">期間</span>
            <select id="flt-range" class="w-full border rounded-lg px-3 py-2">
              <option value="7">直近7日</option>
              <option value="30">直近30日</option>
              <option value="custom">カスタム</option>
              <option value="all" selected>全期間</option>
            </select>
          </label>
          <label class="text-sm">
            <span class="block mb-1">開始</span>
            <input id="flt-from" type="date" value="${date30}" class="w-full border rounded-lg px-3 py-2">
          </label>
          <label class="text-sm">
            <span class="block mb-1">終了</span>
            <input id="flt-to" type="date" value="${today}" class="w-full border rounded-lg px-3 py-2">
          </label>
          <label class="text-sm">
            <span class="block mb-1">部位</span>
            <select id="flt-part" class="w-full border rounded-lg px-3 py-2">${partOpts}</select>
          </label>
          <label class="text-sm">
            <span class="block mb-1">種目</span>
            <select id="flt-ex" class="w-full border rounded-lg px-3 py-2">${exOpts}</select>
          </label>
        </div>

        <div><canvas id="history-chart" height="110"></canvas></div>
        <div id="history-list" class="mt-2"></div>
      </section>
    `;
  }

  function renderHistory(){
    const elR = $("#flt-range"); const r = elR ? elR.value : "all";
    const elF = $("#flt-from");  const from = elF ? elF.value : "1900-01-01";
    const elT = $("#flt-to");    const to   = elT ? elT.value : "2999-12-31";
    const elP = $("#flt-part");  const part = elP ? elP.value : "";
    const elE = $("#flt-ex");    const ex   = elE ? elE.value : "";

    let logs=getLogs().filter(l=>l.date>=from && l.date<=to);
    if(r==="7")  logs=logs.filter(l=>daysDiff(l.date)<=6);
    if(r==="30") logs=logs.filter(l=>daysDiff(l.date)<=29);
    if(part) logs=logs.filter(l=>l.part===part);
    if(ex)   logs=logs.filter(l=>l.exercise===ex);

    const byEx = groupBy(logs, l=>l.exercise||"(未設定)");
    const container=$("#history-list");
    const blocks = Object.keys(byEx).sort().map(exName=>{
      const list=byEx[exName].slice().sort((a,b)=> (a.date===b.date? a.id.localeCompare(b.id) : b.date.localeCompare(a.date)));
      const byDate=groupBy(list, l=>l.date);
      const rows = Object.keys(byDate).sort((a,b)=>b.localeCompare(a)).map(d=>{
        const items = byDate[d].map(rowToItem).join("");
        return `<div class="py-2"><h4 class="text-sm font-semibold text-slate-700">${d}</h4><div class="divide-y">${items}</div></div>`;
      }).join("");
      return `<section class="mb-6"><h3 class="text-base font-semibold accent">${escapeHtml(exName)}</h3>${rows || `<p class="text-sm text-slate-500">記録なし</p>`}</section>`;
    }).join("");

    container.innerHTML = blocks || `<p class="text-sm text-slate-500">条件に一致する記録がありません。</p>`;
    drawChart(logs);
    bindItemButtons(container);
  }

  function drawChart(logs){
    const ctx=$("#history-chart"); if(!ctx) return;
    const byDay={};
    logs.forEach(l=>{
      const vol = Number(l.weight||0) * (Number(l.repsSelf||0)+Number(l.repsAssist||0));
      byDay[l.date] = (byDay[l.date]||0) + vol;
    });
    const labels=Object.keys(byDay).sort();
    const data=labels.map(d=>byDay[d]);
    if(ctx._chart) ctx._chart.destroy();
    ctx._chart = new Chart(ctx,{
      type:"line",
      data:{ labels, datasets:[{ label:"総挙上量", data, tension:.3 }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ x:{ ticks:{ maxRotation:0 } } } }
    });
  }

  function groupBy(arr, fn){ return arr.reduce((m,x)=>{ const k=fn(x); (m[k]||(m[k]=[])).push(x); return m; },{}); }
  function daysDiff(d){ return Math.floor((Date.now()-new Date(d).getTime())/864e5); }

  // ====== Settings ======
  function viewSettings(){
    const s=getSettings();
    const jsonParts = JSON.stringify(s.parts,null,2);
    const jsonLists = JSON.stringify({instruments:s.instruments, attachments:s.attachments, angles:s.angles}, null, 2);
    const partOptions = partOrder().map(p=>`<option value="${p}" ${p===s.defaultPart?'selected':''}>${p}</option>`).join("");
    return `
      <section class="space-y-4">
        <h2 class="text-base font-semibold accent">設定</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <h3 class="text-sm font-semibold text-slate-700">基本</h3>
            <label class="text-sm block">
              <span class="block mb-1">単位</span>
              <select id="set-unit" class="border rounded-lg px-3 py-2">
                <option value="kg" ${s.unit==="kg"?"selected":""}>kg</option>
                <option value="lb" ${s.unit==="lb"?"selected":""}>lb</option>
              </select>
            </label>
            <label class="text-sm block">
              <span class="block mb-1">初期部位</span>
              <select id="set-default-part" class="border rounded-lg px-3 py-2">${partOptions}</select>
            </label>
            <label class="text-sm block">
              <span class="block mb-1">初期日付</span>
              <select id="set-default-date" class="border rounded-lg px-3 py-2">
                <option value="today" ${s.defaultDateMode==="today"?'selected':''}>今日</option>
                <option value="last"  ${s.defaultDateMode==="last"?'selected':''}>前回</option>
              </select>
            </label>
            <label class="text-sm flex items-center gap-2">
              <input id="set-autofill" type="checkbox" ${s.autofillEnabled?"checked":""} class="w-4 h-4">
              <span>直近値のオートフィルを有効にする</span>
            </label>
            <div class="flex gap-3">
              <button id="btn-save-settings" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm">保存</button>
              <button id="btn-clear-all" class="px-4 py-2 rounded-lg border border-red-300 text-sm text-red-700">全データ削除</button>
            </div>
          </div>

          <div class="space-y-3">
            <h3 class="text-sm font-semibold text-slate-700">リスト編集（JSON）</h3>
            <label class="text-sm block">
              <span class="block mb-1">部位→種目</span>
              <textarea id="set-parts-json" class="w-full border rounded-lg px-3 py-2 font-mono text-xs h-40">${jsonParts}</textarea>


        </label>
        <label class="text-sm block">
          <span class="block mb-1">器具/アタッチメント/角度</span>
          <textarea id="set-lists-json" class="w-full border rounded-lg px-3 py-2 font-mono text-xs h-40">${jsonLists}</textarea>
        </label>
        <div class="flex gap-3">
          <button id="btn-apply-lists" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">リスト反映</button>
          <button id="btn-export-json" class="px-3 py-2 rounded border text-sm">JSON書き出し</button>
          <button id="btn-export-csv" class="px-3 py-2 rounded border text-sm">CSV書き出し</button>
          <label class="px-3 py-2 rounded border text-sm cursor-pointer">
            JSON読み込み<input id="imp-json" type="file" accept="application/json" class="hidden">
          </label>
        </div>
      </div>
    </div>
  </section>
`;

}

// ====== Home挙動 ======
function bindHome(){
const s=getSettings();

$$("button[data-inc]").forEach(b=>{
  b.addEventListener("click", ()=>{
    const k=b.getAttribute("data-inc");
    if(k==="weight"){
      const step=INCREMENTS[s.unit]||1;
      const cur=Number($("#f-weight").value||0);
      $("#f-weight").value=(s.unit==="kg")?Number((cur+step).toFixed(1)):Math.round(cur+step);
    }else if(k==="repsSelf"){
      const cur=Number($("#f-reps-self").value||0); $("#f-reps-self").value=Math.max(0,cur+1);
    }else if(k==="repsAssist"){
      const cur=Number($("#f-reps-assist").value||0); $("#f-reps-assist").value=Math.max(0,cur+1);
    }
  });
});
$$("button[data-dec]").forEach(b=>{
  b.addEventListener("click", ()=>{
    const k=b.getAttribute("data-dec");
    if(k==="weight"){
      const step=INCREMENTS[s.unit]||1;
      const cur=Number($("#f-weight").value||0);
      $("#f-weight").value=Math.max(0,(s.unit==="kg")?Number((cur-step).toFixed(1)):Math.round(cur-step));
    }else if(k==="repsSelf"){
      const cur=Number($("#f-reps-self").value||0); $("#f-reps-self").value=Math.max(0,cur-1);
    }else if(k==="repsAssist"){
      const cur=Number($("#f-reps-assist").value||0); $("#f-reps-assist").value=Math.max(0,cur-1);
    }
  });
});

$("#f-part").addEventListener("change", ()=>{ updateExerciseOptionsByPart(); });

$("#f-ex").addEventListener("change", ()=>{
  if (!getSettings().autofillEnabled) return;
  const ex=$("#f-ex").value||"";
  const last=getLastByEx()[ex]; if(!last) return;
  if($("#f-weight").value==="" || Number($("#f-weight").value)===0) $("#f-weight").value=last.weight ?? "";
  if($("#f-reps-self").value==="" || Number($("#f-reps-self").value)===0) $("#f-reps-self").value=last.repsSelf ?? "";
  if($("#f-reps-assist").value==="" || Number($("#f-reps-assist").value)===0) $("#f-reps-assist").value=last.repsAssist ?? "";
});

$("#fab-add").addEventListener("click", onAdd);
$("#btn-add")?.addEventListener("click", onAdd);

$("#fab-dup").addEventListener("click", onAddDuplicate);
$("#btn-add-dup")?.addEventListener("click", onAddDuplicate);

}

function onAdd(){
hideError();
const s=getSettings();
const date=$("#f-date").value || new Date().toISOString().slice(0,10);
const part=$("#f-part").value;
const exercise=$("#f-ex").value || "";
const instrument=$("#f-inst").value || "";
const attachment=$("#f-att").value || "";
const angle=$("#f-ang").value || "";
const sets=Number($("#f-sets").value || 1);
const weight=Number(toHalf($("#f-weight").value)||0);
const repsSelf=Number(toHalf($("#f-reps-self").value)||0);
const repsAssist=Number(toHalf($("#f-reps-assist").value)||0);
const note=$("#f-note").value || "";

if(!part){ showError("部位を選択してください。"); return; }
if(!exercise){ showError("種目を選択してください。"); return; }
if(!(weight>=0)){ showError("重量は数値で入力してください。"); return; }
if(!(repsSelf>=0 && repsAssist>=0)){ showError("レップは0以上の数値で入力してください。"); return; }

const entry={ date, part, exercise, instrument, attachment, angle, weight, unit:s.unit, repsSelf, repsAssist, note };
for(let i=0;i<Math.max(1,sets);i++) addLog(entry);

pushRecent(exercise);
rememberLast(exercise,{ weight, repsSelf, repsAssist, unit:s.unit });

onClearInputs(); renderRecent();

}

function onAddDuplicate(){
hideError();
const s=getSettings();
const date=$("#f-date").value || new Date().toISOString().slice(0,10);
const part=$("#f-part").value;
const exercise=$("#f-ex").value || "";
if(!exercise || !part){ showError("部位と種目を選択してください。"); return; }

let weight=Number(toHalf($("#f-weight").value)||0);
let repsSelf=Number(toHalf($("#f-reps-self").value)||0);
let repsAssist=Number(toHalf($("#f-reps-assist").value)||0);
const instrument=$("#f-inst").value || "";
const attachment=$("#f-att").value || "";
const angle=$("#f-ang").value || "";
const note=$("#f-note").value || "";

const last=getLastByEx()[exercise];
if(!(weight>=0)) weight=last?.weight ?? 0;
if(!(repsSelf>=0)) repsSelf=last?.repsSelf ?? 0;
if(!(repsAssist>=0)) repsAssist=last?.repsAssist ?? 0;

addLog({ date, part, exercise, instrument, attachment, angle, weight, unit:s.unit, repsSelf, repsAssist, note });
pushRecent(exercise);
rememberLast(exercise,{ weight, repsSelf, repsAssist, unit:s.unit });
renderRecent();

}

function onClearInputs(){
["#f-weight","#f-reps-self","#f-reps-assist","#f-sets","#f-note"].forEach(sel=>{ const el=$(sel); if(el) el.value=""; });
}

// ====== 履歴 編集/削除 ======
function bindItemButtons(scope=document){
$$('button[data-del]', scope).forEach(btn=>{
btn.addEventListener("click", ()=>{
const id=btn.getAttribute("data-del");
if(!confirm("この記録を削除しますか？")) return;
removeLog(id); render();
});
});
$$('button[data-edit]', scope).forEach(btn=>{
btn.addEventListener("click", ()=>{
const id=btn.getAttribute("data-edit");
openEditModal(id);
});
});
}

function openEditModal(id){
const x=getLogs().find(l=>l.id===id); if(!x) return;
const s=getSettings();
const instOptions = ["", ...s.instruments]
  .map(n => `<option value="${n}" ${x.instrument===n?"selected":""}>${n||"指定なし"}</option>`).join("");
const attOptions = ["", ...s.attachments]
  .map(n => `<option value="${n}" ${x.attachment===n?"selected":""}>${n||"指定なし"}</option>`).join("");
const angOptions = ["", ...s.angles]
  .map(n => `<option value="${n}" ${x.angle===n?"selected":""}>${n||"指定なし"}</option>`).join("");

const m=$("#modal");
m.innerHTML = `
  <div class="modal-bg flex items-center justify-center">
    <div class="modal-card bg-white rounded-xl shadow-xl w-[92%] p-4">
      <h3 class="text-base font-semibold accent mb-3">編集</h3>
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm"><span class="block mb-1">日付</span>
          <input id="ed-date" type="date" value="${x.date}" class="w-full border rounded-lg px-3 py-2">
        </label>
        <label class="text-sm"><span class="block mb-1">部位</span>
          <select id="ed-part" class="w-full border rounded-lg px-3 py-2">
            ${partOrder().map(p=>`<option ${x.part===p?"selected":""}>${p}</option>`).join("")}
          </select>
        </label>
        <label class="col-span-2 text-sm"><span class="block mb-1">種目</span>
          <input id="ed-ex" type="text" value="${escapeHtml(x.exercise)}" class="w-full border rounded-lg px-3 py-2">
        </label>
        <label class="text-sm"><span class="block mb-1">器具</span>
          <select id="ed-inst" class="w-full border rounded-lg px-3 py-2">${instOptions}</select>
        </label>
        <label class="text-sm"><span class="block mb-1">アタッチメント</span>
          <select id="ed-att" class="w-full border rounded-lg px-3 py-2">${attOptions}</select>
        </label>
        <label class="text-sm"><span class="block mb-1">角度</span>
          <select id="ed-ang" class="w-full border rounded-lg px-3 py-2">${angOptions}</select>
        </label>
        <label class="text-sm"><span class="block mb-1">重量 (${x.unit})</span>
          <input id="ed-weight" type="number" inputmode="decimal" step="any" value="${x.weight}" class="w-full border rounded-lg px-3 py-2">
        </label>
        <label class="text-sm"><span class="block mb-1">自力レップ</span>
          <input id="ed-rs" type="number" inputmode="numeric" step="1" value="${x.repsSelf}" class="w-full border rounded-lg px-3 py-2">
        </label>
        <label class="text-sm"><span class="block mb-1">補助レップ</span>
          <input id="ed-ra" type="number" inputmode="numeric" step="1" value="${x.repsAssist}" class="w-full border rounded-lg px-3 py-2">
        </label>
        <label class="col-span-2 text-sm"><span class="block mb-1">メモ</span>
          <input id="ed-note" type="text" value="${escapeHtml(x.note)}" class="w-full border rounded-lg px-3 py-2">
        </label>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="ed-cancel" class="px-3 py-2 rounded border">キャンセル</button>
        <button id="ed-save" class="px-3 py-2 rounded bg-blue-600 text-white">保存</button>
      </div>
    </div>
  </div>
`;
m.classList.remove("hidden");
$("#ed-cancel").onclick = ()=>{ m.classList.add("hidden"); m.innerHTML=""; };
$("#ed-save").onclick = ()=>{
  const patch = {
    date: $("#ed-date").value,
    part: $("#ed-part").value,
    exercise: $("#ed-ex").value.trim(),
    instrument: $("#ed-inst").value,
    attachment: $("#ed-att").value,
    angle: $("#ed-ang").value,
    weight: Number($("#ed-weight").value||0),
    repsSelf: Number($("#ed-rs").value||0),
    repsAssist: Number($("#ed-ra").value||0),
    note: $("#ed-note").value
  };
  if (!patch.exercise){ showError("種目は必須です"); return; }
  updateLog(id, patch);
  m.classList.add("hidden"); m.innerHTML="";
  render();
};

}

// ====== Settings挙動/Export/Import ======
function bindSettings(){
$("#btn-save-settings").addEventListener("click", ()=>{
const s=getSettings();
s.unit=$("#set-unit").value;
s.defaultPart=$("#set-default-part").value;
s.defaultDateMode=$("#set-default-date").value;
s.autofillEnabled=$("#set-autofill").checked;
setSettings(s);
alert("保存しました。");
});

$("#btn-clear-all").addEventListener("click", ()=>{
  if(!confirm("すべての記録を削除します。よろしいですか？")) return;
  save(KEYS.LOGS, []); render();
});

$("#btn-apply-lists").addEventListener("click", ()=>{
  try{
    const parts=JSON.parse($("#set-parts-json").value);
    const lists=JSON.parse($("#set-lists-json").value);
    const s=getSettings();
    s.parts=parts;
    s.instruments=lists.instruments || DEFAULT_INSTRUMENTS;
    s.attachments=lists.attachments || DEFAULT_ATTACHMENTS;
    s.angles=lists.angles || DEFAULT_ANGLES;
    if(!s.parts[s.defaultPart]) s.defaultPart=Object.keys(s.parts)[0];
    setSettings(s);
    alert("リストを反映しました。");
  }catch(e){ showError("JSONの形式が不正です: "+e.message); }
});

$("#btn-export-json").addEventListener("click", ()=>{
  const blob=new Blob([JSON.stringify(getLogs(),null,2)],{type:"application/json"});
  triggerDownload(URL.createObjectURL(blob), `muscle-logs-${new Date().toISOString().slice(0,10)}.json`);
});

$("#btn-export-csv").addEventListener("click", ()=>{
  const csv=logsToCSV(getLogs());
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  triggerDownload(URL.createObjectURL(blob), `muscle-logs-${new Date().toISOString().slice(0,10)}.csv`);
});

$("#imp-json").addEventListener("change",(ev)=>{
  const f=ev.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const arr=JSON.parse(String(reader.result||"[]"));
      if(!Array.isArray(arr)) throw new Error("配列ではありません");
      const s=getSettings();
      const norm=arr.map(x=>({
        id:x.id||uid(),
        date:x.date||new Date().toISOString().slice(0,10),
        part:x.part||guessPart(x.exercise),
        exercise:String(x.exercise||""),
        instrument:x.instrument||"",
        attachment:x.attachment||"",
        angle:x.angle||"",
        weight:Number(x.weight||0),
        unit:x.unit||s.unit,
        repsSelf:Number(x.repsSelf ?? x.reps ?? 0),
        repsAssist:Number(x.repsAssist ?? 0),
        note:String(x.note||"")
      }));
      save(KEYS.LOGS,norm); render();
      alert("読み込みました。");
    }catch(e){ showError("JSON読み込みエラー: "+e.message); }
    ev.target.value="";
  };
  reader.readAsText(f);
});

}

function logsToCSV(logs){
  const header = ["id","date","part","exercise","instrument","attachment","angle","weight","unit","repsSelf","repsAssist","note"];
  const rows = logs.map(l => header.map(h => String((l[h] === null || l[h] === undefined) ? "" : l[h])));
  return [header, ...rows].map(r => r.map(csvCell).join(",")).join("\n");
}
function csvCell(s){
  s = String(s);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function triggerDownload(url, name){ const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1000); }

// ====== 部位→種目 select 更新 ======
function updateExerciseOptionsByPart(){
const sel=$("#f-ex"); if(!sel) return;
const wasFocused=(document.activeElement===sel);
if(wasFocused) sel.blur();

var elPart = $("#f-part");
const part = elPart ? elPart.value : getSettings().defaultPart;
const list=exercisesOf(part);
const prev=sel.value || "";
const optionsHtml = `<option value="" disabled ${prev && list.includes(prev) ? "" : "selected"}>選択してください</option>`
  + list.map(n=>`<option value="${n}">${n}</option>`).join("");
sel.innerHTML=optionsHtml;
if(prev && list.includes(prev)) sel.value=prev;

}

// ====== タブ/描画 ======
function highlightTab(){
const route=currentRoute();
$$(".tab").forEach(b=>{
const active=b.getAttribute("data-tab")===route;
b.classList.toggle("text-blue-600", active);
b.classList.toggle("border-t-2", active);
b.classList.toggle("border-blue-600", active);
b.classList.toggle("bg-blue-50/50", active);
b.onclick = ()=> navigate(b.getAttribute("data-tab"));
});
}

function render(){
  hideError();
  let route, root;
  try {
    route = currentRoute();
    root  = $("#view");
    root.innerHTML = route==="home"    ? viewHome()
                 : route==="history" ? viewHistory()
                 :                     viewSettings();
  } catch(e){
    showError("描画エラー: " + (e?.message || e));
    return;
  }

  if (route === "home") {
    try {
      renderRecent();
      updateExerciseOptionsByPart();
      bindHome();
      setActionBarVisible(true);
    } catch(e) {
      showError("Home初期化エラー: " + (e?.message || e));
      return;
    }
  } else if (route === "history") {
    setActionBarVisible(false);
    renderHistory();
    var elRange = $("#flt-range");
    if (elRange) elRange.addEventListener("change", ()=>{
      const v=$("#flt-range").value;
      const today=new Date().toISOString().slice(0,10);
      const setFrom=d=>$("#flt-from").value=d;
      const setTo=d=>$("#flt-to").value=d;
      if(v==="7"){ setFrom(new Date(Date.now()-6*864e5).toISOString().slice(0,10)); setTo(today); }
      else if(v==="30"){ setFrom(new Date(Date.now()-29*864e5).toISOString().slice(0,10)); setTo(today); }
      renderHistory();
    });
    ["#flt-from","#flt-to","#flt-part","#flt-ex"].forEach(sel=>{
      var el = $(sel);
      if (el) el.addEventListener("change", renderHistory);
    });
  } else if (route === "settings") {
    setActionBarVisible(false);
    bindSettings();
  }

  highlightTab();
}

function setActionBarVisible(v){
const bar=$("#actionbar");
bar.classList.toggle("hidden", !v);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;"
  }[m]));
}

// ====== PWA ======
// 一時的に旧SWを解除（確認後に削除OK）
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations().then(rs => {
    rs.forEach(r => r.unregister());
    if (window.caches && caches.keys) {
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
  });
}
(function registerPWA(){
if(!("serviceWorker" in navigator)) return;
const manifest = {
name:"筋トレメモ", short_name:"筋トレ", start_url:"./index.html",
display:"standalone", background_color:"#ffffff", theme_color:"#0f172a", icons:[]
};
const manUrl = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:"application/json"}));
const link=document.createElement("link"); link.rel="manifest"; link.href=manUrl; document.head.appendChild(link);

const swCode = `
  const CACHE='muscle-app-v2'; // ← v2 にバンプ
  self.addEventListener('install', e => {
    e.waitUntil(caches.open(CACHE).then(c => c.addAll(['./'])));
    self.skipWaiting();
  });
  self.addEventListener('activate', e => {
    e.waitUntil(
      (async () => {
        const keys = await caches.keys();
        await Promise.all(keys
          .filter(k => k.startsWith('muscle-app-') && k !== CACHE)
          .map(k => caches.delete(k)));
        await self.clients.claim();
      })()
    );
  });
  self.addEventListener('fetch', e => {
    if (e.request.method !== 'GET') return;
    e.respondWith(
      caches.match(e.request).then(r => r || fetch(e.request).then(res => {
        const copy = res.clone();
        caches.open(CACHE).then(c => c.put(e.request, copy));
        return res;
      }).catch(() => r || new Response('', { status:200 })))
    );
  });
`;
const swUrl = URL.createObjectURL(new Blob([swCode],{type:"text/javascript"}));
navigator.serviceWorker.register(swUrl);

})();

render();


</body>
</html>
