<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筋トレ記録アプリ v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* iOSでの入力欄ズームを防止 */
        input, select, textarea {
            font-size: 16px;
        }
        /* スクロールバーのスタイル */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none !important; }
        /* アクティブなタブのスタイル */
        .tab-active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased">

    <div id="app-container" class="max-w-lg mx-auto bg-white min-h-screen pb-20">

        <main id="main-content" class="p-4">
            
            <div id="home-screen">
                <h1 class="text-2xl font-bold mb-4">ホーム</h1>
                <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-gray-200 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">直近7日間</div>
                        <div id="summary-7-days" class="text-2xl font-bold">0日</div>
                    </div>
                    <div class="bg-gray-200 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">直近30日間</div>
                        <div id="summary-30-days" class="text-2xl font-bold">0日</div>
                    </div>
                </div>
                <h2 class="text-xl font-semibold mb-3">部位を選択</h2>
                <div id="part-selection" class="grid grid-cols-2 gap-4">
                    </div>
            </div>
            
            <div id="record-screen" class="hidden">
                 <div class="flex items-center mb-4">
                    <button id="back-to-home-btn" class="mr-4 p-2 text-lg"><i class="fas fa-arrow-left"></i></button>
                    <h1 id="record-title" class="text-2xl font-bold"></h1>
                </div>
                <div id="blocks-container" class="space-y-6">
                    </div>
                <button id="add-block-btn" class="w-full mt-6 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>種目ブロックを追加
                </button>
                <button id="finish-workout-btn" class="w-full mt-4 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>トレーニングを完了
                </button>
            </div>

            <div id="history-screen" class="hidden">
                <h1 class="text-2xl font-bold mb-4">トレーニング履歴</h1>
                <div class="bg-gray-100 p-4 rounded-lg mb-4 space-y-3">
                    <h2 class="font-semibold">絞り込み</h2>
                    <div class="grid grid-cols-2 gap-3">
                         <input type="date" id="filter-start-date" class="p-2 border rounded-lg w-full">
                         <input type="date" id="filter-end-date" class="p-2 border rounded-lg w-full">
                         <select id="filter-part" class="p-2 border rounded-lg w-full"></select>
                         <select id="filter-exercise" class="p-2 border rounded-lg w-full"></select>
                    </div>
                     <button id="apply-filter-btn" class="w-full mt-2 bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600">絞り込む</button>
                </div>
                <div class="mb-4">
                    <canvas id="history-chart"></canvas>
                </div>
                <div id="history-list" class="space-y-4">
                    </div>
            </div>

            <div id="settings-screen" class="hidden">
                <h1 class="text-2xl font-bold mb-6">設定</h1>
                <div id="settings-accordion" class="space-y-4">
                     </div>
                 <div class="mt-8 pt-6 border-t">
                    <h2 class="text-xl font-semibold mb-4">データ管理</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="export-csv-btn" class="bg-green-500 text-white py-3 rounded-lg hover:bg-green-600"><i class="fas fa-file-export mr-2"></i>CSVエクスポート</button>
                        <label for="import-csv-input" class="bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 text-center cursor-pointer"><i class="fas fa-file-import mr-2"></i>CSVインポート</label>
                        <input type="file" id="import-csv-input" class="hidden" accept=".csv">
                    </div>
                </div>
            </div>

        </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t shadow-md">
            <div class="flex justify-around">
                <button data-screen="home" class="nav-btn flex-1 py-3 text-center text-gray-500">
                    <i class="fas fa-home text-xl"></i>
                    <span class="block text-xs">ホーム</span>
                </button>
                <button data-screen="history" class="nav-btn flex-1 py-3 text-center text-gray-500">
                    <i class="fas fa-chart-line text-xl"></i>
                    <span class="block text-xs">履歴</span>
                </button>
                <button data-screen="settings" class="nav-btn flex-1 py-3 text-center text-gray-500">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="block text-xs">設定</span>
                </button>
            </div>
        </nav>
    </div>

    <template id="block-template">
        <div class="block-card bg-gray-50 border rounded-lg p-3 shadow-sm">
            <div class="flex justify-between items-start mb-2">
                <div class="exercise-tabs-container overflow-x-auto whitespace-nowrap flex-grow pb-1">
                    </div>
                <button class="remove-block-btn text-red-500 hover:text-red-700 p-2 ml-2 flex-shrink-0"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="exercise-content-container">
                 </div>
        </div>
    </template>
    
    <template id="exercise-content-template">
        <div class="exercise-content">
            <div class="grid grid-cols-3 gap-2 mb-3 bg-gray-100 p-2 rounded-md">
                <select class="exercise-detail-select equipment-select p-1.5 border rounded-md text-sm"></select>
                <select class="exercise-detail-select attachment-select p-1.5 border rounded-md text-sm"></select>
                <select class="exercise-detail-select angle-select p-1.5 border rounded-md text-sm"></select>
            </div>
            <div class="sets-container space-y-2">
                </div>
            <button class="add-set-btn w-full mt-3 bg-gray-200 text-gray-700 py-1.5 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                <i class="fas fa-plus mr-1"></i>セット追加
            </button>
        </div>
    </template>

    <template id="set-template">
         <div class="set-row grid grid-cols-12 gap-x-2 items-center bg-white p-1 rounded-lg border">
            <div class="col-span-2 flex items-center justify-center">
                <input type="checkbox" class="warmup-check h-4 w-4 mr-1.5">
                <span class="font-bold text-gray-600 text-sm set-number"></span>
            </div>
            <div class="col-span-3">
                <input type="number" step="0.5" inputmode="decimal" placeholder="重量" class="weight-input w-full p-1.5 border rounded-md">
            </div>
            <div class="col-span-2">
                <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="回" class="reps-input w-full p-1.5 border rounded-md">
            </div>
            <div class="col-span-3">
                <input type="text" placeholder="メモ" class="memo-input w-full p-1.5 border rounded-md">
            </div>
            <div class="col-span-2 flex items-center justify-end">
                 <span class="text-xs text-gray-500 w-10 text-center 1rm-display">0</span>
                 <button class="remove-set-btn text-gray-400 hover:text-red-500 text-lg ml-1"><i class="fas fa-times-circle"></i></button>
            </div>
             <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="補助" class="assisted-reps-input hidden">
        </div>
    </template>

    <script>
        // アプリケーションの全ロジック
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // ... (中略: DOM要素, 状態管理, チャートインスタンス) ...
                // ===== DOM要素 =====
                screens: {
                    home: document.getElementById('home-screen'),
                    record: document.getElementById('record-screen'),
                    history: document.getElementById('history-screen'),
                    settings: document.getElementById('settings-screen'),
                },
                navButtons: document.querySelectorAll('.nav-btn'),
                
                // ===== 状態管理 =====
                db: null,
                state: {
                    currentScreen: 'home',
                    // currentWorkoutはlocalStorageから読み込む
                },
                chartInstance: null,
                debounceTimer: null,


                // ===== 初期化 =====
                init() {
                    this.loadDB();
                    this.attachEventListeners();
                    this.navigateTo('home');
                },

                // ===== DB操作 =====
                loadDB() {
                    try {
                        const data = localStorage.getItem('workoutAppDB');
                        this.db = data ? JSON.parse(data) : this.getDefaultDB();
                    } catch (e) {
                        console.error("DBの読み込みに失敗しました", e);
                        this.db = this.getDefaultDB();
                    }
                },
                
                saveDB() {
                    try {
                        localStorage.setItem('workoutAppDB', JSON.stringify(this.db));
                    } catch (e) {
                        console.error("DBの保存に失敗しました", e);
                        alert("データの保存に失敗しました。");
                    }
                },

                getDefaultDB() {
                    return {
                        settings: {
                            parts: ['胸', '背中', '肩', '腕', '脚', '腹筋'],
                            exercises: {
                                '胸': ['ベンチプレス', 'ダンベルフライ', 'インクラインプレス', 'ケーブルクロスオーバー'],
                                '背中': ['デッドリフト', '懸垂', 'ラットプルダウン', 'ベントオーバーロウ'],
                                '肩': ['ショルダープレス', 'サイドレイズ', 'リアレイズ'],
                                '腕': ['バーベルカール', 'スカルクラッシャー', 'ハンマーカール'],
                                '脚': ['スクワット', 'レッグプレス', 'レッグエクステンション'],
                                '腹筋': ['クランチ', 'レッグレイズ', 'アブローラー'],
                            },
                            equipment: ['バーベル', 'ダンベル', 'マシン', 'ケーブル', '自重'],
                            attachments: ['ストレートバー', 'ロープ', 'Vバー', 'MAGグリップ'],
                            angles: ['フラット', 'インクライン', 'デクライン'],
                        },
                        logs: [],
                    };
                },

                // ★改善: 入力中データの保存・読み込み
                saveInProgressWorkout() {
                    const currentWorkout = this.captureWorkoutState();
                    if (currentWorkout.part) {
                        localStorage.setItem('workoutAppInProgress', JSON.stringify(currentWorkout));
                    }
                },
                
                loadInProgressWorkout(part) {
                    const saved = localStorage.getItem('workoutAppInProgress');
                    if (saved) {
                        const workout = JSON.parse(saved);
                        // 同じ部位の作業を再開する場合のみ読み込む
                        if (workout.part === part) {
                            return workout;
                        }
                    }
                    return null;
                },

                clearInProgressWorkout() {
                    localStorage.removeItem('workoutAppInProgress');
                },

                // ★改善: debounce関数
                debounce(func, delay) {
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(func, delay);
                },

                // ===== イベントリスナー =====
                attachEventListeners() {
                    this.navButtons.forEach(btn => btn.addEventListener('click', () => this.navigateTo(btn.dataset.screen)));
                    document.getElementById('part-selection').addEventListener('click', e => {
                        const partBtn = e.target.closest('.part-btn');
                        if (partBtn) this.startWorkout(partBtn.dataset.part);
                    });
                    document.getElementById('back-to-home-btn').addEventListener('click', () => this.navigateTo('home'));
                    document.getElementById('add-block-btn').addEventListener('click', () => this.addBlock());
                    document.getElementById('finish-workout-btn').addEventListener('click', () => this.finishWorkout());
                    
                    const blocksContainer = document.getElementById('blocks-container');
                    blocksContainer.addEventListener('click', e => {
                        const target = e.target;
                        if (target.closest('.add-set-btn')) this.addSet(target.closest('.exercise-content'));
                        if (target.closest('.remove-set-btn')) this.removeSet(target.closest('.set-row'));
                        if (target.closest('.remove-block-btn')) this.removeBlock(target.closest('.block-card'));
                        if (target.closest('.exercise-tab')) this.switchExerciseTab(target.closest('.exercise-tab'));
                        if (target.closest('.add-exercise-btn')) this.addExercise(target.closest('.block-card'));
                    });
                    
                    blocksContainer.addEventListener('input', e => {
                        if (e.target.matches('.weight-input, .reps-input')) {
                            this.update1RM(e.target.closest('.set-row'));
                        }
                        this.debounce(() => this.saveInProgressWorkout(), 500);
                    });
                    blocksContainer.addEventListener('change', () => { // select要素の変更も保存
                        this.debounce(() => this.saveInProgressWorkout(), 500);
                    });

                    document.getElementById('apply-filter-btn').addEventListener('click', () => this.renderHistoryScreen());
                    document.getElementById('settings-accordion').addEventListener('click', e => {
                        if (e.target.closest('.toggle-accordion')) {
                             e.target.closest('.toggle-accordion').nextElementSibling.classList.toggle('hidden');
                        }
                    });
                    document.getElementById('export-csv-btn').addEventListener('click', () => this.exportCSV());
                    document.getElementById('import-csv-input').addEventListener('change', e => this.importCSV(e));
                },

                // ===== ナビゲーションと画面描画 =====
                navigateTo(screenId) {
                    this.state.currentScreen = screenId;
                    Object.values(this.screens).forEach(screen => screen.classList.add('hidden'));
                    
                    const activeScreen = this.screens[screenId] || this.screens.home;
                    activeScreen.classList.remove('hidden');
                    
                    if (screenId === 'home') this.renderHomeScreen();
                    if (screenId === 'history') this.renderHistoryScreen();
                    if (screenId === 'settings') this.renderSettingsScreen();
                    if (screenId === 'record') this.renderRecordScreen();

                    this.navButtons.forEach(btn => {
                        const isRecordScreen = screenId === 'record' && btn.dataset.screen === 'home';
                        btn.classList.toggle('text-blue-500', btn.dataset.screen === screenId || isRecordScreen);
                        btn.classList.toggle('border-t-4', btn.dataset.screen === screenId || isRecordScreen);
                        btn.classList.toggle('border-blue-500', btn.dataset.screen === screenId || isRecordScreen);
                        btn.classList.toggle('text-gray-500', !(btn.dataset.screen === screenId || isRecordScreen));
                    });
                },

                renderHomeScreen() {
                    const today = new Date();
                    const datesInRange = (days) => {
                      const pastDate = new Date();
                      pastDate.setDate(today.getDate() - days);
                      return new Set(this.db.logs
                          .filter(log => new Date(log.date) >= pastDate)
                          .map(log => log.date.split('T')[0])
                      );
                    };
                    document.getElementById('summary-7-days').textContent = `${datesInRange(7).size}日`;
                    document.getElementById('summary-30-days').textContent = `${datesInRange(30).size}日`;

                    const partContainer = document.getElementById('part-selection');
                    partContainer.innerHTML = this.db.settings.parts.map(part => `
                        <button class="part-btn bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow text-left" data-part="${part}">
                            <span class="text-xl font-bold">${part}</span>
                        </button>
                    `).join('');
                },
                
                startWorkout(part) {
                    const inProgress = this.loadInProgressWorkout(part);
                    if (inProgress) {
                        this.navigateTo('record');
                        this.renderRecordScreen(inProgress);
                    } else {
                        const newWorkout = {
                            part: part,
                            date: new Date().toISOString(),
                            blocks: [],
                        };
                        this.navigateTo('record');
                        this.renderRecordScreen(newWorkout);
                        this.addBlock(true); // 新規ワークアウト時に最初のブロックを追加
                    }
                },
                
                renderRecordScreen(workoutData) {
                    document.getElementById('record-title').textContent = `${workoutData.part} の記録`;
                    const container = document.getElementById('blocks-container');
                    container.innerHTML = '';
                    
                    workoutData.blocks.forEach(blockData => {
                        const blockEl = this.addBlock(false);
                        blockEl.dataset.id = blockData.id;
                        
                        blockData.exercises.forEach((exData, index) => {
                            if (index > 0) this.addExercise(blockEl, false); // 2つ目以降のエクササイズを追加
                            const exerciseContent = blockEl.querySelector(`[data-exercise-id="${exData.id}"]`);
                            const tabsContainer = blockEl.querySelector('.exercise-tabs-container');
                            const tab = tabsContainer.querySelector(`[data-exercise-id="${exData.id}"]`);
                            
                            // データをUIに反映
                            tab.querySelector('.exercise-select').value = exData.name;
                            exerciseContent.querySelector('.equipment-select').value = exData.equipment;
                            exerciseContent.querySelector('.attachment-select').value = exData.attachment;
                            exerciseContent.querySelector('.angle-select').value = exData.angle;
                            
                            exData.sets.forEach(setData => {
                                const setEl = this.addSet(exerciseContent, false);
                                setEl.querySelector('.warmup-check').checked = setData.warmup;
                                setEl.querySelector('.weight-input').value = setData.weight;
                                setEl.querySelector('.reps-input').value = setData.reps;
                                setEl.querySelector('.assisted-reps-input').value = setData.assistedReps;
                                setEl.querySelector('.memo-input').value = setData.memo;
                                this.update1RM(setEl);
                            });
                        });
                    });
                },

                // ★改善: UIから現在のワークアウト状態を取得する
                captureWorkoutState() {
                    const part = document.getElementById('record-title').textContent.replace(' の記録', '');
                    const blocks = [];
                    document.querySelectorAll('.block-card').forEach(blockEl => {
                        const exercises = [];
                        blockEl.querySelectorAll('.exercise-content').forEach(exContentEl => {
                            const tab = blockEl.querySelector(`.exercise-tab[data-exercise-id="${exContentEl.dataset.exerciseId}"]`);
                            const sets = [];
                            exContentEl.querySelectorAll('.set-row').forEach(setEl => {
                                sets.push({
                                    id: setEl.dataset.id,
                                    warmup: setEl.querySelector('.warmup-check').checked,
                                    weight: parseFloat(setEl.querySelector('.weight-input').value) || 0,
                                    reps: parseInt(setEl.querySelector('.reps-input').value) || 0,
                                    assistedReps: parseInt(setEl.querySelector('.assisted-reps-input').value) || 0,
                                    memo: setEl.querySelector('.memo-input').value,
                                });
                            });
                            exercises.push({
                                id: exContentEl.dataset.exerciseId,
                                name: tab.querySelector('.exercise-select').value,
                                equipment: exContentEl.querySelector('.equipment-select').value,
                                attachment: exContentEl.querySelector('.attachment-select').value,
                                angle: exContentEl.querySelector('.angle-select').value,
                                sets: sets
                            });
                        });
                        if (exercises.length > 0) {
                            blocks.push({ id: blockEl.dataset.id, exercises: exercises });
                        }
                    });
                    return { part: part, date: new Date().toISOString(), blocks: blocks };
                },
                
                // ★改善: ブロック追加ロジック
                addBlock(isNew = true) {
                    const template = document.getElementById('block-template');
                    const clone = template.content.cloneNode(true);
                    const blockCard = clone.querySelector('.block-card');
                    blockCard.dataset.id = `block_${Date.now()}`;
                    document.getElementById('blocks-container').appendChild(clone);
                    this.addExercise(blockCard, isNew);
                    return blockCard;
                },

                removeBlock(blockEl) {
                    if (confirm('この種目ブロックを削除しますか？')) {
                        blockEl.remove();
                        this.saveInProgressWorkout();
                    }
                },
                
                // ★改善: 種目追加ロジック (スーパーセット用)
                addExercise(blockCard, addDefaultSet = true) {
                    const part = document.getElementById('record-title').textContent.replace(' の記録', '');
                    const exerciseOptions = (this.db.settings.exercises[part] || []).map(ex => `<option value="${ex}">${ex}</option>`).join('');

                    const tabsContainer = blockCard.querySelector('.exercise-tabs-container');
                    const contentContainer = blockCard.querySelector('.exercise-content-container');
                    const exerciseId = `ex_${Date.now()}`;

                    // 新しいタブを作成
                    const tab = document.createElement('div');
                    tab.className = 'exercise-tab inline-block border-b-2 border-transparent px-3 py-1.5 text-sm font-medium cursor-pointer';
                    tab.dataset.exerciseId = exerciseId;
                    tab.innerHTML = `<select class="exercise-select bg-transparent focus:outline-none">${exerciseOptions}</select><button class="remove-exercise-btn text-gray-400 ml-1.5 hover:text-red-500 text-xs"><i class="fas fa-times"></i></button>`;
                    
                    // 「種目追加」ボタンの前にタブを挿入
                    let addBtn = tabsContainer.querySelector('.add-exercise-btn');
                    if (!addBtn) {
                        addBtn = document.createElement('button');
                        addBtn.className = 'add-exercise-btn text-blue-500 ml-2 text-xl';
                        addBtn.innerHTML = '<i class="fas fa-plus-circle"></i>';
                        tabsContainer.appendChild(addBtn);
                    }
                    tabsContainer.insertBefore(tab, addBtn);
                    
                    // 新しいコンテンツエリアを作成
                    const contentTemplate = document.getElementById('exercise-content-template');
                    const contentClone = contentTemplate.content.cloneNode(true);
                    const exerciseContent = contentClone.querySelector('.exercise-content');
                    exerciseContent.dataset.exerciseId = exerciseId;

                    // 詳細項目のプルダウンを生成
                    const populateSelect = (selector, key) => {
                        const select = exerciseContent.querySelector(selector);
                        select.innerHTML = this.db.settings[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    };
                    populateSelect('.equipment-select', 'equipment');
                    populateSelect('.attachment-select', 'attachments');
                    populateSelect('.angle-select', 'angles');
                    
                    contentContainer.appendChild(contentClone);
                    
                    if(addDefaultSet) this.addSet(exerciseContent);
                    
                    this.switchExerciseTab(tab);
                },
                
                switchExerciseTab(targetTab) {
                    const blockCard = targetTab.closest('.block-card');
                    const exerciseId = targetTab.dataset.exerciseId;
                    
                    blockCard.querySelectorAll('.exercise-tab').forEach(t => t.classList.remove('tab-active'));
                    targetTab.classList.add('tab-active');
                    
                    blockCard.querySelectorAll('.exercise-content').forEach(c => c.classList.add('hidden'));
                    blockCard.querySelector(`.exercise-content[data-exercise-id="${exerciseId}"]`).classList.remove('hidden');
                },

                // ★改善: セット追加ロジック
                addSet(exerciseContent, save = true) {
                    const template = document.getElementById('set-template');
                    const clone = template.content.cloneNode(true);
                    const setsContainer = exerciseContent.querySelector('.sets-container');
                    const setNumber = setsContainer.children.length + 1;
                    clone.querySelector('.set-number').textContent = `S${setNumber}`;
                    clone.querySelector('.set-row').dataset.id = `set_${Date.now()}`;
                    setsContainer.appendChild(clone);
                    if (save) this.saveInProgressWorkout();
                    return setsContainer.lastElementChild;
                },

                removeSet(setElement) {
                    const setsContainer = setElement.parentElement;
                    setElement.remove();
                    Array.from(setsContainer.children).forEach((set, index) => {
                        set.querySelector('.set-number').textContent = `S${index + 1}`;
                    });
                    this.saveInProgressWorkout();
                },
                
                update1RM(setElement) {
                    const weight = parseFloat(setElement.querySelector('.weight-input').value) || 0;
                    const reps = parseInt(setElement.querySelector('.reps-input').value) || 0;
                    const rm = (weight > 0 && reps > 0) ? weight * (1 + reps / 40) : 0;
                    setElement.querySelector('.1rm-display').textContent = `${rm.toFixed(0)}`;
                },
                
                finishWorkout() {
                    const workoutData = this.captureWorkoutState();

                    // データが空でないかチェック
                    const hasData = workoutData.blocks.some(block => 
                        block.exercises.some(ex => ex.sets.length > 0 && ex.sets.some(set => set.weight > 0 || set.reps > 0))
                    );

                    if (!hasData) {
                        alert("記録するデータがありません。");
                        return;
                    }

                    this.db.logs.push({ ...workoutData, id: `log_${Date.now()}` });
                    this.saveDB();
                    this.clearInProgressWorkout();
                    alert('トレーニングを保存しました！');
                    this.navigateTo('home');
                },
                
                // ... (以下、履歴画面と設定画面、データ管理のロジックはほぼ同じ) ...
                renderHistoryScreen() {
                    // フィルターの準備
                    const filterPartEl = document.getElementById('filter-part');
                    filterPartEl.innerHTML = '<option value="">全部位</option>' + this.db.settings.parts.map(p => `<option value="${p}">${p}</option>`).join('');
                    const allExercises = [...new Set(Object.values(this.db.settings.exercises).flat())];
                    const filterExerciseEl = document.getElementById('filter-exercise');
                    filterExerciseEl.innerHTML = '<option value="">全種目</option>' + allExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');

                    // フィルタリングロジック
                    const startDate = document.getElementById('filter-start-date').value;
                    const endDate = document.getElementById('filter-end-date').value;
                    const part = filterPartEl.value;
                    const exercise = filterExerciseEl.value;
                    
                    let filteredLogs = this.db.logs.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

                    if (startDate) filteredLogs = filteredLogs.filter(log => log.date.split('T')[0] >= startDate);
                    if (endDate) filteredLogs = filteredLogs.filter(log => log.date.split('T')[0] <= endDate);
                    if (part) filteredLogs = filteredLogs.filter(log => log.part === part);
                    if (exercise) {
                        filteredLogs = filteredLogs.map(log => {
                            const filteredBlocks = log.blocks.map(block => {
                                const filteredExercises = block.exercises.filter(ex => ex.name === exercise);
                                return filteredExercises.length > 0 ? { ...block, exercises: filteredExercises } : null;
                            }).filter(Boolean);
                            return filteredBlocks.length > 0 ? { ...log, blocks: filteredBlocks } : null;
                        }).filter(Boolean);
                    }

                    const listEl = document.getElementById('history-list');
                    if(filteredLogs.length === 0) {
                        listEl.innerHTML = '<p class="text-gray-500 text-center py-8">表示できる履歴がありません。</p>';
                        this.updateChart([], []);
                        return;
                    }

                    listEl.innerHTML = filteredLogs.map(log => {
                        const logDate = new Date(log.date);
                        const dateString = `${logDate.getFullYear()}/${logDate.getMonth()+1}/${logDate.getDate()}`;
                        return `
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b">
                                    <h3 class="font-bold text-lg">${log.part}</h3>
                                    <span class="text-sm text-gray-500">${dateString}</span>
                                </div>
                                ${log.blocks.map(block => block.exercises.map(ex => `
                                    <div class="mt-2">
                                        <h4 class="font-semibold">${ex.name}</h4>
                                        <div class="text-xs text-gray-500">${ex.equipment}/${ex.attachment}/${ex.angle}</div>
                                        <div class="text-sm text-gray-700 mt-1 space-y-0.5">
                                            ${ex.sets.map((set, i) => `
                                                <div class="flex justify-between items-center ${set.warmup ? 'text-gray-400' : ''}">
                                                    <span>Set ${i+1}: ${set.weight}kg x ${set.reps}回</span>
                                                    <span class="text-xs">${set.memo || ''}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')).join('')}
                            </div>
                        `;
                    }).join('');
                    
                    if (exercise) {
                        const chartLabels = [];
                        const chartData = [];
                        filteredLogs.reverse().forEach(log => {
                            const logDate = new Date(log.date);
                            const dateString = `${logDate.getMonth()+1}/${logDate.getDate()}`;
                            log.blocks.forEach(block => block.exercises.forEach(ex => {
                                if (ex.name === exercise) {
                                    ex.sets.forEach(set => {
                                        if (!set.warmup && set.weight > 0 && set.reps > 0) {
                                            chartLabels.push(dateString);
                                            chartData.push(parseFloat((set.weight * (1 + set.reps / 40)).toFixed(1)));
                                        }
                                    });
                                }
                            }));
                        });
                        this.updateChart(chartLabels, chartData);
                    } else {
                         this.updateChart([], []);
                    }
                },
                
                updateChart(labels, data) {
                    const ctx = document.getElementById('history-chart').getContext('2d');
                    if (this.chartInstance) this.chartInstance.destroy();
                    if(labels.length === 0 || data.length === 0) return;
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '1RM (kg)',
                                data: data,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                },

                renderSettingsScreen() {
                    const accordion = document.getElementById('settings-accordion');
                    accordion.innerHTML = `
                        ${this.createSettingSection('部位', 'parts', this.db.settings.parts)}
                        ${this.createSettingSection('器具', 'equipment', this.db.settings.equipment)}
                        ${this.createSettingSection('アタッチメント', 'attachments', this.db.settings.attachments)}
                        ${this.createSettingSection('角度', 'angles', this.db.settings.angles)}
                    `;
                },
                
                createSettingSection(title, key, items) {
                     return `
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <button class="toggle-accordion w-full text-left p-4 font-semibold text-lg flex justify-between items-center bg-gray-50 hover:bg-gray-100">
                                <span>${title}の編集</span><i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="p-4 hidden">
                                <ul class="list-disc pl-5 mb-4 space-y-2">
                                    ${items.map(item => `<li>${item} <button class="text-red-500 ml-2" onclick="app.removeItemFromSettings('${key}', '${item}')"><i class="fas fa-times"></i></button></li>`).join('')}
                                </ul>
                                <div class="flex gap-2">
                                    <input type="text" id="new-${key}-input" class="w-full p-2 border rounded-md" placeholder="新しい${title}を追加">
                                    <button class="bg-blue-500 text-white px-4 rounded-md" onclick="app.addItemToSettings('${key}')">追加</button>
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                addItemToSettings(key) {
                    const input = document.getElementById(`new-${key}-input`);
                    const value = input.value.trim();
                    if (value && !this.db.settings[key].includes(value)) {
                        this.db.settings[key].push(value);
                        this.saveDB();
                        this.renderSettingsScreen();
                    }
                    input.value = '';
                },

                removeItemFromSettings(key, item) {
                    if (confirm(`「${item}」を削除しますか？`)) {
                        this.db.settings[key] = this.db.settings[key].filter(i => i !== item);
                        this.saveDB();
                        this.renderSettingsScreen();
                    }
                },
                
                exportCSV() {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "日付,部位,種目,器具,アタッチメント,角度,セット,ウォームアップ,重量,レップ,メモ\n";
                    this.db.logs.forEach(log => {
                        log.blocks.forEach(block => block.exercises.forEach(ex => {
                            ex.sets.forEach((set, index) => {
                                const row = [log.date,log.part,ex.name,ex.equipment,ex.attachment,ex.angle,index + 1,set.warmup,set.weight,set.reps,`"${set.memo || ''}"`].join(',');
                                csvContent += row + "\n";
                            });
                        }));
                    });
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", "workout_log.csv");
                    link.click();
                },

                importCSV(event) {
                    alert("CSVインポート機能は現在開発中です。");
                }
            };

            window.app = app; // Make it globally accessible for inline event handlers
            app.init();
        });
    </script>
</body>
</html>