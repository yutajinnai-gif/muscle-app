<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>筋トレメモ | BUILD_TAG=STARTER-20250925</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    /* iOSのズーム誤爆抑止 */
   input, select, textarea {
    color: #000;            /* 黒文字 */
    background-color: #fff; /* 白背景 */
  }
  button {
    color: #000;
  }
    /* 下タブのための余白 */
    main { padding-bottom: 140px; } /* もともと84px → 140pxへ */
  </style>
</head>
<body class="bg-white text-black">
  <!-- エラー帯 -->
  <div id="errbar" class="hidden fixed top-0 left-0 right-0 z-50 bg-red-600 text-white text-sm px-4 py-2"></div>

  <!-- ヘッダー -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold">筋トレメモアプリ</h1>
      <span id="build" class="text-xs text-slate-500">STARTER</span>
    </div>
  </header>

  <!-- ページ本体 -->
  <main class="max-w-2xl mx-auto px-4 py-4" id="view">
    <!-- ここにJSで画面を描画 -->
  </main>

  <!-- 下タブ -->
  <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white/90 backdrop-blur border-t border-slate-200">
    <div class="max-w-2xl mx-auto grid grid-cols-3">
      <button data-tab="home" class="tab px-4 py-3 text-sm font-medium">ホーム</button>
      <button data-tab="history" class="tab px-4 py-3 text-sm font-medium">履歴</button>
      <button data-tab="settings" class="tab px-4 py-3 text-sm font-medium">設定</button>
    </div>
  </nav>

  <!-- 固定アクションバー（ホーム画面だけ表示する） -->
  <div id="actionbar" class="fixed left-0 right-0 bottom-16 z-50 hidden">
    <div class="max-w-2xl mx-auto px-4">
      <div class="flex gap-3">
        <button id="fab-add" class="w-full py-4 rounded-xl bg-blue-600 text-white text-lg font-semibold shadow-lg">
          追加
        </button>
        <button id="fab-dup" class="py-4 px-5 rounded-xl bg-indigo-600 text-white text-lg font-semibold shadow-lg">
          ＋1
        </button>
      </div>
    </div>
  </div>

  <script>
  // ====== 安全ユーティリティ ======
  const NS = "muscle-app";
  const KEYS = {
    LOGS: `${NS}:workout-logs`,
    SETTINGS: `${NS}:settings`,
    SCHEMA: `${NS}:schema-version`,
    RECENTS: `${NS}:recent-exercises`,        // 追加
    LAST_BY_EX: `${NS}:last-by-exercise`      // 追加
  };
  // 部位ごとの種目マップ（必要に応じて自由に増やせます）
  const PARTS = {
    胸: ["ベンチプレス","インクラインベンチプレス","ダンベルプレス","ダンベルフライ","ケーブルクロス"],
    背中: ["ラットプルダウン","シーテッドロウ","デッドリフト","ルーマニアンデッドリフト","ワンハンドロウ"],
    脚: ["スクワット","フロントスクワット","レッグプレス","レッグエクステンション","レッグカール"],
    肩: ["ショルダープレス","サイドレイズ","リアレイズ","フロントレイズ","アップライトロウ"],
    腕: ["アームカール","プリーチャーカール","プレスダウン","フレンチプレス","ハンマーカール"]
  };
  const PART_ORDER = Object.keys(PARTS); // 表示順
  const KEYS_LAST_PART = `${NS}:last-part`;
  const SCHEMA_VERSION = 1;

    // ＋/−ボタンの増分値をまとめた定数（ここに追記）
  const INCREMENTS = { kg: 2.5, lb: 5, reps: 1 };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function showError(msg) {
    const bar = $("#errbar");
    bar.textContent = msg;
    bar.classList.remove("hidden");
  }
  function hideError() {
    $("#errbar").classList.add("hidden");
  }

  window.onerror = (message, src, line, col, err) => {
    showError(String(message || err || "不明なエラー"));
    return false;
  };
  window.onunhandledrejection = (e) => {
    showError(String(e.reason || e));
  };

  function safeParse(json, fallback) {
    try { return JSON.parse(json); } catch { return fallback; }
  }

  function load(key, fallback) {
    const raw = localStorage.getItem(key);
    return raw == null ? fallback : safeParse(raw, fallback);
  }
  function save(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  // 初期化（スキーマ差異なら全体初期化）
  (function bootstrap() {
    const v = load(KEYS.SCHEMA, null);
    if (v !== SCHEMA_VERSION) {
      if (v !== null) {
        // 既存データの破損を避けるため、LOGSだけは生かす…が、今回はシンプルに初期化
        // 必要ならここでマイグレーションを書く
      }
      save(KEYS.LOGS, []);
      save(KEYS.SETTINGS, { unit: "kg", theme: "light" });
      save(KEYS.SCHEMA, SCHEMA_VERSION);
    }
  })();

  // ====== ルーター ======
  const routes = ["home","history","settings"];
  function currentRoute() {
    const h = location.hash.replace(/^#\/?/, "");
    return routes.includes(h) ? h : "home";
  }
  function navigate(to) {
    if (!routes.includes(to)) to = "home";
    if (currentRoute() !== to) location.hash = `#/${to}`;
    render();
  }
  window.addEventListener("hashchange", () => {
    render();
    highlightTab();
  });

  // 簡易マスタ（必要に応じて追加/編集OK）
  const EXERCISE_MASTER = [
    "ベンチプレス","インクラインベンチプレス","ダンベルプレス","スクワット","フロントスクワット",
    "デッドリフト","ルーマニアンデッドリフト","ラットプルダウン","シーテッドロウ",
    "ショルダープレス","サイドレイズ","アームカール","プレスダウン","レッグプレス",
  ];

  // 最近使った種目（最大10件を新しい順で保持）
  function getRecents() { return load(KEYS.RECENTS, []); }
  function pushRecent(ex) {
    const name = ex.trim();
    if (!name) return;
    let r = getRecents().filter(x => x !== name);
    r.unshift(name);
    if (r.length > 10) r = r.slice(0,10);
    save(KEYS.RECENTS, r);
  }

  // 種目ごとの直近値（重量/回数/単位）を保存・取得
  function getLastByEx() { return load(KEYS.LAST_BY_EX, {}); }
  function setLastByEx(map) { save(KEYS.LAST_BY_EX, map); }
  function rememberLast(exercise, payload) {
    const m = getLastByEx();
    m[exercise] = { ...m[exercise], ...payload };
    setLastByEx(m);
  }

  function getLastPart() {
    return load(KEYS_LAST_PART, PART_ORDER[0] || "胸");
  }
  function setLastPart(p) {
    save(KEYS_LAST_PART, p);
  }

  // 部位変更時に種目候補とチップを差し替える
  function updateExerciseOptionsByPart() {
    const part = $("#f-part")?.value || getLastPart();
    const list = PARTS[part] || [];
    // datalist
    const optionsHtml = list.map(n => `<option value="${n}"></option>`).join("");
    $("#ex-list")?.replaceChildren();
    if ($("#ex-list")) $("#ex-list").innerHTML = optionsHtml;

    // 最近チップ（対象部位の種目だけを表示）
    const recents = getRecents().filter(n => list.includes(n));
    const chipsHtml = recents.map(n =>
      `<button type="button" class="px-2 py-1 text-xs rounded-full border hover:bg-slate-100 mr-2 mb-2" data-chip="${n}">${n}</button>`
    ).join("");
    const chipsWrap = $("#recent-chips");
    if (chipsWrap) chipsWrap.innerHTML = chipsHtml;

    // チップのイベントを張り直し
    $$("#recent-chips [data-chip]").forEach(btn => {
      btn.addEventListener("click", () => {
        $("#f-ex").value = btn.getAttribute("data-chip");
        autofillFromLast();
      });
    });
  }

  // ====== データアクセス ======
  function getLogs() { return load(KEYS.LOGS, []); }
  function setLogs(arr) { save(KEYS.LOGS, arr); }
  function addLog(entry) {
    const arr = getLogs();
    arr.unshift({ id: crypto.randomUUID(), ...entry });
    setLogs(arr);
  }
  function removeLog(id) {
    setLogs(getLogs().filter(x => x.id !== id));
  }

  // ====== 画面 ======
 function viewHome() {
  const today = new Date().toISOString().slice(0,10);
  const s = getSettings();
  const unit = s.unit;
  const selectedPart = getLastPart();
  const list = PARTS[selectedPart] || [];

  const options = list.map(name => `<option value="${name}"></option>`).join("");
  const chips = getRecents().filter(n => list.includes(n)).map(n =>
    `<button type="button" class="px-2 py-1 text-xs rounded-full border hover:bg-slate-100 mr-2 mb-2" data-chip="${n}">${n}</button>`
  ).join("");

  const partOptions = PART_ORDER.map(p =>
    `<option value="${p}" ${p===selectedPart?"selected":""}>${p}</option>`
  ).join("");

  return `
    <section class="space-y-4">
      <h2 class="text-base font-semibold">記録を追加</h2>

      <div class="grid grid-cols-2 gap-3">

        <label class="text-sm">
          <span class="block mb-1 text-slate-600">部位</span>
          <select id="f-part" class="w-full border rounded-lg px-3 py-2">
            ${partOptions}
          </select>
        </label>

        <label class="text-sm">
          <span class="block mb-1 text-slate-600">日付</span>
          <input id="f-date" type="date" value="${today}"
            class="w-full border rounded-lg px-3 py-2">
        </label>

        <label class="col-span-2 text-sm">
          <span class="block mb-1 text-slate-600">種目 <span class="text-xs text-slate-500">(部位に関連する種目のみ)</span></span>
          <input id="f-ex" list="ex-list" type="text" placeholder="例：ベンチプレス"
            enterkeyhint="next"
            class="w-full border rounded-lg px-3 py-2">
          <datalist id="ex-list">${options}</datalist>
        </label>

        <div id="recent-chips" class="col-span-2 -mt-2">${chips ? `<div class="flex flex-wrap mt-1">${chips}</div>` : ""}</div>

        <label class="text-sm">
          <span class="block mb-1 text-slate-600">重量 (${unit})</span>
          <div class="flex items-center gap-2">
            <button type="button" class="px-2 py-1 border rounded" data-dec="weight">−</button>
            <input id="f-weight" type="number" inputmode="decimal" step="any" placeholder="${unit}"
              enterkeyhint="next"
              class="w-full border rounded-lg px-3 py-2">
            <button type="button" class="px-2 py-1 border rounded" data-inc="weight">＋</button>
          </div>
        </label>

        <label class="text-sm">
          <span class="block mb-1 text-slate-600">回数</span>
          <div class="flex items-center gap-2">
            <button type="button" class="px-2 py-1 border rounded" data-dec="reps">−</button>
            <input id="f-reps" type="number" inputmode="numeric" step="1" placeholder="10"
              enterkeyhint="next"
              class="w-full border rounded-lg px-3 py-2">
            <button type="button" class="px-2 py-1 border rounded" data-inc="reps">＋</button>
          </div>
        </label>

        <label class="col-span-2 text-sm">
          <span class="block mb-1 text-slate-600">メモ（任意）</span>
          <input id="f-note" type="text" placeholder="フォーム/感覚など"
            enterkeyhint="done"
            class="w-full border rounded-lg px-3 py-2">
        </label>
      </div>

      <div class="flex gap-3">
        <button id="btn-add" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium">追加</button>
        <button id="btn-add-dup" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-medium">もう1セット</button>
        <button id="btn-clear" class="px-3 py-2 rounded-lg border">入力クリア</button>
      </div>

      <hr class="my-4">
      <h3 class="text-sm font-semibold text-slate-600">直近の記録</h3>
      <div id="recent" class="divide-y"></div>
    </section>
  `;
}

  function renderRecent() {
    const wrap = $("#recent");
    if (!wrap) return;
    const rows = getLogs().slice(0,5).map(rowToItem).join("") || `<p class="text-sm text-slate-500 py-3">まだ記録がありません。</p>`;
    wrap.innerHTML = rows;
    bindItemButtons(wrap);
  }

  function rowToItem(x) {
  return `
    <div class="py-3 flex items-start justify-between gap-3" data-row="${x.id}">
      <div class="min-w-0">
        <div class="font-medium">${escapeHtml(x.exercise)} <span class="text-slate-500 text-sm">(${x.weight}${(x.unit ?? getSettings().unit)} × ${x.reps}回)</span></div>
        <div class="text-xs text-slate-500">${x.date}</div>
        ${x.note ? `<div class="text-sm break-words">${escapeHtml(x.note)}</div>` : ""}
      </div>
      <div class="shrink-0 flex gap-2">
        <button data-edit="${x.id}" class="text-xs text-blue-600 hover:underline">編集</button>
        <button data-del="${x.id}" class="text-xs text-red-600 hover:underline">削除</button>
      </div>
    </div>
  `;
}

  function viewHistory() {
    const logs = getLogs();
    if (logs.length === 0) {
      return `<p class="text-sm text-slate-500">まだ記録がありません。ホームから追加してください。</p>`;
    }
    return `
      <section>
        <h2 class="text-base font-semibold mb-2">全履歴</h2>
        <div class="divide-y">
          ${logs.map(rowToItem).join("")}
        </div>
      </section>
    `;
  }

  function getSettings() { return load(KEYS.SETTINGS, { unit: "kg", theme: "light" }); }
  function setSettings(s) { save(KEYS.SETTINGS, s); }

  function viewSettings() {
    const s = getSettings();
    return `
      <section class="space-y-4">
        <h2 class="text-base font-semibold">設定</h2>
        <label class="block text-sm">
          <span class="block mb-1 text-slate-600">重量の単位</span>
          <select id="set-unit" class="border rounded-lg px-3 py-2">
            <option value="kg" ${s.unit==="kg"?"selected":""}>kg</option>
            <option value="lb" ${s.unit==="lb"?"selected":""}>lb</option>
          </select>
        </label>
        <div class="flex gap-3">
          <button id="btn-save-settings" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium">保存</button>
          <button id="btn-clear-all" class="px-4 py-2 rounded-lg border border-red-300 text-red-700">全データ削除</button>
        </div>
        <p class="text-xs text-slate-500">※ ブラウザのlocalStorageに保存します。端末をまたぐ共有はしません。</p>
      </section>
    `;
  }

  // ====== 描画とイベント ======
  function autofillFromLast() {
    const name = ($("#f-ex").value || "").trim();
    if (!name) return;
    const m = getLastByEx();
    const last = m[name];
    if (!last) return;
    if ($("#f-weight") && ( $("#f-weight").value === "" || Number($("#f-weight").value) === 0 )) {
      $("#f-weight").value = last.weight ?? "";
    }
    if ($("#f-reps") && ( $("#f-reps").value === "" || Number($("#f-reps").value) === 0 )) {
      $("#f-reps").value = last.reps ?? "";
    }
  }

  function adjustField(kind, dir) {
    if (kind === "weight") {
      const unit = getSettings().unit;
      const step = INCREMENTS[unit] ?? 1;
      const cur = Number($("#f-weight").value || 0);
      const next = Math.max(0, (cur + dir * step));
      $("#f-weight").value = (unit === "kg") ? Number(next.toFixed(1)) : Math.round(next);
    } else if (kind === "reps") {
      const cur = Number($("#f-reps").value || 0);
      const next = Math.max(0, (cur + dir * INCREMENTS.reps));
      $("#f-reps").value = Math.round(next);
    }
  }

  function render() {
    hideError();
    const route = currentRoute();
    const root = $("#view");
    root.innerHTML =
      route === "home" ? viewHome() :
      route === "history" ? viewHistory() :
      viewSettings();

    if (route === "home") {
      $("#btn-add").addEventListener("click", onAdd);
      $("#btn-add-dup").addEventListener("click", onAddDuplicate);
      $("#btn-clear").addEventListener("click", onClearInputs);
      renderRecent();

      // ここ！
      updateExerciseOptionsByPart();

      $("#f-part").addEventListener("change", () => {
        const p = $("#f-part").value;
        setLastPart(p);
        updateExerciseOptionsByPart();
        $("#f-ex").value = "";
        $("#f-ex").focus();
      });

      $("#f-ex").addEventListener("change", autofillFromLast);
      $("#f-ex").addEventListener("blur",  autofillFromLast);

      $$("button[data-inc]").forEach(b => {
        b.addEventListener("click", () => adjustField(b.getAttribute("data-inc"), +1));
      });
      $$("button[data-dec]").forEach(b => {
        b.addEventListener("click", () => adjustField(b.getAttribute("data-dec"), -1));
      });

      document.getElementById("fab-add")?.addEventListener("click", onAdd);
      document.getElementById("fab-dup")?.addEventListener("click", onAddDuplicate);

      bindHomeAutoFocus();
      setActionBarVisible(true);
    }

    highlightTab();
  }
  
  function bindItemButtons(scope=document) {
  $$('button[data-del]', scope).forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del");
      removeLog(id);
      render();
    });
  });
  $$('button[data-edit]', scope).forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-edit");
      renderEditRow(id);
    });
  });
}

  function onAdd() {
    const date = $("#f-date").value || new Date().toISOString().slice(0,10);
    const exercise = ($("#f-ex").value || "").trim();
    const weight = Number($("#f-weight").value || 0);
    const reps = Number($("#f-reps").value || 0);
    const note = ($("#f-note").value || "").trim();

    if (!exercise) { showError("種目を入力してください。"); return; }
    if (!(weight >= 0)) { showError("重量を数値で入力してください。"); return; }
    if (!(reps > 0)) { showError("回数を1以上で入力してください。"); return; }

    // lb表示対応（保存はkg基準でも可。今回は単純に表示単位で保存）
    const s = getSettings();
    addLog({ date, exercise, weight, reps, note, unit: s.unit });
    
    pushRecent(exercise);
    rememberLast(exercise, { weight, reps, unit: s.unit });
    
    onClearInputs();
    renderRecent();
  }

  function onAddDuplicate() {
    const dateEl = $("#f-date");
    const exEl   = $("#f-ex");
    const wEl    = $("#f-weight");
    const rEl    = $("#f-reps");
    const noteEl = $("#f-note");

    const date = (dateEl?.value || new Date().toISOString().slice(0,10));
    const exercise = (exEl?.value || "").trim();

    if (!exercise) { showError("種目が未入力です。先に種目を選ぶか入力してください。"); return; }

    // 1) まず現在の入力値を使う
    let weight = Number(wEl?.value || NaN);
    let reps   = Number(rEl?.value || NaN);
    let note   = (noteEl?.value || "").trim();

    // 2) 空/0/NaNなら、その種目の直近値で補完
    const last = getLastByEx()[exercise];
    if (!(weight >= 0)) weight = last?.weight ?? 0;
    if (!(reps > 0))    reps   = last?.reps   ?? 0;

    // 3) バリデーション
    if (!(weight >= 0)) { showError("重量が未入力です。現在の入力か直近値を用意してください。"); return; }
    if (!(reps > 0))    { showError("回数が未入力です。現在の入力か直近値を用意してください。"); return; }

    const s = getSettings();
    addLog({ date, exercise, weight, reps, note, unit: s.unit });

    // 最近一覧・直近値を更新
    pushRecent(exercise);
    rememberLast(exercise, { weight, reps, unit: s.unit });

    // 入力はそのままにしておく（連打で同じ内容を量産できる）
    renderRecent();
  }
  
  function onClearInputs() {
    ["#f-ex","#f-weight","#f-reps","#f-note"].forEach(id => { const el = $(id); if (el) el.value = ""; });
  }

  function onSaveSettings() {
    const unit = $("#set-unit").value;
    setSettings({ ...getSettings(), unit });
    hideError();
    alert("保存しました。");
  }

  function onClearAll() {
    if (!confirm("本当に全ての記録を削除しますか？この操作は元に戻せません。")) return;
    setLogs([]);
    render();
  }

  function setActionBarVisible(v) {
    const bar = document.getElementById('actionbar');
    if (!bar) return;
    bar.classList.toggle('hidden', !v);
  }

  function bindHomeAutoFocus() {
    // ホーム入場時はまず「種目」へ
    $("#f-ex")?.focus();

    // 種目が確定したら重量へ
    $("#f-ex")?.addEventListener("change", () => $("#f-weight")?.focus());
    $("#f-ex")?.addEventListener("blur",   () => $("#f-weight")?.focus());

    // 重量が入ったら回数へ
    $("#f-weight")?.addEventListener("change", () => $("#f-reps")?.focus());
    $("#f-weight")?.addEventListener("blur",   () => {
      if ($("#f-weight")?.value !== "") $("#f-reps")?.focus();
    });

    // 回数が入ったらメモへ
    $("#f-reps")?.addEventListener("change", () => $("#f-note")?.focus());
    $("#f-reps")?.addEventListener("blur",   () => {
      if ($("#f-reps")?.value !== "") $("#f-note")?.focus();
    });
  }

  function highlightTab() {
    const route = currentRoute();
    $$(".tab").forEach(b => {
      const active = b.getAttribute("data-tab") === route;
      b.classList.toggle("text-blue-600", active);
      b.classList.toggle("border-t-2", active);
      b.classList.toggle("border-blue-600", active);
      b.classList.toggle("bg-blue-50/50", active);
      b.onclick = () => navigate(b.getAttribute("data-tab"));
    });
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // 初回起動
  function renderEditRow(id) {
  const logs = getLogs();
  const row = logs.find(r => r.id === id);
  if (!row) return;

  const el = document.querySelector(`[data-row="${id}"]`);
  if (!el) return;

  const unit = row.unit ?? getSettings().unit;
  el.innerHTML = `
    <div class="w-full grid grid-cols-2 gap-2 items-end">
      <label class="col-span-2 text-xs">
        <span class="block mb-1 text-slate-600">日付</span>
        <input id="e-date-${id}" type="date" value="${row.date}" class="w-full border rounded-lg px-2 py-1">
      </label>
      <label class="col-span-2 text-xs">
        <span class="block mb-1 text-slate-600">種目</span>
        <input id="e-ex-${id}" type="text" value="${escapeHtml(row.exercise)}" class="w-full border rounded-lg px-2 py-1">
      </label>
      <label class="text-xs">
        <span class="block mb-1 text-slate-600">重量</span>
        <input id="e-weight-${id}" type="number" inputmode="decimal" value="${row.weight}" class="w-full border rounded-lg px-2 py-1">
      </label>
      <label class="text-xs">
        <span class="block mb-1 text-slate-600">回数</span>
        <input id="e-reps-${id}" type="number" inputmode="numeric" value="${row.reps}" class="w-full border rounded-lg px-2 py-1">
      </label>
      <label class="col-span-2 text-xs">
        <span class="block mb-1 text-slate-600">メモ</span>
        <input id="e-note-${id}" type="text" value="${escapeHtml(row.note ?? '')}" class="w-full border rounded-lg px-2 py-1">
      </label>
      <label class="text-xs">
        <span class="block mb-1 text-slate-600">単位</span>
        <select id="e-unit-${id}" class="w-full border rounded-lg px-2 py-1">
          <option value="kg" ${unit==='kg'?'selected':''}>kg</option>
          <option value="lb" ${unit==='lb'?'selected':''}>lb</option>
        </select>
      </label>
      <div class="col-span-1 flex gap-2 justify-end">
        <button data-save="${id}" class="px-3 py-1 rounded bg-blue-600 text-white text-xs">保存</button>
        <button data-cancel="${id}" class="px-3 py-1 rounded border text-xs">キャンセル</button>
      </div>
    </div>
  `;

  el.querySelector(`[data-save="${id}"]`).addEventListener('click', () => saveEditRow(id));
  el.querySelector(`[data-cancel="${id}"]`).addEventListener('click', () => render());
}

function saveEditRow(id) {
  const logs = getLogs();
  const i = logs.findIndex(r => r.id === id);
  if (i === -1) return;

  const v = (sel) => document.querySelector(sel)?.value ?? '';
  const date = v(`#e-date-${id}`) || new Date().toISOString().slice(0,10);
  const exercise = v(`#e-ex-${id}`).trim();
  const weight = Number(v(`#e-weight-${id}`));
  const reps = Number(v(`#e-reps-${id}`));
  const note = v(`#e-note-${id}`).trim();
  const unit = v(`#e-unit-${id}`) || (logs[i].unit ?? getSettings().unit);

  if (!exercise) { showError("種目は必須です"); return; }
  if (!(weight >= 0)) { showError("重量は数値で入力してください"); return; }
  if (!(reps > 0)) { showError("回数は1以上で入力してください"); return; }

  logs[i] = { ...logs[i], date, exercise, weight, reps, note, unit };
  setLogs(logs);
  render();
}
  render();
  </script>
</body>
</html>
