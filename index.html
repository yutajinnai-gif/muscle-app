<!DOCTYPE html>


<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>筋トレ記録アプリ | BUILD_TAG=FULL-20250928</title>
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    input, select, textarea, button { font-size: 16px; }
    .scroll-y { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .tab-active { color: rgb(31 41 55); }
    .tab-inactive { color: rgb(156 163 175); }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }
    .modal-card { max-width: 560px; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,.08); }
    main { padding-bottom: 96px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="error-bar" class="fixed top-0 left-0 right-0 z-50 hidden">
    <div class="bg-red-600 text-white px-4 py-2 text-sm flex items-start gap-3">
      <span class="font-semibold">Script error</span>
      <span id="error-text" class="flex-1"></span>
      <button id="error-close" class="underline">閉じる</button>
    </div>
  </div>


  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold">筋トレ記録</h1>
      <div class="text-xs text-gray-500">PWA / Local-only</div>
    </div>
  </header>


  <main id="app" class="max-w-3xl mx-auto px-4 py-4 space-y-4">
    <!-- Router views -->
    <section id="view-home" class="hidden">
      <div class="grid grid-cols-3 gap-2">
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="胸">胸</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="背中">背中</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="肩">肩</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="腕">腕</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="脚">脚</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="腹筋">腹筋</button>
      </div>


  <div class="mt-4 grid grid-cols-2 gap-3">
    <div class="rounded-2xl border bg-white p-3 shadow-soft">
      <div class="text-xs text-gray-500">直近1週間のトレ日数</div>
      <div id="stat-week" class="text-2xl font-bold">0</div>
    </div>
    <div class="rounded-2xl border bg-white p-3 shadow-soft">
      <div class="text-xs text-gray-500">直近1ヶ月のトレ日数</div>
      <div id="stat-month" class="text-2xl font-bold">0</div>
    </div>
  </div>

  <div class="mt-4 flex items-center justify-between">
    <div class="text-sm text-gray-600">本日の記録</div>
    <div class="flex gap-2">
      <button id="btn-add-block" class="px-3 py-2 rounded-xl bg-gray-900 text-white">ブロック追加</button>
      <button id="btn-save-workout" class="px-3 py-2 rounded-xl bg-white border">保存</button>
    </div>
  </div>

  <div id="blocks" class="space-y-3"></div>
</section>

<section id="view-history" class="hidden">
  <div class="rounded-2xl border bg-white p-3 shadow-soft space-y-3">
    <div class="grid grid-cols-2 gap-2">
      <div>
        <label class="text-xs text-gray-500">開始日</label>
        <input id="filter-start" type="date" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div>
        <label class="text-xs text-gray-500">終了日</label>
        <input id="filter-end" type="date" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div>
        <label class="text-xs text-gray-500">部位</label>
        <select id="filter-part" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div>
        <label class="text-xs text-gray-500">種目名</label>
        <select id="filter-ex" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div>
        <label class="text-xs text-gray-500">器具</label>
        <select id="filter-eq" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div>
        <label class="text-xs text-gray-500">アタッチメント</label>
        <select id="filter-att" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div>
        <label class="text-xs text-gray-500">角度</label>
        <select id="filter-ang" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
    </div>
    <div class="flex gap-2">
      <button id="btn-apply-filter" class="px-3 py-2 rounded-xl bg-gray-900 text-white">絞り込み</button>
      <button id="btn-clear-filter" class="px-3 py-2 rounded-xl bg-white border">クリア</button>
    </div>
  </div>

  <div id="history-chart-wrap" class="rounded-2xl border bg-white p-3 shadow-soft mt-3 hidden">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-gray-600">1RM推移</div>
      <button id="btn-back-to-home-from-simple" class="px-3 py-1.5 rounded-lg border hidden">入力画面に戻る</button>
    </div>
    <canvas id="history-chart" height="160"></canvas>
  </div>

  <div id="history-list" class="mt-3 space-y-3"></div>
</section>

<section id="view-settings" class="hidden">
  <div class="rounded-2xl border bg-white p-3 shadow-soft space-y-4">
    <div>
      <div class="text-sm font-semibold mb-1">リスト編集</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-gray-500">部位（1行1項目）</label>
          <textarea id="list-parts" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">種目名（1行1項目）</label>
          <textarea id="list-exercises" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">器具（1行1項目）</label>
          <textarea id="list-equip" rows="4" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">アタッチメント（1行1項目）</label>
          <textarea id="list-attach" rows="4" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">角度（1行1項目）</label>
          <textarea id="list-angle" rows="4" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="btn-save-lists" class="px-3 py-2 rounded-xl bg-gray-900 text-white">保存</button>
        <button id="btn-reset-defaults" class="px-3 py-2 rounded-xl bg-white border">デフォルト復元</button>
      </div>
    </div>

    <div class="border-t pt-3">
      <div class="text-sm font-semibold mb-1">データ管理</div>
      <div class="flex flex-wrap gap-2">
        <button id="btn-export-csv" class="px-3 py-2 rounded-xl bg-white border">CSVエクスポート</button>
        <label class="px-3 py-2 rounded-xl bg-white border cursor-pointer">
          CSVインポート
          <input id="input-import-csv" type="file" accept=".csv,text/csv" class="hidden">
        </label>
        <button id="btn-clear-data" class="px-3 py-2 rounded-xl bg-red-50 text-red-700 border border-red-200">全データ削除</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">CSV列: date,part,exercise,equipment,attachment,angle,setIndex,warmup,weight,repsSelf,repsAssist,note,oneRM</p>
    </div>
  </div>
  <div class="rounded-2xl border bg-white p-3 shadow-soft">
    <div class="text-sm font-semibold mb-2">PWA（オフライン対応）</div>
    <button id="btn-install" class="px-3 py-2 rounded-xl bg-white border">ホーム画面に追加</button>
    <span id="pwa-status" class="ml-2 text-xs text-gray-500"></span>
  </div>
</section>

  </main>


  <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-gray-200">
    <div class="max-w-3xl mx-auto px-6">
      <div class="grid grid-cols-3">
        <button data-route="#/home" class="tab-btn flex flex-col items-center py-2 gap-0.5">
          <span class="text-base">🏠</span>
          <span class="text-xs">ホーム</span>
        </button>
        <button data-route="#/history" class="tab-btn flex flex-col items-center py-2 gap-0.5">
          <span class="text-base">🗂️</span>
          <span class="text-xs">履歴</span>
        </button>
        <button data-route="#/settings" class="tab-btn flex flex-col items-center py-2 gap-0.5">
          <span class="text-base">⚙️</span>
          <span class="text-xs">設定</span>
        </button>
      </div>
    </div>
  </nav>


  <template id="tpl-block">
    <div class="block-card rounded-2xl border bg-white p-3 shadow-soft space-y-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">ブロック</span>
          <span class="block-index text-sm font-semibold">#1</span>
        </div>
        <div class="flex gap-2">
          <button class="btn-add-ex px-2 py-1.5 rounded-lg border text-sm">連続種目を追加</button>
          <button class="btn-del-block px-2 py-1.5 rounded-lg border border-red-200 text-red-700 text-sm">削除</button>
        </div>
      </div>
      <div class="ex-list space-y-2"></div>
    </div>
  </template>


  <template id="tpl-exercise">
    <div class="ex-card rounded-xl border p-2 bg-gray-50">
      <div class="flex items-start justify-between gap-2">
        <div class="flex-1">
          <div class="flex flex-wrap items-center gap-1 text-sm">
            <select class="ex-name border rounded-md px-2 py-1"></select>
            <select class="ex-eq border rounded-md px-2 py-1"></select>
            <select class="ex-att border rounded-md px-2 py-1"></select>
            <select class="ex-ang border rounded-md px-2 py-1"></select>
          </div>
          <div class="mt-1 text-[11px] text-gray-500 ex-meta">最高重量: - / 最高1RM: - / 前回: -</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn-ex-history px-2 py-1.5 rounded-md border text-xs">履歴</button>
          <button class="btn-del-ex px-2 py-1.5 rounded-md border border-red-200 text-red-700 text-xs">削除</button>
        </div>
      </div>
      <div class="mt-2 space-y-1 set-list"></div>
      <div class="mt-2">
        <button class="btn-add-set px-2 py-1.5 rounded-md bg-white border text-sm">セット追加</button>
      </div>
    </div>
  </template>


  <template id="tpl-set-row">
    <div class="set-row grid grid-cols-12 gap-1 items-center">
      <label class="col-span-2 inline-flex items-center gap-1 text-xs">
        <input type="checkbox" class="set-warm border rounded">
        <span>W-Up</span>
      </label>
      <input type="number" inputmode="decimal" placeholder="重量" class="set-weight col-span-2 border rounded px-2 py-1" />
      <input type="number" inputmode="numeric" placeholder="自力" class="set-reps col-span-2 border rounded px-2 py-1" />
      <input type="number" inputmode="numeric" placeholder="補助" class="set-assist col-span-2 border rounded px-2 py-1" />
      <input type="text" placeholder="メモ" class="set-note col-span-3 border rounded px-2 py-1" />
      <button class="btn-del-set col-span-1 px-2 py-1 rounded border text-xs">×</button>
      <div class="col-span-12 text-[11px] text-gray-500">推定1RM: <span class="set-1rm">-</span> kg</div>
    </div>
  </template>


  <script>
    // --- Error Bar ---
    (function setupErrorBar(){
      const bar = document.getElementById('error-bar');
      const text = document.getElementById('error-text');
      const close = document.getElementById('error-close');
      function showError(message){ text.textContent = String(message || 'Unknown error'); bar.classList.remove('hidden'); }
      window.addEventListener('error', (e)=>{ showError(e.message); });
      window.addEventListener('unhandledrejection', (e)=>{ showError(e.reason && e.reason.message ? e.reason.message : e.reason); });
      close.addEventListener('click', ()=> bar.classList.add('hidden'));
      window.__forceError = () => { throw new Error('Forced error for testing'); };
    })();

    // --- Utilities ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const debounce = (fn, ms=300) => {
      let t; return (...args)=> { clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    };
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const toCSV = (rows)=> rows.map(r => r.map(v => {
      const s = v == null ? '' : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');

    // --- Storage (namespaced + schema) ---
    const SCHEMA_VERSION = 1;
    const NS = 'workout-app';
    const store = {
      get(key, d=null){ try { const raw = localStorage.getItem(NS+':'+key); if(!raw) return d; const obj = JSON.parse(raw); return obj && obj.v===SCHEMA_VERSION ? obj.data : d; } catch { return d; } },
      set(key, data){ localStorage.setItem(NS+':'+key, JSON.stringify({v:SCHEMA_VERSION, data})); },
      clearAll(){ Object.keys(localStorage).filter(k=>k.startsWith(NS+':')).forEach(k=>localStorage.removeItem(k)); }
    };

    // --- Defaults ---
    const DEFAULTS = {
      parts: ['胸','背中','肩','腕','脚','腹筋'],
      exercises: ['ベンチプレス','インクラインダンベルプレス','ラットプルダウン','スクワット','デッドリフト','ショルダープレス','バイセプカール','トライセプスプレスダウン','レッグプレス','クランチ'],
      equip: ['バーベル','ダンベル','マシン','ケーブル','自重'],
      attach: ['ストレートバー','Vバー','ロープ','Dハンドル','なし'],
      angle: ['フラット','インクライン','デクライン','ナチュラル']
    };

    // --- App State ---
    const state = {
      lists: null,
      workouts: null,  // [{id, date, part, blocks:[{exs:[{name, eq, att, ang, sets:[{warm, w, reps, assist, note, oneRM}], meta: {}}]}]}]
      inProgress: null, // current editing session
      chart: null,
      pwaPrompt: null
    };

    function initData(){
      let lists = store.get('lists');
      if(!lists){ lists = JSON.parse(JSON.stringify(DEFAULTS)); store.set('lists', lists); }
      state.lists = lists;

      let workouts = store.get('workouts', []);
      state.workouts = workouts;

      let inProgress = store.get('inProgress', { date: todayISO(), part: '胸', blocks: [] });
      if(!inProgress.date) inProgress.date = todayISO();
      state.inProgress = inProgress;
    }

    function persist(){
      store.set('lists', state.lists);
      store.set('workouts', state.workouts);
      store.set('inProgress', state.inProgress);
    }

    // --- Router ---
    const routes = ['#/home','#/history','#/settings'];
    function setActiveTab(hash){
      $$('.tab-btn').forEach(btn=>{
        const active = btn.getAttribute('data-route') === hash;
        btn.classList.toggle('tab-active', active);
        btn.classList.toggle('tab-inactive', !active);
      });
    }
    function renderRoute(){
      const hash = location.hash || '#/home';
      $('#view-home').classList.add('hidden');
      $('#view-history').classList.add('hidden');
      $('#view-settings').classList.add('hidden');
      if(hash.startsWith('#/home')) { $('#view-home').classList.remove('hidden'); renderHome(); }
      else if(hash.startsWith('#/history')) { $('#view-history').classList.remove('hidden'); renderHistory(); }
      else { $('#view-settings').classList.remove('hidden'); renderSettings(); }
      setActiveTab(hash);
    }
    window.addEventListener('hashchange', renderRoute);

    // --- 1RM (Epley) ---
    function calc1RM(weight, reps){
      const w = Number(weight||0), r = Number(reps||0);
      if(w<=0 || r<=0) return 0;
      return Math.round(w * (1 + r/30) * 10) / 10;
    }

    // --- Stats ---
    function computeTrainingDays(rangeDays){
      const cutoff = Date.now() - rangeDays*24*3600*1000;
      const days = new Set(state.workouts.filter(w => new Date(w.date).getTime() >= cutoff).map(w => w.date));
      return days.size;
    }

    // --- Home Rendering ---
    function renderHome(){
      // Stats
      $('#stat-week').textContent = computeTrainingDays(7);
      $('#stat-month').textContent = computeTrainingDays(30);

      // Part buttons
      $$('.part-btn').forEach(b=>{
        b.classList.toggle('bg-gray-900', state.inProgress.part===b.dataset.part);
        b.classList.toggle('text-white', state.inProgress.part===b.dataset.part);
        b.classList.toggle('bg-white', state.inProgress.part!==b.dataset.part);
        b.classList.toggle('text-gray-900', state.inProgress.part!==b.dataset.part);
        b.onclick = ()=>{ state.inProgress.part = b.dataset.part; persist(); renderHome(); };
      });

      // Blocks
      const wrap = $('#blocks');
      wrap.innerHTML = '';
      state.inProgress.blocks.forEach((block, idx)=>{
        const node = document.importNode($('#tpl-block').content, true);
        const card = node.querySelector('.block-card');
        card.dataset.index = idx;
        node.querySelector('.block-index').textContent = '#'+(idx+1);
        node.querySelector('.btn-del-block').onclick = async ()=>{
          if(await confirmAction('ブロックを削除しますか？')) {
            state.inProgress.blocks.splice(idx,1);
            persist(); renderHome();
          }
        };
        node.querySelector('.btn-add-ex').onclick = ()=> addExercise(idx);
        const exList = node.querySelector('.ex-list');
        block.exs.forEach((ex, exIdx)=>{
          exList.appendChild(renderExercise(block, idx, ex, exIdx));
        });
        wrap.appendChild(node);
      });
    }

    function addBlock(){
      state.inProgress.blocks.push({ exs: [] });
      persist(); renderHome();
      scrollToBottom();
    }

    function addExercise(blockIdx){
      const block = state.inProgress.blocks[blockIdx];
      const ex = { name: state.lists.exercises[0] || '', eq: state.lists.equip[0] || '', att: state.lists.attach[0] || '', ang: state.lists.angle[0] || '', sets: [] };
      block.exs.push(ex);
      persist(); renderHome();
    }

    function renderExercise(block, blockIdx, ex, exIdx){
      const node = document.importNode($('#tpl-exercise').content, true);
      const root = node.querySelector('.ex-card');
      root.dataset.block = blockIdx;
      root.dataset.ex = exIdx;

      fillSelect(node.querySelector('.ex-name'), state.lists.exercises, ex.name, (v)=>{ ex.name=v; persist(); updateExMeta(root, ex); });
      fillSelect(node.querySelector('.ex-eq'), state.lists.equip, ex.eq, (v)=>{ ex.eq=v; persist(); });
      fillSelect(node.querySelector('.ex-att'), state.lists.attach, ex.att, (v)=>{ ex.att=v; persist(); });
      fillSelect(node.querySelector('.ex-ang'), state.lists.angle, ex.ang, (v)=>{ ex.ang=v; persist(); });

      node.querySelector('.btn-del-ex').onclick = async ()=>{
        if(await confirmAction('この種目を削除しますか？')) {
          block.exs.splice(exIdx,1);
          persist(); renderHome();
        }
      };
      node.querySelector('.btn-ex-history').onclick = ()=> openExerciseHistoryModal(ex.name);

      const setList = node.querySelector('.set-list');
      ex.sets.forEach((s, idx)=> setList.appendChild(renderSetRow(ex, s, idx)));
      const btnAddSet = node.querySelector('.btn-add-set');
      btnAddSet.onclick = ()=> {
        ex.sets.push({ warm:false, w:'', reps:'', assist:'', note:'', oneRM:0 });
        persist(); renderHome();
        setTimeout(scrollToBottom, 0);
      };

      updateExMeta(root, ex);
      return node;
    }

    function fillSelect(sel, items, value, onChange){
      sel.innerHTML = '';
      items.forEach(v=>{
        const opt = document.createElement('option'); opt.value = v; opt.textContent = v; sel.appendChild(opt);
      });
      sel.value = value || '';
      sel.onchange = (e)=> onChange(e.target.value);
    }

    function renderSetRow(ex, s, setIdx){
      const node = document.importNode($('#tpl-set-row').content, true);
      const warm = node.querySelector('.set-warm');
      const weight = node.querySelector('.set-weight');
      const reps = node.querySelector('.set-reps');
      const assist = node.querySelector('.set-assist');
      const note = node.querySelector('.set-note');
      const oneElm = node.querySelector('.set-1rm');

      warm.checked = !!s.warm;
      weight.value = s.w ?? s.w;
      reps.value = s.reps ?? s.reps;
      assist.value = s.assist ?? s.assist;
      note.value = s.note ?? s.note;
      oneElm.textContent = s.oneRM ? s.oneRM : '-';

      const recalc = debounce(()=>{
        const one = calc1RM(weight.value, reps.value);
        oneElm.textContent = one ? one : '-';
        s.warm = warm.checked;
        s.w = weight.value;
        s.reps = reps.value;
        s.assist = assist.value;
        s.note = note.value;
        s.oneRM = one;
        persist();
      }, 250);

      [warm, weight, reps, assist, note].forEach(el=> el.addEventListener('input', recalc));
      node.querySelector('.btn-del-set').onclick = ()=> {
        const idx = ex.sets.indexOf(s);
        if(idx>=0){ ex.sets.splice(idx,1); persist(); renderHome(); }
      };
      return node;
    }

    function updateExMeta(root, ex){
      const meta = root.querySelector('.ex-meta');
      const all = flattenSets().filter(r => r.exercise === ex.name);
      if(all.length===0){ meta.textContent = '最高重量: - / 最高1RM: - / 前回: -'; return; }
      const maxW = Math.max(...all.map(r=> Number(r.weight||0)));
      const max1 = Math.max(...all.map(r=> Number(r.oneRM||0)));
      const last = all.sort((a,b)=> a.date<b.date ? 1 : -1)[0];
      meta.textContent = `最高重量: ${maxW||'-'} / 最高1RM: ${max1||'-'} / 前回: ${last ? last.date : '-'}`;
    }

    function scrollToBottom(){ window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }

    // --- Save workout ---
    function saveWorkout(){
      // prune empty sets/exercises/blocks
      const copy = JSON.parse(JSON.stringify(state.inProgress));
      copy.blocks.forEach(b => { b.exs.forEach(ex => { ex.sets = ex.sets.filter(s=> (Number(s.w)>0 && Number(s.reps)>0) || s.note); }); b.exs = b.exs.filter(ex=> ex.sets.length>0); });
      copy.blocks = copy.blocks.filter(b=> b.exs.length>0);
      if(copy.blocks.length===0){ alert('記録が空です。セットを入力してください。'); return; }
      copy.id = 'w_'+Date.now();
      state.workouts.push(copy);
      // reset inProgress to fresh day
      state.inProgress = { date: todayISO(), part: state.inProgress.part, blocks: [] };
      persist();
      alert('保存しました');
      renderHome();
    }

    // --- History ---
    function renderHistory(){
      // fill filters
      const parts = ['(指定なし)', ...state.lists.parts];
      const exs = ['(指定なし)', ...unique(flattenSets().map(r=>r.exercise)).sort()];
      const eqs = ['(指定なし)', ...state.lists.equip];
      const atts = ['(指定なし)', ...state.lists.attach];
      const angs = ['(指定なし)', ...state.lists.angle];
      fillSelect($('#filter-part'), parts, '(指定なし)', ()=>{});
      fillSelect($('#filter-ex'), exs, '(指定なし)', ()=>{});
      fillSelect($('#filter-eq'), eqs, '(指定なし)', ()=>{});
      fillSelect($('#filter-att'), atts, '(指定なし)', ()=>{});
      fillSelect($('#filter-ang'), angs, '(指定なし)', ()=>{});

      $('#btn-apply-filter').onclick = ()=> applyFilter();
      $('#btn-clear-filter').onclick = ()=> { $('#filter-start').value=''; $('#filter-end').value=''; ['part','ex','eq','att','ang'].forEach(id=> $('#filter-'+id).value='(指定なし)'); applyFilter(); };

      // route param ?exercise=Name triggers simple mode
      const params = new URLSearchParams(location.hash.split('?')[1] || '');
      const exParam = params.get('exercise');
      if(exParam){ $('#filter-ex').value = exParam; }

      applyFilter();
    }

    function unique(arr){ return Array.from(new Set(arr)); }

    function flattenSets(){
      const rows = [];
      state.workouts.forEach(w=>{
        w.blocks.forEach((b, bi)=>{
          b.exs.forEach(ex=>{
            ex.sets.forEach((s, si)=>{
              rows.push({
                id: w.id,
                date: w.date,
                part: w.part,
                exercise: ex.name,
                equipment: ex.eq,
                attachment: ex.att,
                angle: ex.ang,
                setIndex: si+1,
                warmup: !!s.warm,
                weight: Number(s.w||0),
                repsSelf: Number(s.reps||0),
                repsAssist: Number(s.assist||0),
                note: s.note || '',
                oneRM: Number(s.oneRM||0)
              });
            });
          });
        });
      });
      return rows.sort((a,b)=> a.date<b.date ? -1 : 1);
    }

    function applyFilter(){
      const start = $('#filter-start').value;
      const end = $('#filter-end').value;
      const part = $('#filter-part').value;
      const ex = $('#filter-ex').value;
      const eq = $('#filter-eq').value;
      const att = $('#filter-att').value;
      const ang = $('#filter-ang').value;

      let rows = flattenSets();
      if(start) rows = rows.filter(r => r.date >= start);
      if(end) rows = rows.filter(r => r.date <= end);
      if(part && part!=='(指定なし)') rows = rows.filter(r => r.part===part);
      if(ex && ex!=='(指定なし)') rows = rows.filter(r => r.exercise===ex);
      if(eq && eq!=='(指定なし)') rows = rows.filter(r => r.equipment===eq);
      if(att && att!=='(指定なし)') rows = rows.filter(r => r.attachment===att);
      if(ang && ang!=='(指定なし)') rows = rows.filter(r => r.angle===ang);

      renderHistoryList(rows);

      // Chart: only when a single exercise is specified
      if(ex && ex!=='(指定なし)'){
        const dailyMax = aggregateDailyMax1RM(rows);
        renderChart(dailyMax.labels, dailyMax.values, true);
      } else {
        renderChart([], [], false);
      }
    }

    function aggregateDailyMax1RM(rows){
      const map = new Map();
      rows.forEach(r=>{
        const key = r.date;
        const prev = map.get(key) || 0;
        map.set(key, Math.max(prev, r.oneRM||0));
      });
      const labels = Array.from(map.keys()).sort();
      const values = labels.map(d => map.get(d));
      return { labels, values };
    }

    function renderHistoryList(rows){
      const list = $('#history-list');
      list.innerHTML = '';
      if(rows.length===0){
        list.innerHTML = '<div class="text-sm text-gray-500">データがありません。</div>';
        return;
      }

      const byWorkout = rows.reduce((acc, r)=>{
        (acc[r.id] ||= []).push(r);
        return acc;
      }, {});
      Object.values(byWorkout).forEach(items=>{
        const w = items[0];
        const card = document.createElement('div');
        card.className = 'rounded-2xl border bg-white p-3 shadow-soft';
        const title = document.createElement('div');
        title.className = 'flex items-center justify-between';
        title.innerHTML = `<div class="text-sm font-semibold">${w.date} / ${w.part}</div>`;
        card.appendChild(title);
        items.forEach(r=>{
          const row = document.createElement('div');
          row.className = 'mt-2 text-sm grid grid-cols-12 gap-1';
          row.innerHTML = `
            <div class="col-span-5 truncate-2">${r.exercise} <span class="text-xs text-gray-500">(${r.equipment} / ${r.attachment} / ${r.angle})</span></div>
            <div class="col-span-3">重量 ${r.weight}kg</div>
            <div class="col-span-2">自 ${r.repsSelf}</div>
            <div class="col-span-2">補 ${r.repsAssist}</div>
            <div class="col-span-12 text-[11px] text-gray-500">1RM: ${r.oneRM || '-'}kg / S${r.setIndex} ${r.note ? ' / '+escapeHtml(r.note) : ''}</div>
          `;
          card.appendChild(row);
        });
        list.appendChild(card);
      });

      // If route had ?exercise, show back button
      const params = new URLSearchParams(location.hash.split('?')[1] || '');
      const exParam = params.get('exercise');
      const backBtn = $('#btn-back-to-home-from-simple');
      backBtn.classList.toggle('hidden', !exParam);
      backBtn.onclick = ()=> { location.hash = '#/home'; };
    }

    // --- Chart ---
    function renderChart(labels, values, show){
      const wrap = $('#history-chart-wrap');
      wrap.classList.toggle('hidden', !show);
      if(!show){
        if(state.chart){ state.chart.destroy(); state.chart=null; }
        return;
      }
      const ctx = $('#history-chart').getContext('2d');
      if(state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: '1RM (kg)', data: values, tension: 0.25, pointRadius: 3 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    }

    // --- Settings ---
    function renderSettings(){
      $('#list-parts').value = state.lists.parts.join('\n');
      $('#list-exercises').value = state.lists.exercises.join('\n');
      $('#list-equip').value = state.lists.equip.join('\n');
      $('#list-attach').value = state.lists.attach.join('\n');
      $('#list-angle').value = state.lists.angle.join('\n');
    }

    function saveLists(){
      const parseLines = (v)=> v.split('\n').map(s=>s.trim()).filter(Boolean);
      state.lists.parts = parseLines($('#list-parts').value);
      state.lists.exercises = parseLines($('#list-exercises').value);
      state.lists.equip = parseLines($('#list-equip').value);
      state.lists.attach = parseLines($('#list-attach').value);
      state.lists.angle = parseLines($('#list-angle').value);
      persist();
      alert('保存しました');
    }

    function resetDefaults(){
      state.lists = JSON.parse(JSON.stringify(DEFAULTS));
      persist();
      renderSettings();
      alert('デフォルトに復元しました');
    }

    // --- CSV Export/Import ---
    function exportCSV(){
      const rows = flattenSets().map(r=>[
        r.date, r.part, r.exercise, r.equipment, r.attachment, r.angle, r.setIndex,
        r.warmup ? 1 : 0, r.weight, r.repsSelf, r.repsAssist, r.note, r.oneRM
      ]);
      rows.unshift(['date','part','exercise','equipment','attachment','angle','setIndex','warmup','weight','repsSelf','repsAssist','note','oneRM']);
      const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `workouts_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function importCSV(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        const text = reader.result;
        const rows = parseCSV(text);
        const header = rows.shift() || [];
        const idx = (name)=> header.indexOf(name);
        const dateI = idx('date'), partI=idx('part'), exI=idx('exercise'), eqI=idx('equipment'), attI=idx('attachment'), angI=idx('angle'),
              warmI=idx('warmup'), wI=idx('weight'), rsI=idx('repsSelf'), raI=idx('repsAssist'), noteI=idx('note'), oneI=idx('oneRM');
        if(dateI<0 || partI<0 || exI<0){ alert('CSVヘッダが不正です'); return; }
        // Group by date+part -> one workout per day/part
        const groups = {};
        rows.forEach(r=>{
          const date = r[dateI]; if(!date) return;
          const part = r[partI] || '不明';
          const key = date+'|'+part;
          (groups[key] ||= []).push({
            exercise: r[exI]||'',
            equipment: r[eqI]||'',
            attachment: r[attI]||'',
            angle: r[angI]||'',
            warmup: Number(r[warmI]||0)>0,
            weight: Number(r[wI]||0),
            repsSelf: Number(r[rsI]||0),
            repsAssist: Number(r[raI]||0),
            note: r[noteI]||'',
            oneRM: Number(r[oneI]||0)
          });
        });
        Object.entries(groups).forEach(([key, items])=>{
          const [date, part] = key.split('|');
          // group items by exercise/equipment/attachment/angle as a single exercise entry
          const m = new Map();
          items.forEach(it=>{
            const k = [it.exercise,it.equipment,it.attachment,it.angle].join('|');
            (m.get(k) || m.set(k, []).get(k)).push(it);
          });
          const blocks = [{ exs: Array.from(m.entries()).map(([k, arr])=>{
            const [name, eq, att, ang] = k.split('|');
            return { name, eq, att, ang, sets: arr.map((s,i)=>({ warm:s.warmup, w:s.weight, reps:s.repsSelf, assist:s.repsAssist, note:s.note, oneRM: s.oneRM || calc1RM(s.weight, s.repsSelf) })) };
          }) }];
          state.workouts.push({ id:'w_'+Date.now()+Math.random(), date, part, blocks });
        });
        persist();
        alert('インポート完了');
        if(location.hash.startsWith('#/history')) renderHistory();
      };
      reader.readAsText(file);
    }

    function parseCSV(text){
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      while(i<text.length){
        const c = text[i++];
        if(inQuotes){
          if(c === '"'){
            if(text[i] === '"'){ field+='"'; i++; }
            else { inQuotes=false; }
          } else { field += c; }
        } else {
          if(c === '"'){ inQuotes=true; }
          else if(c === ','){ row.push(field); field=''; }
          else if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c === '\r'){ /* ignore */ }
          else { field += c; }
        }
      }
      if(field.length>0 || row.length>0){ row.push(field); rows.push(row); }
      return rows;
    }

    // --- Simple confirm modal ---
    async function confirmAction(message){
      const bg = document.createElement('div');
      bg.className = 'modal-bg flex items-center justify-center';
      const card = document.createElement('div');
      card.className = 'modal-card bg-white rounded-2xl p-4 shadow-soft border';
      card.innerHTML = `
        <div class="text-sm text-gray-700 mb-3">${escapeHtml(message)}</div>
        <div class="flex justify-end gap-2">
          <button class="px-3 py-2 rounded-xl bg-white border">キャンセル</button>
          <button class="px-3 py-2 rounded-xl bg-gray-900 text-white">OK</button>
        </div>
      `;
      bg.appendChild(card);
      document.body.appendChild(bg);
      return new Promise(resolve=>{
        const [btnCancel, btnOk] = card.querySelectorAll('button');
        const cleanup = ()=> bg.remove();
        btnCancel.onclick = ()=> { cleanup(); resolve(false); };
        btnOk.onclick = ()=> { cleanup(); resolve(true); };
        bg.addEventListener('click', (e)=> { if(e.target===bg){ cleanup(); resolve(false); } });
      });
    }

    // --- Exercise simple history modal ---
    function openExerciseHistoryModal(exName){
      const rows = flattenSets().filter(r=> r.exercise===exName);
      const bg = document.createElement('div');
      bg.className = 'modal-bg flex items-center justify-center';
      const card = document.createElement('div');
      card.className = 'modal-card bg-white rounded-2xl p-4 shadow-soft border w-[92vw] max-w-2xl';
      const inner = document.createElement('div');
      inner.innerHTML = `<div class="text-sm font-semibold mb-2">${escapeHtml(exName)} の履歴</div>`;
      const table = document.createElement('div');
      table.className = 'max-h-[60vh] overflow-auto';
      if(rows.length===0){
        table.innerHTML = '<div class="text-sm text-gray-500">データがありません。</div>';
      } else {
        const header = `<div class="grid grid-cols-6 text-xs text-gray-500 border-b pb-1">
          <div>日付</div><div>セット</div><div>重量</div><div>自力</div><div>補助</div><div>1RM</div>
        </div>`;
        const body = rows.map(r=> `<div class="grid grid-cols-6 text-sm py-1 border-b">
          <div>${r.date}</div><div>S${r.setIndex}</div><div>${r.weight}</div><div>${r.repsSelf}</div><div>${r.repsAssist}</div><div>${r.oneRM||'-'}</div>
        </div>`).join('');
        table.innerHTML = header + body;
      }
      const actions = document.createElement('div');
      actions.className = 'flex justify-between items-center mt-3';
      const btnGraph = document.createElement('button');
      btnGraph.className = 'px-3 py-2 rounded-xl bg-white border text-sm';
      btnGraph.textContent = '1RMグラフ表示';
      btnGraph.onclick = ()=> {
        location.hash = '#/history?exercise=' + encodeURIComponent(exName);
        bg.remove();
      };
      const btnClose = document.createElement('button');
      btnClose.className = 'px-3 py-2 rounded-xl bg-gray-900 text-white text-sm';
      btnClose.textContent = '閉じる';
      btnClose.onclick = ()=> bg.remove();
      actions.appendChild(btnGraph);
      actions.appendChild(btnClose);

      card.appendChild(inner);
      card.appendChild(table);
      card.appendChild(actions);
      bg.appendChild(card);
      document.body.appendChild(bg);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // --- PWA minimal (register SW via Blob) ---
    function setupPWA(){
      if('serviceWorker' in navigator){
        const swCode = `
          self.addEventListener('install', (e)=> { self.skipWaiting(); });
          self.addEventListener('activate', (e)=> { e.waitUntil(self.clients.claim()); });
          self.addEventListener('fetch', (event)=> {
            event.respondWith((async ()=>{
              try { return await fetch(event.request); }
              catch { return new Response('<h1>オフライン</h1>', { headers: {'Content-Type':'text/html'} }); }
            })());
          });
        `;
        const blob = new Blob([swCode], {type:'text/javascript'});
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url).then(()=> {
          $('#pwa-status').textContent = '登録済み';
        }).catch(()=> {
          $('#pwa-status').textContent = '登録失敗';
        });
      } else {
        $('#pwa-status').textContent = '非対応';
      }

      let deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', (e)=>{
        e.preventDefault();
        deferredPrompt = e;
        state.pwaPrompt = e;
        $('#pwa-status').textContent = 'インストール可能';
      });
      $('#btn-install').onclick = async ()=>{
        if(state.pwaPrompt){
          state.pwaPrompt.prompt();
          const { outcome } = await state.pwaPrompt.userChoice;
          $('#pwa-status').textContent = outcome==='accepted' ? 'インストール開始' : 'キャンセル';
          state.pwaPrompt = null;
        } else {
          alert('ブラウザの共有/追加メニューからホーム画面に追加してください。');
        }
      };
    }

    // --- Init ---
    function bindGlobalUI(){
      // Tabs
      $$('.tab-btn').forEach(btn=> btn.onclick = ()=> { location.hash = btn.getAttribute('data-route'); });

      // Home actions
      $('#btn-add-block').onclick = addBlock;
      $('#btn-save-workout').onclick = saveWorkout;

      // Settings actions
      $('#btn-save-lists').onclick = saveLists;
      $('#btn-reset-defaults').onclick = resetDefaults;
      $('#btn-export-csv').onclick = exportCSV;
      $('#input-import-csv').addEventListener('change', (e)=> {
        const f = e.target.files && e.target.files[0];
        if(f) importCSV(f);
        e.target.value = '';
      });
      $('#btn-clear-data').onclick = async ()=>{
        if(await confirmAction('本当に全データを削除しますか？（元に戻せません）')){
          store.clearAll();
          initData();
          persist();
          renderRoute();
        }
      };
    }

    // Boot
    initData();
    bindGlobalUI();
    setupPWA();
    if(!location.hash) location.hash = '#/home';
    renderRoute();
  </script>


</body>
</html>
