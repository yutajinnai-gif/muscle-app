<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筋トレ記録アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* iOSでの入力欄ズームを防止 */
        input, select, textarea {
            font-size: 16px;
        }
        /* スクロールバーのスタイル（任意） */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased">

    <div id="app-container" class="max-w-lg mx-auto bg-white min-h-screen pb-20">

        <main id="main-content" class="p-4">
            
            <div id="home-screen">
                <h1 class="text-2xl font-bold mb-4">ホーム</h1>
                <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-gray-200 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">直近7日間</div>
                        <div id="summary-7-days" class="text-2xl font-bold">0日</div>
                    </div>
                    <div class="bg-gray-200 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">直近30日間</div>
                        <div id="summary-30-days" class="text-2xl font-bold">0日</div>
                    </div>
                </div>
                <h2 class="text-xl font-semibold mb-3">部位を選択</h2>
                <div id="part-selection" class="grid grid-cols-2 gap-4">
                    </div>
            </div>
            
            <div id="record-screen" class="hidden">
                 <div class="flex items-center mb-4">
                    <button id="back-to-home-btn" class="mr-4 p-2 text-lg"><i class="fas fa-arrow-left"></i></button>
                    <h1 id="record-title" class="text-2xl font-bold"></h1>
                </div>
                <div id="blocks-container" class="space-y-6">
                    </div>
                <button id="add-block-btn" class="w-full mt-6 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>種目ブロックを追加
                </button>
                <button id="finish-workout-btn" class="w-full mt-4 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>トレーニングを完了
                </button>
            </div>

            <div id="history-screen" class="hidden">
                <h1 class="text-2xl font-bold mb-4">トレーニング履歴</h1>
                <div class="bg-gray-100 p-4 rounded-lg mb-4 space-y-3">
                    <h2 class="font-semibold">絞り込み</h2>
                    <div class="grid grid-cols-2 gap-3">
                         <input type="date" id="filter-start-date" class="p-2 border rounded-lg w-full">
                         <input type="date" id="filter-end-date" class="p-2 border rounded-lg w-full">
                         <select id="filter-part" class="p-2 border rounded-lg w-full"></select>
                         <select id="filter-exercise" class="p-2 border rounded-lg w-full"></select>
                    </div>
                     <button id="apply-filter-btn" class="w-full mt-2 bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600">絞り込む</button>
                </div>
                <div class="mb-4">
                    <canvas id="history-chart"></canvas>
                </div>
                <div id="history-list" class="space-y-4">
                    </div>
            </div>

            <div id="settings-screen" class="hidden">
                <h1 class="text-2xl font-bold mb-6">設定</h1>
                <div id="settings-accordion" class="space-y-4">
                     </div>
                 <div class="mt-8 pt-6 border-t">
                    <h2 class="text-xl font-semibold mb-4">データ管理</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="export-csv-btn" class="bg-green-500 text-white py-3 rounded-lg hover:bg-green-600"><i class="fas fa-file-export mr-2"></i>CSVエクスポート</button>
                        <label for="import-csv-input" class="bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 text-center cursor-pointer"><i class="fas fa-file-import mr-2"></i>CSVインポート</label>
                        <input type="file" id="import-csv-input" class="hidden" accept=".csv">
                    </div>
                </div>
            </div>

        </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t shadow-md">
            <div class="flex justify-around">
                <button data-screen="home" class="nav-btn flex-1 py-3 text-center text-blue-500 border-t-4 border-blue-500">
                    <i class="fas fa-home text-xl"></i>
                    <span class="block text-xs">ホーム</span>
                </button>
                <button data-screen="history" class="nav-btn flex-1 py-3 text-center text-gray-500">
                    <i class="fas fa-chart-line text-xl"></i>
                    <span class="block text-xs">履歴</span>
                </button>
                <button data-screen="settings" class="nav-btn flex-1 py-3 text-center text-gray-500">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="block text-xs">設定</span>
                </button>
            </div>
        </nav>
    </div>

    <template id="block-template">
        <div class="block-card bg-gray-50 border rounded-lg p-4 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <div class="exercise-tabs flex items-center border-b">
                    </div>
                <button class="remove-block-btn text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="sets-container space-y-3">
                </div>
            <button class="add-set-btn w-full mt-4 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas fa-plus mr-2"></i>セット追加
            </button>
        </div>
    </template>
    
    <template id="set-template">
         <div class="set-row grid grid-cols-1 md:grid-cols-12 gap-2 items-center bg-white p-2 rounded-lg border">
            <div class="md:col-span-1 flex items-center">
                <input type="checkbox" class="warmup-check h-5 w-5 mr-2">
                <span class="font-bold text-gray-600 set-number"></span>
            </div>
            <div class="md:col-span-3">
                <input type="number" step="0.5" placeholder="重量(kg)" class="weight-input w-full p-2 border rounded-md">
            </div>
            <div class="md:col-span-2">
                <input type="number" placeholder="回数" class="reps-input w-full p-2 border rounded-md">
            </div>
            <div class="md:col-span-2">
                <input type="number" placeholder="補助" class="assisted-reps-input w-full p-2 border rounded-md">
            </div>
            <div class="md:col-span-3">
                <input type="text" placeholder="メモ" class="memo-input w-full p-2 border rounded-md">
            </div>
            <div class="md:col-span-1 flex justify-between items-center">
                 <span class="text-xs text-gray-500 w-12 text-right 1rm-display">0 kg</span>
                 <button class="remove-set-btn text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </template>

    <script>
        // アプリケーションの全ロジック
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // ===== DOM要素 =====
                screens: {
                    home: document.getElementById('home-screen'),
                    record: document.getElementById('record-screen'),
                    history: document.getElementById('history-screen'),
                    settings: document.getElementById('settings-screen'),
                },
                navButtons: document.querySelectorAll('.nav-btn'),
                
                // ===== 状態管理 =====
                db: null,
                state: {
                    currentScreen: 'home',
                    currentWorkout: {
                        part: null,
                        date: null,
                        blocks: [],
                    },
                },
                chartInstance: null,

                // ===== 初期化 =====
                init() {
                    this.loadDB();
                    this.attachEventListeners();
                    this.navigateTo('home');
                },

                // ===== DB操作 =====
                loadDB() {
                    try {
                        const data = localStorage.getItem('workoutAppDB');
                        this.db = data ? JSON.parse(data) : this.getDefaultDB();
                    } catch (e) {
                        console.error("DBの読み込みに失敗しました", e);
                        this.db = this.getDefaultDB();
                    }
                },
                
                saveDB() {
                    try {
                        localStorage.setItem('workoutAppDB', JSON.stringify(this.db));
                    } catch (e) {
                        console.error("DBの保存に失敗しました", e);
                        alert("データの保存に失敗しました。");
                    }
                },

                getDefaultDB() {
                    return {
                        settings: {
                            parts: ['胸', '背中', '肩', '腕', '脚', '腹筋'],
                            exercises: {
                                '胸': ['ベンチプレス', 'ダンベルフライ', 'インクラインプレス'],
                                '背中': ['デッドリフト', '懸垂', 'ラットプルダウン'],
                                '肩': ['ショルダープレス', 'サイドレイズ'],
                                '腕': ['バーベルカール', 'スカルクラッシャー'],
                                '脚': ['スクワット', 'レッグプレス'],
                                '腹筋': ['クランチ', 'レッグレイズ'],
                            },
                            equipment: ['バーベル', 'ダンベル', 'マシン', 'ケーブル', '自重'],
                            attachments: ['ストレートバー', 'ロープ', 'Vバー'],
                            angles: ['フラット', 'インクライン', 'デクライン'],
                        },
                        logs: [],
                    };
                },

                // ===== イベントリスナー =====
                attachEventListeners() {
                    // ナビゲーション
                    this.navButtons.forEach(btn => {
                        btn.addEventListener('click', () => this.navigateTo(btn.dataset.screen));
                    });
                    
                    // ホーム画面
                    document.getElementById('part-selection').addEventListener('click', e => {
                        if (e.target.closest('.part-btn')) {
                            const part = e.target.closest('.part-btn').dataset.part;
                            this.startWorkout(part);
                        }
                    });

                    // 記録画面
                    document.getElementById('back-to-home-btn').addEventListener('click', () => {
                        this.navigateTo('home');
                    });
                    document.getElementById('add-block-btn').addEventListener('click', () => this.addBlock());
                    document.getElementById('finish-workout-btn').addEventListener('click', () => this.finishWorkout());
                    
                    document.getElementById('blocks-container').addEventListener('click', e => {
                        if (e.target.closest('.add-set-btn')) this.addSet(e.target.closest('.block-card'));
                        if (e.target.closest('.remove-set-btn')) this.removeSet(e.target.closest('.set-row'));
                        if (e.target.closest('.remove-block-btn')) this.removeBlock(e.target.closest('.block-card'));
                    });
                    
                    document.getElementById('blocks-container').addEventListener('change', e => {
                        const target = e.target;
                        if (target.matches('.weight-input, .reps-input')) {
                            this.update1RM(target.closest('.set-row'));
                        }
                    });

                    // 履歴画面
                    document.getElementById('apply-filter-btn').addEventListener('click', () => this.renderHistoryScreen());

                    // 設定画面
                    document.getElementById('settings-accordion').addEventListener('click', e => {
                        if (e.target.closest('.toggle-accordion')) {
                            const content = e.target.closest('.toggle-accordion').nextElementSibling;
                            content.classList.toggle('hidden');
                        }
                    });
                    
                    // CSV
                    document.getElementById('export-csv-btn').addEventListener('click', () => this.exportCSV());
                    document.getElementById('import-csv-input').addEventListener('change', e => this.importCSV(e));
                },

                // ===== ナビゲーションと画面描画 =====
                navigateTo(screenId) {
                    this.state.currentScreen = screenId;
                    Object.values(this.screens).forEach(screen => screen.classList.add('hidden'));
                    
                    let activeScreen;
                    if (screenId === 'home') {
                        activeScreen = this.screens.home;
                        this.renderHomeScreen();
                    } else if(screenId === 'record') {
                        activeScreen = this.screens.record;
                        this.renderRecordScreen();
                    } else {
                        activeScreen = this.screens[screenId];
                        if (screenId === 'history') this.renderHistoryScreen();
                        if (screenId === 'settings') this.renderSettingsScreen();
                    }
                    activeScreen.classList.remove('hidden');

                    this.navButtons.forEach(btn => {
                        if (btn.dataset.screen === screenId || (screenId === 'record' && btn.dataset.screen === 'home')) {
                            btn.classList.add('text-blue-500', 'border-t-4', 'border-blue-500');
                            btn.classList.remove('text-gray-500');
                        } else {
                            btn.classList.remove('text-blue-500', 'border-t-4', 'border-blue-500');
                            btn.classList.add('text-gray-500');
                        }
                    });
                },

                // --- ホーム画面関連 ---
                renderHomeScreen() {
                    const today = new Date();
                    const sevenDaysAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
                    const thirtyDaysAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 30);

                    const uniqueDates7 = new Set(this.db.logs.filter(log => new Date(log.date) >= sevenDaysAgo).map(log => log.date.split('T')[0]));
                    const uniqueDates30 = new Set(this.db.logs.filter(log => new Date(log.date) >= thirtyDaysAgo).map(log => log.date.split('T')[0]));

                    document.getElementById('summary-7-days').textContent = `${uniqueDates7.size}日`;
                    document.getElementById('summary-30-days').textContent = `${uniqueDates30.size}日`;

                    const partContainer = document.getElementById('part-selection');
                    partContainer.innerHTML = this.db.settings.parts.map(part => `
                        <button class="part-btn bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow text-left" data-part="${part}">
                            <span class="text-xl font-bold">${part}</span>
                        </button>
                    `).join('');
                },
                
                // --- 記録画面関連 ---
                startWorkout(part) {
                    this.state.currentWorkout.part = part;
                    this.state.currentWorkout.date = new Date().toISOString();
                    this.state.currentWorkout.blocks = [];
                    this.navigateTo('record');
                },
                
                renderRecordScreen() {
                    document.getElementById('record-title').textContent = `${this.state.currentWorkout.part} の記録`;
                    document.getElementById('blocks-container').innerHTML = '';
                    if (this.state.currentWorkout.blocks.length === 0) {
                        this.addBlock();
                    }
                },
                
                addBlock() {
                    const template = document.getElementById('block-template');
                    const clone = template.content.cloneNode(true);
                    const blockCard = clone.querySelector('.block-card');
                    blockCard.dataset.id = `block_${Date.now()}`;
                    document.getElementById('blocks-container').appendChild(clone);
                    this.addExerciseTab(blockCard);
                    this.addSet(blockCard);
                },

                removeBlock(blockElement) {
                    if (confirm('この種目ブロックを削除しますか？')) {
                        blockElement.remove();
                    }
                },
                
                addExerciseTab(blockCard) {
                    // 機能簡略化のため、1ブロック1種目として実装
                    const exerciseOptions = (this.db.settings.exercises[this.state.currentWorkout.part] || []).map(ex => `<option value="${ex}">${ex}</option>`).join('');
                    const selectHTML = `<select class="exercise-select p-2 border rounded-md">${exerciseOptions}</select>`;
                    blockCard.querySelector('.exercise-tabs').innerHTML = selectHTML;
                },

                addSet(blockCard) {
                    const template = document.getElementById('set-template');
                    const clone = template.content.cloneNode(true);
                    const setsContainer = blockCard.querySelector('.sets-container');
                    const setNumber = setsContainer.children.length + 1;
                    clone.querySelector('.set-number').textContent = `Set ${setNumber}`;
                    clone.querySelector('.set-row').dataset.id = `set_${Date.now()}`;
                    setsContainer.appendChild(clone);
                },

                removeSet(setElement) {
                    const setsContainer = setElement.parentElement;
                    setElement.remove();
                    // セット番号を再採番
                    Array.from(setsContainer.children).forEach((set, index) => {
                        set.querySelector('.set-number').textContent = `Set ${index + 1}`;
                    });
                },

                update1RM(setElement) {
                    const weight = parseFloat(setElement.querySelector('.weight-input').value) || 0;
                    const reps = parseInt(setElement.querySelector('.reps-input').value) || 0;
                    let rm = 0;
                    if (weight > 0 && reps > 0) {
                        rm = weight * (1 + reps / 40); // Epley formula
                    }
                    setElement.querySelector('.1rm-display').textContent = `${rm.toFixed(1)} kg`;
                },
                
                finishWorkout() {
                    const blocksData = [];
                    const blockElements = document.querySelectorAll('.block-card');
                    
                    blockElements.forEach(blockEl => {
                        const exercise = blockEl.querySelector('.exercise-select').value;
                        if (!exercise) return;

                        const setsData = [];
                        blockEl.querySelectorAll('.set-row').forEach(setEl => {
                            const weight = parseFloat(setEl.querySelector('.weight-input').value) || 0;
                            const reps = parseInt(setEl.querySelector('.reps-input').value) || 0;
                            
                            if (weight > 0 || reps > 0) {
                                setsData.push({
                                    warmup: setEl.querySelector('.warmup-check').checked,
                                    weight: weight,
                                    reps: reps,
                                    assistedReps: parseInt(setEl.querySelector('.assisted-reps-input').value) || 0,
                                    memo: setEl.querySelector('.memo-input').value,
                                });
                            }
                        });

                        if (setsData.length > 0) {
                             blocksData.push({
                                exercise: exercise,
                                sets: setsData
                            });
                        }
                    });

                    if (blocksData.length === 0) {
                        alert("記録するデータがありません。");
                        return;
                    }

                    this.db.logs.push({
                        id: `log_${Date.now()}`,
                        date: this.state.currentWorkout.date,
                        part: this.state.currentWorkout.part,
                        blocks: blocksData,
                    });
                    
                    this.saveDB();
                    alert('トレーニングを保存しました！');
                    this.navigateTo('home');
                },

                // --- 履歴画面関連 ---
                renderHistoryScreen() {
                    const listEl = document.getElementById('history-list');
                    listEl.innerHTML = '<p class="text-gray-500">履歴を読み込んでいます...</p>';

                    // フィルターの準備
                    const filterPartEl = document.getElementById('filter-part');
                    filterPartEl.innerHTML = '<option value="">全部位</option>' + this.db.settings.parts.map(p => `<option value="${p}">${p}</option>`).join('');
                    
                    const allExercises = [...new Set(Object.values(this.db.settings.exercises).flat())];
                    const filterExerciseEl = document.getElementById('filter-exercise');
                    filterExerciseEl.innerHTML = '<option value="">全種目</option>' + allExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');

                    // フィルタリングロジック
                    const startDate = document.getElementById('filter-start-date').value;
                    const endDate = document.getElementById('filter-end-date').value;
                    const part = filterPartEl.value;
                    const exercise = filterExerciseEl.value;
                    
                    let filteredLogs = this.db.logs.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

                    if (startDate) filteredLogs = filteredLogs.filter(log => log.date.split('T')[0] >= startDate);
                    if (endDate) filteredLogs = filteredLogs.filter(log => log.date.split('T')[0] <= endDate);
                    if (part) filteredLogs = filteredLogs.filter(log => log.part === part);
                    if (exercise) {
                        filteredLogs = filteredLogs.map(log => {
                            const filteredBlocks = log.blocks.filter(block => block.exercise === exercise);
                            return filteredBlocks.length > 0 ? { ...log, blocks: filteredBlocks } : null;
                        }).filter(Boolean);
                    }

                    if(filteredLogs.length === 0) {
                        listEl.innerHTML = '<p class="text-gray-500">表示できる履歴がありません。</p>';
                        this.updateChart([], []);
                        return;
                    }

                    listEl.innerHTML = filteredLogs.map(log => {
                        const logDate = new Date(log.date);
                        const dateString = `${logDate.getFullYear()}/${logDate.getMonth()+1}/${logDate.getDate()}`;
                        return `
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-bold text-lg">${log.part}</h3>
                                    <span class="text-sm text-gray-500">${dateString}</span>
                                </div>
                                ${log.blocks.map(block => `
                                    <div class="mt-2 border-t pt-2">
                                        <h4 class="font-semibold">${block.exercise}</h4>
                                        <div class="text-sm text-gray-700 mt-1">
                                            ${block.sets.map((set, i) => `
                                                <div class="flex justify-between items-center ${set.warmup ? 'text-gray-400' : ''}">
                                                    <span>Set ${i+1}: ${set.weight}kg x ${set.reps}回 ${set.assistedReps > 0 ? `(+${set.assistedReps})` : ''}</span>
                                                    <span class="text-xs">${set.memo || ''}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }).join('');
                    
                    // グラフデータ作成
                    if (exercise) {
                        const chartLabels = [];
                        const chartData = [];
                        filteredLogs.reverse().forEach(log => {
                            log.blocks.forEach(block => {
                                if (block.exercise === exercise) {
                                    const logDate = new Date(log.date);
                                    const dateString = `${logDate.getMonth()+1}/${logDate.getDate()}`;
                                    block.sets.forEach(set => {
                                        if (!set.warmup && set.weight > 0 && set.reps > 0) {
                                            chartLabels.push(dateString);
                                            chartData.push(parseFloat((set.weight * (1 + set.reps / 40)).toFixed(1)));
                                        }
                                    });
                                }
                            });
                        });
                        this.updateChart(chartLabels, chartData);
                    } else {
                         this.updateChart([], []);
                    }
                },
                
                updateChart(labels, data) {
                    const ctx = document.getElementById('history-chart').getContext('2d');
                    if (this.chartInstance) {
                        this.chartInstance.destroy();
                    }
                    if(labels.length === 0 || data.length === 0) {
                        return;
                    }
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '1RM (kg)',
                                data: data,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: true }
                    });
                },

                // --- 設定画面関連 ---
                renderSettingsScreen() {
                    const accordion = document.getElementById('settings-accordion');
                    accordion.innerHTML = `
                        ${this.createSettingSection('部位', 'parts', this.db.settings.parts)}
                        ${this.createSettingSection('器具', 'equipment', this.db.settings.equipment)}
                        ${this.createSettingSection('アタッチメント', 'attachments', this.db.settings.attachments)}
                        ${this.createSettingSection('角度', 'angles', this.db.settings.angles)}
                    `;

                    // 種目設定は特別扱い
                    // (UIが複雑になるため、この実装では簡略化)
                },
                
                createSettingSection(title, key, items) {
                    return `
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <button class="toggle-accordion w-full text-left p-4 font-semibold text-lg flex justify-between items-center bg-gray-50 hover:bg-gray-100">
                                <span>${title}の編集</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="p-4 hidden">
                                <ul class="list-disc pl-5 mb-4 space-y-2">
                                    ${items.map(item => `<li>${item} <button class="text-red-500 ml-2" onclick="app.removeItemFromSettings('${key}', '${item}')"><i class="fas fa-times"></i></button></li>`).join('')}
                                </ul>
                                <div class="flex gap-2">
                                    <input type="text" id="new-${key}-input" class="w-full p-2 border rounded-md" placeholder="新しい${title}を追加">
                                    <button class="bg-blue-500 text-white px-4 rounded-md" onclick="app.addItemToSettings('${key}')">追加</button>
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                addItemToSettings(key) {
                    const input = document.getElementById(`new-${key}-input`);
                    const value = input.value.trim();
                    if (value && !this.db.settings[key].includes(value)) {
                        this.db.settings[key].push(value);
                        this.saveDB();
                        this.renderSettingsScreen();
                    }
                    input.value = '';
                },

                removeItemFromSettings(key, item) {
                    if (confirm(`「${item}」を削除しますか？`)) {
                        this.db.settings[key] = this.db.settings[key].filter(i => i !== item);
                        this.saveDB();
                        this.renderSettingsScreen();
                    }
                },

                // --- データ管理 ---
                exportCSV() {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "日付,部位,種目,セット,ウォームアップ,重量,レップ,補助レップ,メモ\n";

                    this.db.logs.forEach(log => {
                        log.blocks.forEach(block => {
                            block.sets.forEach((set, index) => {
                                const row = [
                                    log.date,
                                    log.part,
                                    block.exercise,
                                    index + 1,
                                    set.warmup,
                                    set.weight,
                                    set.reps,
                                    set.assistedReps,
                                    `"${set.memo || ''}"`
                                ].join(',');
                                csvContent += row + "\n";
                            });
                        });
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "workout_log.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                importCSV(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = e => {
                        // ここにCSVをパースしてDBにマージするロジックを記述
                        // 複雑なため、この実装ではアラートのみ表示
                        alert("CSVインポート機能は現在開発中です。");
                    };
                    reader.readAsText(file);
                }
            };

            // グローバルスコープにappを公開してonclick属性からアクセス可能にする
            window.app = app;
            app.init();
        });
    </script>
</body>
</html>