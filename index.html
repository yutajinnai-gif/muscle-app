<!DOCTYPE html>


<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ç­‹ãƒˆãƒ¬è¨˜éŒ²ã‚¢ãƒ—ãƒª | BUILD_TAG=FULL-20250928-SUPERSET-IPHONE-TUNE</title>
  <meta name="color-scheme" content="light">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    /* iPhoneå‘ã‘ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼šä½™ç™½ãƒ»å¹…ãƒ»ãƒ•ã‚©ãƒ³ãƒˆã®æœ€å°ç¢ºä¿ */
    input, select, textarea, button { font-size: 16px; }
    main { padding-bottom: 108px; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,.08); }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }
    .modal-card { max-width: 680px; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .min-w-0 { min-width: 0; }
    @media (max-width: 430px) {
      .wrap-pad { padding-left: 12px; padding-right: 12px; }
      .narrow-input { max-width: 240px; }
      .narrow-date { max-width: 220px; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Error bar -->
  <div id="error-bar" class="fixed top-0 left-0 right-0 z-50 hidden">
    <div class="bg-red-600 text-white px-4 py-2 text-sm flex items-start gap-3">
      <span class="font-semibold">Script error</span>
      <span id="error-text" class="flex-1"></span>
      <button id="error-close" class="underline">é–‰ã˜ã‚‹</button>
    </div>
  </div>


  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-3xl mx-auto wrap-pad px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold">ç­‹ãƒˆãƒ¬è¨˜éŒ²</h1>
      <div class="text-xs text-gray-500">PWA / Local-only</div>
    </div>
  </header>


  <main id="app" class="max-w-3xl mx-auto wrap-pad px-4 py-4 space-y-4">
    <!-- HOME -->
    <section id="view-home" class="hidden">
      <!-- æ—¥ä»˜ã¯å˜ç‹¬ãƒãƒ¼ã¨ã—ã¦æœ€ä¸Šæ®µã«é…ç½®ï¼ˆé‡ãªã‚Šé˜²æ­¢ï¼‰ -->
      <div class="rounded-2xl border bg-white p-3 shadow-soft space-y-2">
        <div>
          <label class="text-xs text-gray-500 block">æ—¥ä»˜</label>
          <input id="inp-date" type="date" class="w-full narrow-date border rounded-lg px-3 py-2">
        </div>
      </div>


  <!-- éƒ¨ä½ãƒ»çµ±è¨ˆãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="rounded-2xl border bg-white p-3 shadow-soft space-y-3">
    <div>
      <label class="text-xs text-gray-500 block mb-1">éƒ¨ä½ï¼ˆæ–°è¦ãƒ–ãƒ­ãƒƒã‚¯ã®åˆæœŸå€¤ï¼‰</label>
      <div class="grid grid-cols-3 gap-2">
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="èƒ¸">èƒ¸</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="èƒŒä¸­">èƒŒä¸­</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="è‚©">è‚©</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="è…•">è…•</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="è„š">è„š</button>
        <button class="part-btn px-3 py-2 rounded-xl bg-white border shadow-soft" data-part="è…¹ç­‹">è…¹ç­‹</button>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="rounded-xl border bg-white p-3">
        <div class="text-xs text-gray-500">ç›´è¿‘1é€±é–“ã®ãƒˆãƒ¬æ—¥æ•°</div>
        <div id="stat-week" class="text-2xl font-bold">0</div>
      </div>
      <div class="rounded-xl border bg-white p-3">
        <div class="text-xs text-gray-500">ç›´è¿‘1ãƒ¶æœˆã®ãƒˆãƒ¬æ—¥æ•°</div>
        <div id="stat-month" class="text-2xl font-bold">0</div>
      </div>
    </div>
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600">æœ¬æ—¥ã®è¨˜éŒ²</div>
      <div class="flex gap-2">
        <button id="btn-add-block" class="px-3 py-2 rounded-xl bg-gray-900 text-white">ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ </button>
        <button id="btn-save-workout" class="px-3 py-2 rounded-xl bg-white border">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="blocks" class="space-y-4"></div>
</section>

<!-- HISTORY -->
<section id="view-history" class="hidden">
  <div class="rounded-2xl border bg-white p-3 shadow-soft space-y-3">
    <div class="grid grid-cols-2 gap-2">
      <div class="min-w-0">
        <label class="text-xs text-gray-500 block">é–‹å§‹æ—¥</label>
        <input id="filter-start" type="date" class="w-full narrow-date border rounded-lg px-3 py-2">
      </div>
      <div class="min-w-0">
        <label class="text-xs text-gray-500 block">çµ‚äº†æ—¥</label>
        <input id="filter-end" type="date" class="w-full narrow-date border rounded-lg px-3 py-2">
      </div>
      <div class="min-w-0">
        <label class="text-xs text-gray-500">éƒ¨ä½</label>
        <select id="filter-part" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div class="min-w-0">
        <label class="text-xs text-gray-500">ç¨®ç›®å</label>
        <select id="filter-ex" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div class="min-w-0">
        <label class="text-xs text-gray-500">å™¨å…·</label>
        <select id="filter-eq" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div class="min-w-0">
        <label class="text-xs text-gray-500">ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ</label>
        <select id="filter-att" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
      <div class="min-w-0">
        <label class="text-xs text-gray-500">è§’åº¦</label>
        <select id="filter-ang" class="w-full border rounded-lg px-3 py-2"></select>
      </div>
    </div>
    <div class="flex gap-2">
      <button id="btn-apply-filter" class="px-3 py-2 rounded-xl bg-gray-900 text-white">çµã‚Šè¾¼ã¿</button>
      <button id="btn-clear-filter" class="px-3 py-2 rounded-xl bg-white border">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div id="history-chart-wrap" class="rounded-2xl border bg-white p-3 shadow-soft mt-3 hidden">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-gray-600">1RMæ¨ç§»</div>
      <button id="btn-back-to-home-from-simple" class="px-3 py-1.5 rounded-lg border hidden">å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹</button>
    </div>
    <canvas id="history-chart" height="160"></canvas>
  </div>

  <div id="history-list" class="mt-3 space-y-3"></div>
</section>

<!-- SETTINGS -->
<section id="view-settings" class="hidden">
  <div class="rounded-2xl border bg-white p-3 shadow-soft space-y-4">
    <div>
      <div class="text-sm font-semibold mb-1">ãƒªã‚¹ãƒˆç·¨é›†</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-gray-500">éƒ¨ä½ï¼ˆ1è¡Œ1é …ç›®ï¼‰</label>
          <textarea id="list-parts" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">å™¨å…·ï¼ˆ1è¡Œ1é …ç›®ï¼‰</label>
          <textarea id="list-equip" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆï¼ˆ1è¡Œ1é …ç›® / å…ˆé ­ã¯ã€Œãªã—ã€ã‚’æ¨å¥¨ï¼‰</label>
          <textarea id="list-attach" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-500">è§’åº¦ï¼ˆ1è¡Œ1é …ç›® / å…ˆé ­ã¯ã€Œãªã—ã€ã‚’æ¨å¥¨ï¼‰</label>
          <textarea id="list-angle" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
      </div>
    </div>

    <div class="border-t pt-3">
      <div class="text-sm font-semibold mb-1">ç¨®ç›®ãƒã‚¹ã‚¿ï¼ˆéƒ¨ä½ã²ã‚‚ä»˜ã‘ï¼‰</div>
      <div class="text-xs text-gray-500 mb-2">è¡Œè¿½åŠ â†’ç¨®ç›®åå…¥åŠ›â†’å¯¾è±¡éƒ¨ä½ã«ãƒã‚§ãƒƒã‚¯ã€‚ä¿å­˜ã§åæ˜ ã€‚è¡¨ç¤ºã¯å¸¸ã«ã€Œã‚ã„ã†ãˆãŠé †ã€ã€‚</div>
      <div class="overflow-auto">
        <table class="w-full text-sm border">
          <thead>
            <tr class="bg-gray-50">
              <th class="border px-2 py-1 text-left">å‰Šé™¤</th>
              <th class="border px-2 py-1 text-left">ç¨®ç›®å</th>
              <th class="border px-2 py-1 text-left">éƒ¨ä½</th>
            </tr>
          </thead>
          <tbody id="exercise-table-body"></tbody>
        </table>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="btn-add-ex-row" class="px-3 py-2 rounded-xl bg-white border">è¡Œã‚’è¿½åŠ </button>
        <button id="btn-save-lists" class="px-3 py-2 rounded-xl bg-gray-900 text-white">ä¿å­˜</button>
        <button id="btn-reset-defaults" class="px-3 py-2 rounded-xl bg-white border">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¾©å…ƒ</button>
      </div>
    </div>

    <div class="border-t pt-3">
      <div class="text-sm font-semibold mb-1">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
      <div class="flex flex-wrap gap-2">
        <button id="btn-export-csv" class="px-3 py-2 rounded-xl bg-white border">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="px-3 py-2 rounded-xl bg-white border cursor-pointer">
          CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input id="input-import-csv" type="file" accept=".csv,text/csv" class="hidden">
        </label>
        <button id="btn-clear-data" class="px-3 py-2 rounded-xl bg-red-50 text-red-700 border border-red-200">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">CSVåˆ—: date,part,exercise,equipment,attachment,angle,setIndex,warmup,weight,repsSelf,repsAssist,note,oneRM</p>
    </div>
  </div>
</section>

  </main>


  <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-gray-200">
    <div class="max-w-3xl mx-auto wrap-pad px-6">
      <div class="grid grid-cols-3">
        <button data-route="#/home" class="tab-btn flex flex-col items-center py-2 gap-0.5">
          <span class="text-base">ğŸ </span>
          <span class="text-xs">ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button data-route="#/history" class="tab-btn flex flex-col items-center py-2 gap-0.5">
          <span class="text-base">ğŸ—‚ï¸</span>
          <span class="text-xs">å±¥æ­´</span>
        </button>
        <button data-route="#/settings" class="tab-btn flex flex-col items-center py-2 gap-0.5">
          <span class="text-base">âš™ï¸</span>
          <span class="text-xs">è¨­å®š</span>
        </button>
      </div>
    </div>
  </nav>


  <!-- Templates -->


  <template id="tpl-block">
    <div class="block-card rounded-2xl border bg-white p-3 shadow-soft space-y-3">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 min-w-0">
          <span class="text-xs text-gray-500">ãƒ–ãƒ­ãƒƒã‚¯</span>
          <span class="block-index text-sm font-semibold">#1</span>
          <span class="text-[11px] text-gray-500 block-part"></span>
        </div>
        <div class="flex gap-2">
          <button class="btn-choose-ex px-2 py-1.5 rounded-lg border text-sm">ç¨®ç›®é¸æŠ/è¿½åŠ </button>
          <button class="btn-del-block px-2 py-1.5 rounded-lg border border-red-200 text-red-700 text-sm">ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤</button>
        </div>
      </div>


  <!-- é¸æŠæ¸ˆã¿ç¨®ç›®ï¼ˆiPhoneæœ€é©åŒ–ï¼šç¨®ç›®åã¯1è¡Œã€å™¨å…·/ã‚¢ã‚¿ãƒƒãƒ/è§’åº¦ã¯æ”¹è¡Œï¼‰ -->
  <div class="ex-config space-y-3"></div>

  <!-- Sets area -->
  <div class="set-area space-y-2">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600">ã‚»ãƒƒãƒˆ</div>
      <div class="flex gap-2">
        <button class="btn-add-set px-2 py-1.5 rounded-md bg-white border text-sm">ã‚»ãƒƒãƒˆè¿½åŠ </button>
        <button class="btn-clear-sets px-2 py-1.5 rounded-md border text-sm">å…¨ã‚»ãƒƒãƒˆå‰Šé™¤</button>
      </div>
    </div>
    <div class="set-list space-y-2"></div>
  </div>
</div>

  </template>


  <template id="tpl-ex-config-row">
    <div class="ex-config-row space-y-1">
      <div class="text-sm font-semibold ex-name">ç¨®ç›®å</div>
      <div class="grid grid-cols-3 gap-1">
        <select class="ex-eq col-span-3 sm:col-span-1 border rounded-md px-2 py-1"></select>
        <select class="ex-att col-span-3 sm:col-span-1 border rounded-md px-2 py-1"></select>
        <select class="ex-ang col-span-3 sm:col-span-1 border rounded-md px-2 py-1"></select>
      </div>
      <div class="text-[11px] text-gray-500 ex-meta">æœ€é«˜é‡é‡: - / æœ€é«˜1RM: - / å‰å›: -</div>
    </div>
  </template>


  <template id="tpl-set-card">
    <div class="set-card rounded-xl border p-2 bg-gray-50 space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Set <span class="set-no">#1</span></div>
        <div class="flex items-center gap-2">
          <label class="inline-flex items-center gap-1 text-xs"><input type="checkbox" class="set-warm border rounded"> W-Up</label>
          <button class="btn-dup-set px-2 py-1.5 rounded-md border text-xs">è¤‡è£½</button>
          <button class="btn-del-set px-2 py-1.5 rounded-md border text-xs">å‰Šé™¤</button>
        </div>
      </div>
      <div class="ex-items space-y-2"></div>
    </div>
  </template>


  <template id="tpl-ex-item-row">
    <div class="ex-item space-y-1">
      <div class="text-xs ex-title font-medium">ç¨®ç›®1</div>
      <div class="grid grid-cols-12 gap-1 items-center">
        <input type="number" inputmode="decimal" placeholder="é‡é‡" class="ex-weight col-span-6 sm:col-span-3 border rounded px-2 py-1" />
        <input type="number" inputmode="numeric" placeholder="è‡ªåŠ›" class="ex-reps col-span-3 sm:col-span-2 border rounded px-2 py-1" />
        <input type="number" inputmode="numeric" placeholder="è£œåŠ©" class="ex-assist col-span-3 sm:col-span-2 border rounded px-2 py-1" />
        <input type="text" placeholder="ãƒ¡ãƒ¢" class="ex-note col-span-12 sm:col-span-5 border rounded px-2 py-1" />
        <div class="col-span-12 text-[11px] text-gray-500">æ¨å®š1RM: <span class="ex-1rm">-</span> kg</div>
      </div>
    </div>
  </template>


  <script>
    // ===== Error Bar =====
    (()=> {
      const bar = document.getElementById('error-bar');
      const text = document.getElementById('error-text');
      const close = document.getElementById('error-close');
      function show(msg){ text.textContent = String(msg||'Unknown error'); bar.classList.remove('hidden'); }
      window.addEventListener('error', e=> show(e.message));
      window.addEventListener('unhandledrejection', e=> show((e.reason&&e.reason.message)||e.reason));
      close.addEventListener('click', ()=> bar.classList.add('hidden'));
      window.__forceError = ()=> { throw new Error('Forced error'); };
    })();

    // ===== Utils =====
    const $ = (sel, root=document)=> root.querySelector(sel);
    const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
    const debounce = (fn, ms=300)=> { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const toCSV = rows => rows.map(r=> r.map(v=>{
      const s = v==null?'':String(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;
    }).join(',')).join('\n');
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const sortJa = (arr)=> arr.slice().sort((a,b)=> String(a).localeCompare(String(b),'ja',{usage:'sort',sensitivity:'base'}));
    const sortExerciseMapJa = (map)=> map.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'','ja',{usage:'sort',sensitivity:'base'}));

    // ===== Storage with Schema =====
    const SCHEMA_VERSION = 4; // iPhone tune + ja sort + date bar & filters width
    const NS = 'workout-app';
    const store = {
      get(key, d=null){ try{ const raw = localStorage.getItem(NS+':'+key); if(!raw) return d; const obj = JSON.parse(raw); return obj&&obj.v===SCHEMA_VERSION ? obj.data : d; }catch{ return d; } },
      set(key, data){ localStorage.setItem(NS+':'+key, JSON.stringify({v:SCHEMA_VERSION, data})); },
      clearAll(){ Object.keys(localStorage).filter(k=>k.startsWith(NS+':')).forEach(k=>localStorage.removeItem(k)); }
    };

    // ===== Defaults =====
    const DEFAULTS = {
      parts: ['èƒ¸','èƒŒä¸­','è‚©','è…•','è„š','è…¹ç­‹'],
      equip: ['ãƒãƒ¼ãƒ™ãƒ«','ãƒ€ãƒ³ãƒ™ãƒ«','ãƒã‚·ãƒ³','ã‚±ãƒ¼ãƒ–ãƒ«','è‡ªé‡'],
      attach: ['ãªã—','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒãƒ¼','Vãƒãƒ¼','ãƒ­ãƒ¼ãƒ—','Dãƒãƒ³ãƒ‰ãƒ«','EZãƒãƒ¼'],
      angle: ['ãªã—','ãƒ•ãƒ©ãƒƒãƒˆ','ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³','ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³','ãƒŠãƒãƒ¥ãƒ©ãƒ«'],
      // ãƒ¡ã‚¸ãƒ£ãƒ¼ç¨®ç›®ï¼ˆå¿…è¦ã«å¿œã˜ã¦å‰Šé™¤å¯ï¼‰
      exerciseMap: [
        // èƒ¸
        { name:'ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹', parts:['èƒ¸','è‚©'] },
        { name:'ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', parts:['èƒ¸','è‚©'] },
        { name:'ã‚±ãƒ¼ãƒ–ãƒ«ã‚¯ãƒ­ã‚¹ã‚ªãƒ¼ãƒãƒ¼', parts:['èƒ¸'] },
        { name:'ãƒ€ãƒ³ãƒ™ãƒ«ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', parts:['èƒ¸'] },
        { name:'ãƒ€ãƒ³ãƒ™ãƒ«ãƒ•ãƒ©ã‚¤', parts:['èƒ¸'] },
        { name:'ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', parts:['èƒ¸'] },
        { name:'ãƒ‡ã‚£ãƒƒãƒ—ã‚¹(èƒ¸)', parts:['èƒ¸'] },
        { name:'ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—', parts:['èƒ¸'] },
        { name:'ãƒšãƒƒã‚¯ãƒ‡ãƒƒã‚¯ãƒ•ãƒ©ã‚¤', parts:['èƒ¸'] },
        { name:'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', parts:['èƒ¸'] },
        // èƒŒä¸­
        { name:'Tãƒãƒ¼ãƒ­ãƒ¼', parts:['èƒŒä¸­'] },
        { name:'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ­ãƒ¼', parts:['èƒŒä¸­'] },
        { name:'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã‚¢ãƒ¼ãƒ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³', parts:['èƒŒä¸­'] },
        { name:'ãƒãƒ³ã‚¢ãƒƒãƒ—', parts:['èƒŒä¸­','è…•'] },
        { name:'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', parts:['èƒŒä¸­','è„š'] },
        { name:'ãƒãƒ¼ãƒ™ãƒ«ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°', parts:['èƒŒä¸­'] },
        { name:'ãƒšãƒ³ãƒ‰ãƒ¬ã‚¤ãƒ­ãƒ¼', parts:['èƒŒä¸­'] },
        { name:'ãƒ—ãƒ«ã‚¢ãƒƒãƒ—', parts:['èƒŒä¸­'] },
        { name:'ãƒ•ã‚§ã‚¤ã‚¹ãƒ—ãƒ«', parts:['èƒŒä¸­','è‚©'] },
        { name:'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³(ã‚¯ãƒ­ãƒ¼ã‚º)', parts:['èƒŒä¸­'] },
        { name:'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³(ãƒ¯ã‚¤ãƒ‰)', parts:['èƒŒä¸­'] },
        { name:'ãƒ¯ãƒ³ãƒãƒ³ãƒ‰ãƒ€ãƒ³ãƒ™ãƒ«ãƒ­ãƒ¼', parts:['èƒŒä¸­'] },
        // è‚©
        { name:'ã‚¢ãƒƒãƒ—ãƒ©ã‚¤ãƒˆãƒ­ãƒ¼', parts:['è‚©'] },
        { name:'ã‚¢ãƒ¼ãƒãƒ«ãƒ‰ãƒ—ãƒ¬ã‚¹', parts:['è‚©'] },
        { name:'ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹(ãƒ€ãƒ³ãƒ™ãƒ«)', parts:['è‚©'] },
        { name:'ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹(ãƒãƒ¼ãƒ™ãƒ«)', parts:['è‚©'] },
        { name:'ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º', parts:['è‚©'] },
        { name:'ãƒ•ãƒ­ãƒ³ãƒˆãƒ¬ã‚¤ã‚º', parts:['è‚©'] },
        { name:'ãƒªã‚¢ãƒ¬ã‚¤ã‚º(ãƒªãƒãƒ¼ã‚¹ãƒšãƒƒã‚¯ãƒ‡ãƒƒã‚¯)', parts:['è‚©','èƒŒä¸­'] },
        // è…•
        { name:'ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³(ã‚±ãƒ¼ãƒ–ãƒ«)', parts:['è…•'] },
        { name:'ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³(ãƒ€ãƒ³ãƒ™ãƒ«)', parts:['è…•'] },
        { name:'ã‚¯ãƒ­ãƒ¼ã‚ºã‚°ãƒªãƒƒãƒ—ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', parts:['è…•','èƒ¸'] },
        { name:'ã‚±ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ«', parts:['è…•'] },
        { name:'ã‚¹ã‚«ãƒ«ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼(ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³)', parts:['è…•'] },
        { name:'ãƒãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ«', parts:['è…•'] },
        { name:'ãƒã‚¤ã‚»ãƒ—ã‚¹ã‚«ãƒ¼ãƒ«(ãƒ€ãƒ³ãƒ™ãƒ«)', parts:['è…•'] },
        { name:'ãƒã‚¤ã‚»ãƒ—ã‚¹ã‚«ãƒ¼ãƒ«(ãƒãƒ¼ãƒ™ãƒ«)', parts:['è…•'] },
        { name:'ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ãƒ—ãƒ¬ã‚¹ãƒ€ã‚¦ãƒ³', parts:['è…•'] },
        { name:'ãƒ‡ã‚£ãƒƒãƒ—ã‚¹(ä¸Šè…•ä¸‰é ­ç­‹)', parts:['è…•'] },
        { name:'ãƒ—ãƒªãƒ¼ãƒãƒ£ãƒ¼ã‚«ãƒ¼ãƒ«', parts:['è…•'] },
        // è„š
        { name:'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º(ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰)', parts:['è„š'] },
        { name:'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º(ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°)', parts:['è„š'] },
        { name:'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ(ãƒ•ãƒ­ãƒ³ãƒˆ)', parts:['è„š'] },
        { name:'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ(ãƒãƒƒã‚¯)', parts:['è„š'] },
        { name:'ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', parts:['è„š'] },
        { name:'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', parts:['è„š'] },
        { name:'ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ', parts:['è„š'] },
        { name:'ãƒ©ãƒ³ã‚¸', parts:['è„š'] },
        { name:'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', parts:['è„š','èƒŒä¸­'] },
        { name:'ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³', parts:['è„š'] },
        { name:'ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«(ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰)', parts:['è„š'] },
        { name:'ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«(ãƒ©ã‚¤ã‚¤ãƒ³ã‚°)', parts:['è„š'] },
        { name:'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹', parts:['è„š'] },
        // è…¹ç­‹
        { name:'ã‚¢ãƒ–ãƒ­ãƒ¼ãƒ©ãƒ¼', parts:['è…¹ç­‹'] },
        { name:'ã‚¯ãƒ©ãƒ³ãƒ', parts:['è…¹ç­‹'] },
        { name:'ã‚±ãƒ¼ãƒ–ãƒ«ã‚¯ãƒ©ãƒ³ãƒ', parts:['è…¹ç­‹'] },
        { name:'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º', parts:['è…¹ç­‹'] },
        { name:'ãƒ—ãƒ©ãƒ³ã‚¯', parts:['è…¹ç­‹'] },
        { name:'ãƒªãƒãƒ¼ã‚¹ã‚¯ãƒ©ãƒ³ãƒ', parts:['è…¹ç­‹'] },
        { name:'ãƒ­ã‚·ã‚¢ãƒ³ãƒ„ã‚¤ã‚¹ãƒˆ', parts:['è…¹ç­‹'] }
      ]
    };

    // ===== App State =====
    const state = {
      lists: null,           // {parts, equip, attach, angle, exerciseMap}
      workouts: null,        // [{id,date,blocks:[{part,exs:[{name,eq,att,ang}],sets:[{warm,items:[{w,reps,assist,note,oneRM}]}]}]}]
      inProgress: null,      // {date, part (default for new blocks), blocks:[...]}
      chart: null
    };

    // ===== Init =====
    function initData(){
      let lists = store.get('lists');
      if(!lists){ lists = JSON.parse(JSON.stringify(DEFAULTS)); }
      // ensure defaults + sort bases
      if(lists.attach[0] !== 'ãªã—'){ lists.attach = ['ãªã—', ...lists.attach.filter(x=>x!=='ãªã—')]; }
      if(lists.angle[0] !== 'ãªã—'){ lists.angle = ['ãªã—', ...lists.angle.filter(x=>x!=='ãªã—')]; }
      // å¸¸ã«è¡¨ç¤ºã¯ã‚ã„ã†ãˆãŠé †ã§ä¸¦ã¹ã‚‹ï¼ˆä¿å­˜é †ã¯ä¿æŒï¼‰
      lists.parts = sortJa(lists.parts);
      lists.equip = sortJa(lists.equip);
      lists.attach = sortJa(lists.attach);
      lists.angle = sortJa(lists.angle);
      lists.exerciseMap = sortExerciseMapJa(lists.exerciseMap);
      state.lists = lists;
      store.set('lists', lists);

      let workouts = store.get('workouts', []);
      state.workouts = workouts;

      let inProgress = store.get('inProgress', { date: todayISO(), part: 'èƒ¸', blocks: [] });
      if(!inProgress.date) inProgress.date = todayISO();
      if(!inProgress.blocks) inProgress.blocks = [];
      state.inProgress = inProgress;
    }
    function persist(){ store.set('lists', state.lists); store.set('workouts', state.workouts); store.set('inProgress', state.inProgress); }

    // ===== Router =====
    function setActiveTab(hash){
      $$('.tab-btn').forEach(btn=>{
        const active = btn.getAttribute('data-route') === hash;
        btn.classList.toggle('font-bold', active);
      });
    }
    function renderRoute(){
      const hash = location.hash || '#/home';
      $('#view-home').classList.add('hidden');
      $('#view-history').classList.add('hidden');
      $('#view-settings').classList.add('hidden');
      if(hash.startsWith('#/home')) { $('#view-home').classList.remove('hidden'); renderHome(); }
      else if(hash.startsWith('#/history')) { $('#view-history').classList.remove('hidden'); renderHistory(); }
      else { $('#view-settings').classList.remove('hidden'); renderSettings(); }
      setActiveTab(hash);
    }
    window.addEventListener('hashchange', renderRoute);

    // ===== 1RM =====
    function calc1RM(weight, reps){
      const w = Number(weight||0), r = Number(reps||0);
      if(w<=0 || r<=0) return 0;
      return Math.round(w * (1 + r/30) * 10) / 10;
    }

    // ===== Stats =====
    function computeTrainingDays(rangeDays){
      const cutoff = Date.now() - rangeDays*24*3600*1000;
      const days = new Set(state.workouts.filter(w => new Date(w.date||todayISO()).getTime() >= cutoff).map(w => w.date||todayISO()));
      return days.size;
    }

    // ===== Home =====
    function renderHome(){
      // date input
      const dateEl = $('#inp-date');
      dateEl.value = state.inProgress.date || todayISO();
      dateEl.onchange = (e)=> { state.inProgress.date = e.target.value || todayISO(); persist(); };

      $('#stat-week').textContent = computeTrainingDays(7);
      $('#stat-month').textContent = computeTrainingDays(30);

      $$('.part-btn').forEach(b=>{
        const active = state.inProgress.part === b.dataset.part;
        b.classList.toggle('bg-gray-900', active);
        b.classList.toggle('text-white', active);
        b.classList.toggle('bg-white', !active);
        b.classList.toggle('text-gray-900', !active);
        b.onclick = ()=>{ state.inProgress.part = b.dataset.part; persist(); renderHome(); };
      });

      const wrap = $('#blocks');
      wrap.innerHTML = '';
      state.inProgress.blocks.forEach((block, idx)=>{
        wrap.appendChild(renderBlock(block, idx));
      });

      // actions
      $('#btn-add-block').onclick = addBlock;
      $('#btn-save-workout').onclick = saveWorkout;
    }

    function renderBlock(block, idx){
      const frag = document.importNode($('#tpl-block').content, true);
      const card = frag.querySelector('.block-card');
      card.dataset.index = idx;
      frag.querySelector('.block-index').textContent = '#'+(idx+1);
      frag.querySelector('.block-part').textContent = `ï¼ˆ${block.part}ï¼‰`;

      // open chooser
      frag.querySelector('.btn-choose-ex').onclick = ()=> openExerciseChooser(idx);

      // delete block
      frag.querySelector('.btn-del-block').onclick = async ()=>{
        if(await confirmAction('ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
          state.inProgress.blocks.splice(idx,1);
          persist(); renderHome();
        }
      };

      // ex config rows
      const cfgWrap = frag.querySelector('.ex-config');
      block.exs.forEach((ex)=>{
        cfgWrap.appendChild(renderExConfigRow(block, ex));
      });

      // sets area
      const setWrap = frag.querySelector('.set-list');
      frag.querySelector('.btn-add-set').onclick = ()=> addSet(block, true); // copy last set
      frag.querySelector('.btn-clear-sets').onclick = async ()=>{
        if(await confirmAction('ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®å…¨ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
          block.sets = [];
          persist(); renderHome();
        }
      };
      (block.sets||[]).forEach((set, sIdx)=>{
        setWrap.appendChild(renderSetCard(block, set, sIdx));
      });

      return frag;
    }

    function addBlock(){
      // æ–°è¦ãƒ–ãƒ­ãƒƒã‚¯ã¯â€œç¾åœ¨é¸æŠä¸­ã®éƒ¨ä½â€ã‚’å›ºå®šä¿æŒ
      state.inProgress.blocks.push({ part: state.inProgress.part, exs: [], sets: [] });
      persist(); renderHome();
      setTimeout(()=> window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 0);
      const idx = state.inProgress.blocks.length - 1;
      setTimeout(()=> openExerciseChooser(idx), 50);
    }

    function openExerciseChooser(blockIdx){
      const part = state.inProgress.blocks[blockIdx].part || state.inProgress.part;
      // éƒ¨ä½ç´ä»˜ã‘ã•ã‚ŒãŸç¨®ç›®ã‚’ã‚ã„ã†ãˆãŠé †ã§
      const allowed = sortJa(
        state.lists.exerciseMap.filter(e=> Array.isArray(e.parts) && e.parts.includes(part)).map(e=> e.name)
      );
      const current = new Set((state.inProgress.blocks[blockIdx].exs||[]).map(e=> e.name));

      const bg = document.createElement('div'); bg.className='modal-bg flex items-center justify-center z-50';
      const card = document.createElement('div'); card.className='modal-card bg-white rounded-2xl p-4 shadow-soft border w-[92vw]';
      card.innerHTML = `<div class="text-sm font-semibold mb-2">ç¨®ç›®é¸æŠï¼ˆ${escapeHtml(part)}ï¼‰</div>`;
      const list = document.createElement('div'); list.className='max-h-[60vh] overflow-auto space-y-1';

      if(allowed.length===0){
        list.innerHTML = '<div class="text-sm text-gray-500">ã“ã®éƒ¨ä½ã«ç´ã¥ãç¨®ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šï¼ç¨®ç›®ãƒã‚¹ã‚¿ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
      } else {
        allowed.forEach(name=>{
          const id = 'ex_'+Math.random().toString(36).slice(2);
          const row = document.createElement('label'); row.className='flex items-center gap-2 text-sm';
          row.innerHTML = `<input type="checkbox" id="${id}" ${current.has(name)?'checked':''}> <span>${escapeHtml(name)}</span>`;
          row.querySelector('input').dataset.name = name;
          list.appendChild(row);
        });
      }

      const actions = document.createElement('div'); actions.className='flex justify-end gap-2 mt-3';
      const btnCancel = document.createElement('button'); btnCancel.className='px-3 py-2 rounded-xl bg-white border'; btnCancel.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      const btnOk = document.createElement('button'); btnOk.className='px-3 py-2 rounded-xl bg-gray-900 text-white'; btnOk.textContent='OK';
      actions.appendChild(btnCancel); actions.appendChild(btnOk);

      card.appendChild(list); card.appendChild(actions); bg.appendChild(card); document.body.appendChild(bg);

      btnCancel.onclick = ()=> bg.remove();
      btnOk.onclick = ()=>{
        const checked = Array.from(list.querySelectorAll('input[type=checkbox]:checked')).map(i=> i.dataset.name);
        applySelectedExercises(blockIdx, checked);
        bg.remove();
      };
      bg.addEventListener('click', e=> { if(e.target===bg) bg.remove(); });
    }

    function applySelectedExercises(blockIdx, names){
      const block = state.inProgress.blocks[blockIdx];
      const before = block.exs || [];
      // exsè‡ªä½“ã®è¡¨ç¤ºé †ã¯é¸æŠé †ã‚’ç¶­æŒï¼ˆç®¡ç†ä¸Šã¯ãã‚Œã§OKï¼‰
      block.exs = names.map(name=>{
        const found = before.find(e=> e.name===name);
        return found || { name, eq: state.lists.equip[0]||'', att: 'ãªã—', ang: 'ãªã—' };
      });

      // align existing sets to new exercises
      (block.sets||[]).forEach(set=>{
        const items = set.items||[];
        const next = names.map((name)=>{
          const prevIdx = before.findIndex(e=> e.name===name);
          if(prevIdx>=0 && items[prevIdx]) return items[prevIdx];
          return { w:0, reps:0, assist:0, note:'', oneRM:0 };
        });
        set.items = next;
      });

      // ã‚»ãƒƒãƒˆæœªä½œæˆãªã‚‰1ã‚»ãƒƒãƒˆè‡ªå‹•ç”Ÿæˆ
      if (!block.sets || block.sets.length === 0) {
        const items = names.map(()=> ({ w:0, reps:0, assist:0, note:'', oneRM:0 }));
        block.sets = [{ warm:false, items }];
      }

      persist(); renderHome();
    }

    function renderExConfigRow(block, ex){
      const node = document.importNode($('#tpl-ex-config-row').content, true);
      node.querySelector('.ex-name').textContent = ex.name;
      fillSelect(node.querySelector('.ex-eq'), state.lists.equip, ex.eq || state.lists.equip[0] || '', v=>{ ex.eq=v; persist(); });
      fillSelect(node.querySelector('.ex-att'), state.lists.attach, ex.att || 'ãªã—', v=>{ ex.att=v; persist(); });
      fillSelect(node.querySelector('.ex-ang'), state.lists.angle, ex.ang || 'ãªã—', v=>{ ex.ang=v; persist(); });
      updateExMetaLine(node, ex);
      return node;
    }

    function updateExMetaLine(rowNode, ex){
      const meta = rowNode.querySelector('.ex-meta');
      const all = flattenSets().filter(r=> r.exercise===ex.name);
      if(all.length===0){ meta.textContent='æœ€é«˜é‡é‡: - / æœ€é«˜1RM: - / å‰å›: -'; return; }
      const maxW = Math.max(...all.map(r=> Number(r.weight||0)));
      const max1 = Math.max(...all.map(r=> Number(r.oneRM||0)));
      const last = all.sort((a,b)=> a.date<b.date ? 1 : -1)[0];
      meta.textContent = `æœ€é«˜é‡é‡: ${maxW||'-'} / æœ€é«˜1RM: ${max1||'-'} / å‰å›: ${last ? last.date : '-'}`;
    }

    function renderSetCard(block, set, sIdx){
      const node = document.importNode($('#tpl-set-card').content, true);
      node.querySelector('.set-no').textContent = '#'+(sIdx+1);
      const warm = node.querySelector('.set-warm');
      warm.checked = !!set.warm;
      warm.addEventListener('input', ()=> { set.warm = warm.checked; persist(); });

      const itemsWrap = node.querySelector('.ex-items');
      ensureSetItems(block, set);
      block.exs.forEach((ex, i)=>{
        itemsWrap.appendChild(renderExItemRow(block, set, i, ex));
      });

      node.querySelector('.btn-dup-set').onclick = ()=> {
        const source = block.sets[sIdx];
        const cloned = JSON.parse(JSON.stringify(source));
        block.sets.splice(sIdx+1, 0, cloned);
        persist(); renderHome();
      };
      node.querySelector('.btn-del-set').onclick = ()=> {
        block.sets.splice(sIdx,1);
        persist(); renderHome();
      };
      return node;
    }

    function ensureSetItems(block, set){
      if(!set.items) set.items = [];
      if(set.items.length < block.exs.length){
        const last = set.items[set.items.length-1] || { w:0, reps:0, assist:0, note:'', oneRM:0 };
        for(let i=set.items.length; i<block.exs.length; i++){
          set.items[i] = { ...last };
        }
      } else if(set.items.length > block.exs.length){
        set.items = set.items.slice(0, block.exs.length);
      }
    }

    function addSet(block, copyLast){
      if(!block.sets) block.sets = [];
      if(copyLast && block.sets.length){
        const last = block.sets[block.sets.length-1];
        const cloned = JSON.parse(JSON.stringify(last));
        block.sets.push(cloned);
      } else {
        const items = (block.exs||[]).map(()=> ({ w:0, reps:0, assist:0, note:'', oneRM:0 }));
        block.sets.push({ warm:false, items });
      }
      persist(); renderHome();
      setTimeout(()=> window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' }), 0);
    }

    function renderExItemRow(block, set, idx, ex){
      const node = document.importNode($('#tpl-ex-item-row').content, true);
      const item = set.items[idx];
      node.querySelector('.ex-title').textContent = ex.name;
      const elW = node.querySelector('.ex-weight');
      const elR = node.querySelector('.ex-reps');
      const elA = node.querySelector('.ex-assist');
      const elN = node.querySelector('.ex-note');
      const elOne = node.querySelector('.ex-1rm');

      elW.value = item.w || '';
      elR.value = item.reps || '';
      elA.value = item.assist || '';
      elN.value = item.note || '';
      elOne.textContent = item.oneRM || '-';

      const recalc = debounce(()=>{
        const one = calc1RM(elW.value, elR.value);
        item.w = Number(elW.value||0);
        item.reps = Number(elR.value||0);
        item.assist = Number(elA.value||0);
        item.note = elN.value || '';
        item.oneRM = one||0;
        elOne.textContent = item.oneRM || '-';
        persist();
      }, 200);

      [elW, elR, elA, elN].forEach(el=> el.addEventListener('input', recalc));
      return node;
    }

    function fillSelect(sel, items, value, onChange){
      // è¡¨ç¤ºã¯å¸¸ã«ã‚ã„ã†ãˆãŠé †
      const ordered = sortJa(items);
      sel.innerHTML = '';
      ordered.forEach(v=>{
        const opt = document.createElement('option'); opt.value=v; opt.textContent=v; sel.appendChild(opt);
      });
      sel.value = value || ordered[0] || '';
      sel.onchange = e=> onChange(e.target.value);
    }

    // ===== Save Workout =====
    function saveWorkout(){
      const copy = JSON.parse(JSON.stringify(state.inProgress));
      // prune empties
      copy.blocks.forEach(b=>{
        b.sets = (b.sets||[]).map(s=>{
          s.items = (s.items||[]).filter(it=> (Number(it.w)>0 && Number(it.reps)>0) || it.note);
          return s;
        }).filter(s=> s.items.length>0);
      });
      copy.blocks = copy.blocks.filter(b=> (b.exs||[]).length>0 && (b.sets||[]).length>0);
      if(copy.blocks.length===0){ alert('è¨˜éŒ²ãŒç©ºã§ã™ã€‚ã‚»ãƒƒãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      copy.id = 'w_'+Date.now();
      state.workouts.push(copy);
      state.inProgress = { date: state.inProgress.date || todayISO(), part: state.inProgress.part, blocks: [] };
      persist(); alert('ä¿å­˜ã—ã¾ã—ãŸ'); renderHome();
    }

    // ===== Flatten (history / CSV) =====
    function flattenSets(){
      const rows = [];
      state.workouts.forEach(w=>{
        (w.blocks||[]).forEach(b=>{
          (b.sets||[]).forEach((s, sIdx)=>{
            (b.exs||[]).forEach((ex, exIdx)=>{
              const it = (s.items||[])[exIdx] || {};
              rows.push({
                id: w.id,
                date: w.date || state.inProgress.date || todayISO(),
                part: b.part || 'ä¸æ˜',
                exercise: ex.name,
                equipment: ex.eq||'',
                attachment: ex.att||'ãªã—',
                angle: ex.ang||'ãªã—',
                setIndex: sIdx+1,
                warmup: !!s.warm,
                weight: Number(it.w||0),
                repsSelf: Number(it.reps||0),
                repsAssist: Number(it.assist||0),
                note: it.note||'',
                oneRM: Number(it.oneRM||0)
              });
            });
          });
        });
      });
      return rows.sort((a,b)=> a.date<b.date ? -1 : 1);
    }

    // ===== History =====
    function renderHistory(){
      const parts = ['(æŒ‡å®šãªã—)', ...sortJa(state.lists.parts)];
      const exs = ['(æŒ‡å®šãªã—)', ...sortJa(unique(flattenSets().map(r=>r.exercise)))];
      const eqs = ['(æŒ‡å®šãªã—)', ...sortJa(state.lists.equip)];
      const atts = ['(æŒ‡å®šãªã—)', ...sortJa(state.lists.attach)];
      const angs = ['(æŒ‡å®šãªã—)', ...sortJa(state.lists.angle)];
      fillSelect($('#filter-part'), parts, '(æŒ‡å®šãªã—)', ()=>{});
      fillSelect($('#filter-ex'), exs, '(æŒ‡å®šãªã—)', ()=>{});
      fillSelect($('#filter-eq'), eqs, '(æŒ‡å®šãªã—)', ()=>{});
      fillSelect($('#filter-att'), atts, '(æŒ‡å®šãªã—)', ()=>{});
      fillSelect($('#filter-ang'), angs, '(æŒ‡å®šãªã—)', ()=>{});

      $('#btn-apply-filter').onclick = ()=> applyFilter();
      $('#btn-clear-filter').onclick = ()=> { $('#filter-start').value=''; $('#filter-end').value=''; ['part','ex','eq','att','ang'].forEach(id=> $('#filter-'+id).value='(æŒ‡å®šãªã—)'); applyFilter(); };

      const params = new URLSearchParams(location.hash.split('?')[1] || '');
      const exParam = params.get('exercise');
      if(exParam){ $('#filter-ex').value = exParam; }
      applyFilter();
    }
    function unique(arr){ return Array.from(new Set(arr)); }

    function applyFilter(){
      const start = $('#filter-start').value;
      const end = $('#filter-end').value;
      const part = $('#filter-part').value;
      const ex = $('#filter-ex').value;
      const eq = $('#filter-eq').value;
      const att = $('#filter-att').value;
      const ang = $('#filter-ang').value;

      let rows = flattenSets();
      if(start) rows = rows.filter(r => r.date >= start);
      if(end) rows = rows.filter(r => r.date <= end);
      if(part && part!=='(æŒ‡å®šãªã—)') rows = rows.filter(r => r.part===part);
      if(ex && ex!=='(æŒ‡å®šãªã—)') rows = rows.filter(r => r.exercise===ex);
      if(eq && eq!=='(æŒ‡å®šãªã—)') rows = rows.filter(r => r.equipment===eq);
      if(att && att!=='(æŒ‡å®šãªã—)') rows = rows.filter(r => r.attachment===att);
      if(ang && ang!=='(æŒ‡å®šãªã—)') rows = rows.filter(r => r.angle===ang);

      renderHistoryList(rows);
      if(ex && ex!=='(æŒ‡å®šãªã—)'){
        const dailyMax = aggregateDailyMax1RM(rows);
        renderChart(dailyMax.labels, dailyMax.values, true);
      } else {
        renderChart([], [], false);
      }
    }

    function aggregateDailyMax1RM(rows){
      const map = new Map();
      rows.forEach(r=>{
        const key = r.date;
        const prev = map.get(key) || 0;
        map.set(key, Math.max(prev, r.oneRM||0));
      });
      const labels = Array.from(map.keys()).sort();
      const values = labels.map(d => map.get(d));
      return { labels, values };
    }

    function renderHistoryList(rows){
      const list = $('#history-list');
      list.innerHTML = '';
      if(rows.length===0){ list.innerHTML = '<div class="text-sm text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }

      const byWorkout = rows.reduce((acc, r)=> { (acc[r.id] ||= []).push(r); return acc; }, {});
      Object.values(byWorkout).forEach(items=>{
        const w = items[0];
        const card = document.createElement('div');
        card.className = 'rounded-2xl border bg-white p-3 shadow-soft';
        const partsInWorkout = Array.from(new Set(items.map(i=>i.part))).join(' / ');
        const title = document.createElement('div');
        title.className = 'flex items-center justify-between';
        title.innerHTML = `<div class="text-sm font-semibold">${w.date} / ${partsInWorkout}</div>`;
        card.appendChild(title);
        items.forEach(r=>{
          const row = document.createElement('div');
          row.className = 'mt-2 text-sm grid grid-cols-12 gap-1';
          row.innerHTML = `
            <div class="col-span-5 truncate-2">${r.exercise} <span class="text-xs text-gray-500">(${r.equipment} / ${r.attachment} / ${r.angle})</span></div>
            <div class="col-span-3">é‡é‡ ${r.weight}kg</div>
            <div class="col-span-2">è‡ª ${r.repsSelf}</div>
            <div class="col-span-2">è£œ ${r.repsAssist}</div>
            <div class="col-span-12 text-[11px] text-gray-500">éƒ¨ä½:${r.part} / 1RM:${r.oneRM || '-'}kg / S${r.setIndex} ${r.note ? ' / '+escapeHtml(r.note) : ''}</div>
          `;
          card.appendChild(row);
        });
        list.appendChild(card);
      });

      const params = new URLSearchParams(location.hash.split('?')[1] || '');
      const exParam = params.get('exercise');
      const backBtn = $('#btn-back-to-home-from-simple');
      backBtn.classList.toggle('hidden', !exParam);
      backBtn.onclick = ()=> { location.hash = '#/home'; };
    }

    function renderChart(labels, values, show){
      const wrap = $('#history-chart-wrap');
      wrap.classList.toggle('hidden', !show);
      if(!show){ if(state.chart){ state.chart.destroy(); state.chart=null; } return; }
      const ctx = $('#history-chart').getContext('2d');
      if(state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: '1RM (kg)', data: values, tension: 0.25, pointRadius: 3 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    }

    // ===== Settings (checkbox matrix) =====
    function renderSettings(){
      $('#list-parts').value = sortJa(state.lists.parts).join('\n');
      $('#list-equip').value = sortJa(state.lists.equip).join('\n');
      $('#list-attach').value = sortJa(state.lists.attach).join('\n');
      $('#list-angle').value = sortJa(state.lists.angle).join('\n');

      const tbody = $('#exercise-table-body');
      tbody.innerHTML = '';
      const parts = sortJa(state.lists.parts);

      // è¡¨ç¤ºã¯å¸¸ã«ç¨®ç›®åã‚ã„ã†ãˆãŠé †
      sortExerciseMapJa(state.lists.exerciseMap).forEach((row)=> {
        tbody.appendChild(renderExerciseRow(row, parts));
      });

      $('#btn-add-ex-row').onclick = ()=>{
        const newRow = { name:'', parts:[] };
        state.lists.exerciseMap.push(newRow);
        tbody.appendChild(renderExerciseRow(newRow, parts));
      };

      // actions are bound globally
    }

    function renderExerciseRow(row, parts){
      const tr = document.createElement('tr');
      tr.className = 'border-b';

      const tdDel = document.createElement('td');
      tdDel.className = 'border px-2 py-1';
      const btnDel = document.createElement('button');
      btnDel.className = 'px-2 py-1 rounded border text-xs';
      btnDel.textContent = 'Ã—';
      btnDel.onclick = ()=>{
        const i = state.lists.exerciseMap.indexOf(row);
        if(i>=0) { state.lists.exerciseMap.splice(i,1); tr.remove(); }
      };
      tdDel.appendChild(btnDel);

      const tdName = document.createElement('td');
      tdName.className = 'border px-2 py-1';
      const ipt = document.createElement('input');
      ipt.type = 'text';
      ipt.className = 'w-full border rounded px-2 py-1';
      ipt.value = row.name || '';
      ipt.oninput = ()=> { row.name = ipt.value.trim(); };
      tdName.appendChild(ipt);

      const tdParts = document.createElement('td');
      tdParts.className = 'border px-2 py-1';
      const wrap = document.createElement('div');
      wrap.className = 'flex flex-wrap gap-3';
      parts.forEach(p=>{
        const label = document.createElement('label');
        label.className = 'inline-flex items-center gap-1';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = Array.isArray(row.parts) ? row.parts.includes(p) : false;
        cb.onchange = ()=>{
          if(!Array.isArray(row.parts)) row.parts = [];
          if(cb.checked){
            if(!row.parts.includes(p)) row.parts.push(p);
          } else {
            row.parts = row.parts.filter(x=> x!==p);
          }
        };
        label.appendChild(cb);
        label.appendChild(document.createTextNode(p));
        wrap.appendChild(label);
      });
      tdParts.appendChild(wrap);

      tr.appendChild(tdDel);
      tr.appendChild(tdName);
      tr.appendChild(tdParts);
      return tr;
    }

    function saveLists(){
      const parseLines = v => v.split('\n').map(s=>s.trim()).filter(Boolean);
      state.lists.parts = sortJa(parseLines($('#list-parts').value));
      state.lists.equip = sortJa(parseLines($('#list-equip').value));
      state.lists.attach = sortJa(parseLines($('#list-attach').value));
      if(state.lists.attach[0] !== 'ãªã—'){ state.lists.attach = ['ãªã—', ...state.lists.attach.filter(x=>x!=='ãªã—')]; }
      state.lists.angle = sortJa(parseLines($('#list-angle').value));
      if(state.lists.angle[0] !== 'ãªã—'){ state.lists.angle = ['ãªã—', ...state.lists.angle.filter(x=>x!=='ãªã—')]; }

      // ç¨®ç›®ãƒãƒƒãƒ—ï¼šç©ºè¡Œã¯æƒé™¤ã€‚å†…éƒ¨é †ã¯ä¿å­˜æ™‚ã«ã‚‚jaã‚½ãƒ¼ãƒˆã—ã¦ãŠã
      state.lists.exerciseMap = sortExerciseMapJa(
        state.lists.exerciseMap.filter(r=> (r.name && r.name.trim().length>0))
      );

      persist();
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
      if(location.hash.startsWith('#/home')) renderHome();
    }

    function resetDefaults(){
      state.lists = JSON.parse(JSON.stringify(DEFAULTS));
      if(state.lists.attach[0] !== 'ãªã—'){ state.lists.attach = ['ãªã—', ...state.lists.attach.filter(x=>x!=='ãªã—')]; }
      if(state.lists.angle[0] !== 'ãªã—'){ state.lists.angle = ['ãªã—', ...state.lists.angle.filter(x=>x!=='ãªã—')]; }
      // åˆæœŸè¡¨ç¤ºã‚‚ä¸¦ã³æ›¿ãˆ
      state.lists.parts = sortJa(state.lists.parts);
      state.lists.equip = sortJa(state.lists.equip);
      state.lists.attach = sortJa(state.lists.attach);
      state.lists.angle = sortJa(state.lists.angle);
      state.lists.exerciseMap = sortExerciseMapJa(state.lists.exerciseMap);
      persist(); renderSettings(); alert('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å¾©å…ƒã—ã¾ã—ãŸ');
    }

    // ===== CSV Export/Import =====
    function exportCSV(){
      const rows = flattenSets().map(r=>[
        r.date, r.part, r.exercise, r.equipment, r.attachment, r.angle, r.setIndex,
        r.warmup ? 1 : 0, r.weight, r.repsSelf, r.repsAssist, r.note, r.oneRM
      ]);
      rows.unshift(['date','part','exercise','equipment','attachment','angle','setIndex','warmup','weight','repsSelf','repsAssist','note','oneRM']);
      const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `workouts_${todayISO()}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    function importCSV(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        const text = reader.result;
        const rows = parseCSV(text);
        const header = rows.shift() || [];
        const idx = name => header.indexOf(name);
        const dateI=idx('date'), partI=idx('part'), exI=idx('exercise'), eqI=idx('equipment'), attI=idx('attachment'), angI=idx('angle'),
              sI=idx('setIndex'), warmI=idx('warmup'), wI=idx('weight'), rsI=idx('repsSelf'), raI=idx('repsAssist'), noteI=idx('note'), oneI=idx('oneRM');
        if(dateI<0 || partI<0 || exI<0){ alert('CSVãƒ˜ãƒƒãƒ€ãŒä¸æ­£ã§ã™'); return; }

        const groups = {};
        rows.forEach(r=>{
          const date = r[dateI]; if(!date) return;
          const part = r[partI] || 'ä¸æ˜';
          const key = date+'|'+part;
          (groups[key] ||= []).push({
            exercise: r[exI]||'',
            equipment: r[eqI]||'',
            attachment: r[attI]||'ãªã—',
            angle: r[angI]||'ãªã—',
            setIndex: Number(r[sI]||1),
            warmup: Number(r[warmI]||0)>0,
            weight: Number(r[wI]||0),
            repsSelf: Number(r[rsI]||0),
            repsAssist: Number(r[raI]||0),
            note: r[noteI]||'',
            oneRM: Number(r[oneI]||0)
          });
        });

        Object.entries(groups).forEach(([key, items])=>{
          const [date, part] = key.split('|');
          const exNames = Array.from(new Set(items.map(it=> it.exercise)));
          const maxSet = Math.max(0, ...items.map(it=> it.setIndex||0));
          const exs = exNames.map(name=>{
            const any = items.find(it=> it.exercise===name) || {};
            return { name, eq:any.equipment||'', att:any.attachment||'ãªã—', ang:any.angle||'ãªã—' };
          });
          const sets = [];
          for(let s=1; s<=Math.max(1, maxSet); s++){
            const set = { warm:false, items: exNames.map(()=> ({ w:0,reps:0,assist:0,note:'',oneRM:0 })) };
            exNames.forEach((name, i)=>{
              const it = items.find(it=> it.exercise===name && it.setIndex===s);
              if(it){
                set.warm = set.warm || !!it.warmup;
                set.items[i] = { w:it.weight, reps:it.repsSelf, assist:it.repsAssist, note:it.note, oneRM: it.oneRM||calc1RM(it.weight,it.repsSelf) };
              }
            });
            sets.push(set);
          }
          state.workouts.push({ id:'w_'+Date.now()+Math.random(), date, blocks:[{ part, exs, sets }] });
        });

        persist(); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); if(location.hash.startsWith('#/history')) renderHistory();
      };
      reader.readAsText(file);
    }

    function parseCSV(text){
      const rows = []; let i=0, field='', row=[], inQ=false;
      while(i<text.length){
        const c=text[i++];
        if(inQ){ if(c=== '"'){ if(text[i]==='"'){ field+='"'; i++; } else { inQ=false; } } else { field+=c; } }
        else { if(c===','){ row.push(field); field=''; } else if(c==='"'){ inQ=true; } else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; } else if(c!=='\r'){ field+=c; } }
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      return rows;
    }

    // ===== Modals =====
    async function confirmAction(message){
      const bg = document.createElement('div'); bg.className='modal-bg flex items-center justify-center z-50';
      const card = document.createElement('div'); card.className='modal-card bg-white rounded-2xl p-4 shadow-soft border';
      card.innerHTML = `
        <div class="text-sm text-gray-700 mb-3">${escapeHtml(message)}</div>
        <div class="flex justify-end gap-2">
          <button class="px-3 py-2 rounded-xl bg-white border">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="px-3 py-2 rounded-xl bg-gray-900 text-white">OK</button>
        </div>`;
      bg.appendChild(card); document.body.appendChild(bg);
      return new Promise(resolve=>{
        const [btnCancel, btnOk] = card.querySelectorAll('button');
        const cleanup = ()=> bg.remove();
        btnCancel.onclick = ()=> { cleanup(); resolve(false); };
        btnOk.onclick = ()=> { cleanup(); resolve(true); };
        bg.addEventListener('click', e=> { if(e.target===bg){ cleanup(); resolve(false); } });
      });
    }

    // ===== Bindings =====
    function bindGlobalUI(){
      $$('.tab-btn').forEach(btn=> btn.onclick = ()=> { location.hash = btn.getAttribute('data-route'); });

      // settings
      $('#btn-save-lists').onclick = saveLists;
      $('#btn-reset-defaults').onclick = resetDefaults;
      $('#btn-export-csv').onclick = exportCSV;
      $('#input-import-csv').addEventListener('change', e=> {
        const f = e.target.files && e.target.files[0]; if(f) importCSV(f); e.target.value='';
      });
      $('#btn-clear-data').onclick = async ()=>{
        if(await confirmAction('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')){
          store.clearAll(); initData(); persist(); renderRoute();
        }
      };
    }

    // ===== Boot =====
    initData();
    bindGlobalUI();
    if(!location.hash) location.hash = '#/home';
    renderRoute();
  </script>


</body>
</html>
